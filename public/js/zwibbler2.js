/**
   Zwibbler

   Copyright 2013 Hanov Solutions Inc. All Rights Reserved. This software is
   NOT open source. For licensing information, contact the author.

   steve.hanov@gmail.com

   @license
 */
(function(){
"use strict";var m;function aa(a,b,c,d,e){this.Qa=a||"transparent";this.left=b||0;this.top=c||0;this.right=d||0;this.bottom=e||0;this.$=1;this.insertBefore=null}aa.prototype.Ka=function(){this.ha.remove()};
aa.prototype.show=function(a){this.ha=p("<div>");this.ha.da("position","fixed");this.ha.da("background",this.Qa);this.ha.da("opacity","0.25");this.ha.da("left",""+this.left+"px");this.ha.da("top",""+this.top+"px");this.ha.da("right",""+this.right+"px");this.ha.da("bottom",""+this.bottom+"px");this.ha.da("display","none");this.ha.click(function(b){a(b)});this.insertBefore?(this.ha.da("z-index",""+this.$),ba(p(this.ha),this.insertBefore)):(this.ha.da("z-index",""+this.$),p("body").append(this.ha));
ca(this.ha)};var da={},ga={};function ha(a){for(var b=["base64"],c=0;c<b.length;c++)a=da[b[c]](a);return a}
da.base64=function(a){for(var b="",c,d,e,f,g,h,l=0;l<a.length;)c=a.charCodeAt(l++),d=a.charCodeAt(l++),e=a.charCodeAt(l++),f=c>>2,c=(c&3)<<4|d>>4,g=(d&15)<<2|e>>6,h=e&63,isNaN(d)?g=h=64:isNaN(e)&&(h=64),b=b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(c)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(h);
return b};
ga.base64=function(a){var b="",c,d,e,f,g,h=0,l={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,a:26,b:27,c:28,d:29,e:30,f:31,g:32,h:33,i:34,j:35,k:36,l:37,m:38,n:39,o:40,p:41,q:42,r:43,s:44,t:45,u:46,v:47,w:48,x:49,y:50,z:51,0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,"+":62,"/":63,"=":64};for(a=a.replace(/[^A-Za-z0-9\-_\=\+\/]/g,"");h<a.length;)c=l[a.charAt(h++)],d=l[a.charAt(h++)],f=l[a.charAt(h++)],g=l[a.charAt(h++)],c=
c<<2|d>>4,d=(d&15)<<4|f>>2,e=(f&3)<<6|g,b+=String.fromCharCode(c),64!==f&&(b+=String.fromCharCode(d)),64!==g&&(b+=String.fromCharCode(e));return b};
da.ascii85=function(a){for(var b="",c,d,e,f,g,h,l,k,n=0;n<a.length;)c=a.charCodeAt(n++),d=a.charCodeAt(n++),e=a.charCodeAt(n++),f=a.charCodeAt(n++),g=(c<<24|d<<16|e<<8|f)>>>0,c=(g/52200625|0)%85+33,h=(g/614125|0)%85+33,l=(g/7225|0)%85+33,k=(g/85|0)%85+33,g=g%85+33,(118<c||118<h||118<l||118<k||118<g)&&console.log(c,h,l,k,g),(33>c||33>h||33>l||33>k||33>g)&&console.log(c,h,l,k,g),b+=String.fromCharCode(c)+String.fromCharCode(h),isNaN(d)||(b+=String.fromCharCode(l),isNaN(e)||(b+=String.fromCharCode(k),
isNaN(f)||(b+=String.fromCharCode(g))));return b+"~>"};da.utf8=function(a){for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b};
ga.utf8=function(a){for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);127>=d?b+=String.fromCharCode(d):2047>=a?(b+=String.fromCharCode(192|a>>6),b+=String.fromCharCode(128|a&63)):65535>=a?(b+=String.fromCharCode(224|a>>12),b+=String.fromCharCode(128|a>>6&63),b+=String.fromCharCode(128|a&63)):1114111>=a?(b+=String.fromCharCode(240|a>>18),b+=String.fromCharCode(128|a>>12&63),b+=String.fromCharCode(128|a>>6&63),b+=String.fromCharCode(128|a&63)):b+=String.fromCharCode(63)}return b};
ga.utf8=function(a){for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b};da.hex=function(a){for(var b=[],c=0;c<a.length;c++){var d=a.charCodeAt(c);16>d&&b.push("0");b.push(d.toString(16))}return b.join("")};
da.sha1=function(a){var b=[1518500249,1859775393,2400959708,3395469782];a+=String.fromCharCode(128);for(var c=Math.ceil((a.length/4+2)/16),d=Array(c),e=0;e<c;e++){d[e]=Array(16);for(var f=0;16>f;f++)d[e][f]=a.charCodeAt(64*e+4*f)<<24|a.charCodeAt(64*e+4*f+1)<<16|a.charCodeAt(64*e+4*f+2)<<8|a.charCodeAt(64*e+4*f+3)}d[c-1][14]=8*(a.length-1)/Math.pow(2,32);d[c-1][14]=Math.floor(d[c-1][14]);d[c-1][15]=8*(a.length-1)&4294967295;a=1732584193;for(var f=4023233417,g=2562383102,h=271733878,l=3285377520,k=
Array(80),n,q,r,t,v,e=0;e<c;e++){for(var w=0;16>w;w++)k[w]=d[e][w];for(w=16;80>w;w++)n=k[w-3]^k[w-8]^k[w-14]^k[w-16],k[w]=n<<1|n>>>31;n=a;q=f;r=g;t=h;v=l;for(w=0;80>w;w++){var z=Math.floor(w/20),pa;a:{switch(z){case 0:pa=q&r^~q&t;break a;case 1:pa=q^r^t;break a;case 2:pa=q&r^q&t^r&t;break a;case 3:pa=q^r^t;break a}pa=void 0}z=(n<<5|n>>>27)+pa+v+b[z]+k[w]&4294967295;v=t;t=r;r=q<<30|q>>>2;q=n;n=z}a=a+n&4294967295;f=f+q&4294967295;g=g+r&4294967295;h=h+t&4294967295;l=l+v&4294967295}return String.fromCharCode(a>>
24&255)+String.fromCharCode(a>>16&255)+String.fromCharCode(a>>8&255)+String.fromCharCode(a>>0&255)+String.fromCharCode(f>>24&255)+String.fromCharCode(f>>16&255)+String.fromCharCode(f>>8&255)+String.fromCharCode(f>>0&255)+String.fromCharCode(g>>24&255)+String.fromCharCode(g>>16&255)+String.fromCharCode(g>>8&255)+String.fromCharCode(g>>0&255)+String.fromCharCode(h>>24&255)+String.fromCharCode(h>>16&255)+String.fromCharCode(h>>8&255)+String.fromCharCode(h>>0&255)+String.fromCharCode(l>>24&255)+String.fromCharCode(l>>
16&255)+String.fromCharCode(l>>8&255)+String.fromCharCode(l>>0&255)};function u(a,b){if(!a)throw b||"Assertion failed";}function ia(a){u("number"===typeof a,"Expected a number")}function ja(a){return"object"===typeof a&&"[object Array]"===Object.prototype.toString.apply(a)}function ka(a){return"string"===typeof a}function x(a){return"number"===typeof a};function y(a){this.keys={};1===arguments.length&&this.add(arguments[0]);1===arguments.length&&"object"===typeof arguments[0]&&this.add(arguments[0])}
y.prototype={contains:function(a){return a in this.keys},add:function(a){var b,c;if("string"===typeof a||"number"===typeof a)this.keys[a]=!0;else if("object"===typeof a)if("[object Array]"===Object.prototype.toString.apply(a))for(c=0;c<a.length;c++)b=a[c],this.keys[b]=!0;else for(b in a)a.hasOwnProperty(b)&&(this.keys[b]=!0);else return u(!1,"Arg must be an array")},remove:function(a){delete this.keys[a]},Gb:function(){var a,b;b=[];for(a in this.keys)this.keys.hasOwnProperty(a)&&b.push(a);return b}};
function la(a){var b,c;c=[];for(b in a.keys)a.keys.hasOwnProperty(b)&&c.push(parseFloat(b));return c}function ma(a,b){var c,d;u(b instanceof y);d=new y;for(c in a.keys)b.contains(c)||d.add(c);return d};var na;try{na=Function("return this")()}catch(a){na=window}var oa={},qa=[];
function A(a,b){function c(b){var c=arguments,f=[],g=c[0];if(!oa[a]){var h=g.split("%s");f.push(h[0]);for(g=1;g<h.length;g++)g-1>=c.length-1?f.push("<too few args>"):"string"===typeof c[g]||"number"===typeof c[g]?f.push(c[g]):void 0===c[g]?f.push("(undefined)"):null===c[g]?f.push("(null)"):c[g]instanceof Object&&c[g].toString instanceof Function?f.push(c[g].toString()):f.push(JSON.stringify(c[g])),f.push(h[g]);c=f.join("");for(g=0;g<qa.length;g++)qa[g](a,c)}}!1===b&&(oa[a]=!0);c.$=function(){return 0<
qa.length&&!oa[a]};return c}function ra(a){qa.push(a)}"console"in na||(na.console={log:function(){for(var a=[],b=0;b<arguments.length;b++)try{"string"===typeof arguments[b]?a.push(arguments[b]):a.push(JSON.stringify(arguments[b]))}catch(c){a.push(c.toString())}for(b=0;b<qa.length;b++)qa[b]("Console",a.join(""))}},na.console.error=na.console.log);function sa(){this.length=0}var ta=A("JQUERY"),ua,va=/\s+/,wa=/^[\s\xA0]+/,xa=/[\s\xA0]+$/,za,Aa={B:1,BIG:1,I:1,SMALL:1,TT:1,ABBR:1,ACRONYM:1,CITE:1,CODE:1,DFN:1,EM:1,KBD:1,STRONG:1,SAMP:1,VAR:1,A:1,BDO:1,BR:1,IMG:1,MAP:1,OBJECT:1,Q:1,SCRIPT:1,SPAN:1,SUB:1,SUP:1,BUTTON:1,INPUT:1,LABEL:1,SELECT:1,TEXTAREA:1},Ba=[],Ca=!1;function Da(){!Ca&&window.attachEvent&&(window.attachEvent("onresize",function(a){for(var b=0;b<Ba.length;b++)Ba[b](a)}),Ca=!0)}
function Ea(a,b){var c=/#(.*)$/,d=/\.(.*)$/,e=/^<\s*([a-zA-Z0-9]+).*>$/,f=/^([A-Za-z]+)$/;b=b||document;var g=new sa,h,l,k;try{k=("object"===typeof HTMLElement?a instanceof HTMLElement:"object"===typeof a&&1===a.nodeType&&"string"===typeof a.nodeName||3===a.nodeType)||a===window||a===document||a===document.body||a instanceof Element}catch(r){k=!1}if(k)return g[g.length++]=a,g;if(a instanceof sa)return a;k=a.split(",");for(var n=0;n<k.length;n++)if(l=k[n],null!==(h=c.exec(l)))h=document.getElementById(h[1]),
null!==h&&(g[g.length++]=h);else if(null!==(h=e.exec(l)))h=h[1],g[g.length++]=document.createElement(h);else if(null!==(h=d.exec(l))){l=g;h=za(b,h[1],null);for(var q=0;q<h.length;q++)l[l.length++]=h[q]}else if(null!==(h=f.exec(l)))for(l=g,h=b.getElementsByTagName(h[1]),q=0;q<h.length;q++)l[l.length++]=h[q];else throw console.log(l),"Error: can't parse selector: "+l+" ("+l.nodeType;return g}
sa.prototype={children:function(){for(var a=new sa,b=0;b<this.length;b++)for(var c=this[b].firstChild;c;)a[a.length++]=c,c=c.nextSibling;return a},Ka:function(){for(var a=0;a<this.length;a++){var b=p(this[a]).da("display");"none"!==b&&(this[a].Vd=b);this[a].style.display="none"}return this},show:function(){for(var a=0;a<this.length;a++)this[a].Vd?this[a].style.display=this[a].Vd:"none"===p(this[a]).da("display")&&(this[a].style.display=this[a].tagName in Aa?"inline":"block");return this},append:function(a){a=
Ea(a);if(0<this.length)for(var b=0;b<a.length;b++)this[0].appendChild(a[b]);return this},remove:function(){for(var a=0;a<this.length;a++)this[a].parentNode&&this[a].parentNode.removeChild(this[a]);return this},empty:function(){for(var a=0;a<this.length;a++)for(;null!==this[a].firstChild;)this[a].removeChild(this[a].firstChild);return this},text:function(a){if(0===arguments.length){var b="";Fa(this,function(a){3===a.nodeType&&(b+=a.nodeValue)});return b}for(var c=0;c<this.length;c++){for(;null!==this[c].firstChild;)this[c].removeChild(this[c].firstChild);
this[c].appendChild(document.createTextNode(a))}return this},width:function(){if(0<this.length){if(1===arguments.length){for(var a=Math.max(0,arguments[0]),b=0;b<this.length;b++)this[b].style.width=""+a+"px";return this}return this[0]===window?this[0].innerWidth||document.documentElement.clientWidth:this[0].clientWidth}return 0},height:function(){if(0<this.length){if(1===arguments.length){for(var a=0;a<this.length;a++)this[a].style.height=""+arguments[0]+"px";return this}return this[0]===window?this[0].innerHeight||
document.documentElement.clientHeight:this[0].clientHeight}return 0},outerWidth:function(){return 0<this.length?this[0].offsetWidth:0},outerHeight:function(){return 0<this.length?this[0].offsetHeight:0},offset:function(a){if(a){if(0<this.length){var b=p(this[0].parentNode).offset();this[0].style.left=a.left-b.left+"px";this[0].style.top=a.top-b.top+"px"}}else{if(0<this.length){a=this[0].getBoundingClientRect();var c=b=0;"pageYOffset"in window?(b=window.pageXOffset,c=window.pageYOffset):(b=document.body.scrollLeft,
c=document.body.scrollTop);return{top:a.top+c,left:a.left+b}}return{left:0,top:0}}},clone:function(){return this.length?Ea(this[0].cloneNode(!0)):new sa},find:function(a){return this.length?Ea(a,this[0]):new sa},Va:function(a,b){if(2===arguments.length){for(var c=0;c<this.length;c++)this[c].setAttribute(a,b);return this}return 0<this.length?this[0].getAttribute(a):""},lb:function(a){for(var b=0;b<this.length;b++)a(b,this[b])},focus:function(){0<this.length&&this[0].focus();return this},blur:function(){0<
this.length&&this[0].blur();return this},submit:function(){for(var a=0;a<this.length;a++)this[a].submit();return this},select:function(){for(var a=0;a<this.length;a++)this[a].select();return this},da:function(a,b){var c=a.split("-");a=c[0];for(var d=1;d<c.length;d++)a="ms"!==c[d]?a+(c[d].substr(0,1).toUpperCase()+c[d].substr(1)):a+c[d];if(2===arguments.length){for(d=0;d<this.length;d++)this[d].style[a]=""+b;return this}return this[0].currentStyle?this[0].currentStyle[a]:window.getComputedStyle?window.getComputedStyle(this[0],
null)[a]:this[0].style[a]},on:function(a,b){function c(a){d[0]===window&&"resize"===a&&window.attachEvent?(Ba.push(b),Da()):window.addEventListener?d.lb(function(c,d){b.Me=function(a){a.$a=a;"which"in a||(a.which=a.button);return b.call(d,a)};d.addEventListener(a,b.Me,!1)}):d.lb(function(c,d){d.attachEvent("on"+a,function(a){a.$a=a;a.which=a.button;a.pageX=a.clientX;a.pageY=a.clientY;a.preventDefault=function(){a.returnValue=!1};a.stopPropagation=function(){a.cancelBubble=!0};a.target=a.target||a.srcElement;
return b.call(d,a)})})}var d=this;a=a.split(" ");for(var e=0;e<a.length;e++)c(a[e]);return this},bind:function(a,b){return this.on(a,b)},click:function(a){return a?this.on("click",a):Ga(this,"click")},scrollLeft:function(a){if(1===arguments.length){for(var b=0;b<this.length;b++)this[b].scrollLeft=a;return this}return this[0].scrollLeft},scrollTop:function(a){if(1===arguments.length){for(var b=0;b<this.length;b++)this[b].scrollTop=a;return this}return this[0].scrollTop}};
function ca(a){for(var b=0;b<a.length;b++)a[b].style.display="block"}function Ha(a){var b=p(window);if(a)b.on("resize",a);else Ga(b,"resize")}function Ia(a,b){a.on("change",b)}function Ja(a,b){a.on("mouseout",b)}function Ka(a,b){a.on("mouseover",b)}function La(a,b){a.on("dblclick",b)}function Ma(a,b){a.on("mousemove",b)}function Na(a,b){a.on("mouseup",b)}function Oa(a,b){a.on("mousedown",b)}function Pa(a,b){a.on("keydown",b)}
function Qa(){var a=p("<input>").Va("type","button");a[0].value="OK";return a}function Ra(a,b){if(b&&"string"===typeof b)for(var c=(b||"").split(va),d=0,e=a.length;d<e;d++){var f=a[d];if(1===f.nodeType)if(f.className){for(var g=" "+f.className+" ",h=f.className,l=0,k=c.length;l<k;l++)0>g.indexOf(" "+c[l]+" ")&&(h+=" "+c[l]);f.className=ua.ba(h)}else f.className=b}return a}function Sa(a,b){for(var c=0;c<a.length;c++)a[c].innerHTML=b}
function Ga(a,b){a.lb(function(a,d){var e;ta("Trigger "+b);if(document.createEventObject)if(e=document.createEventObject(),"resize"===b){ta("Calling stored window resize functions");for(var f=0;f<Ba.length;f++)Ba[f](e)}else d.fireEvent("on"+b,e);else e=document.createEvent("HTMLEvents"),e.initEvent(b,!0,!0),d.dispatchEvent(e)})}function ba(a,b){b=Ea(b);0<a.length&&0<b.length&&b[0].parentNode.insertBefore(a[0],b[0])}
function Ta(a,b){b=Ea(b);0<a.length&&0<b.length&&a[0].parentNode.insertBefore(b[0],a[0])}function Fa(a,b){for(var c=[],d=a.length-1;0<=d;d--)c.push(a[d]);for(;c.length;)for(d=c.pop(),b(d),d=d.lastChild;d;)c.push(d),d=d.previousSibling}ua=function(a){return Ea(a)};ua.ba=function(a){return null===a?"":a.toString().replace(wa,"").replace(xa,"")};
ua.aa=function(a){var b=a.url||"",c=a.type||"GET",d=a.Pf||function(){},e=a.error||function(){},f=a.data||"";a=a.Re||function(){};var g="",h;try{h=new XMLHttpRequest}catch(k){try{h=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{h=new ActiveXObject("Microsoft.XMLHTTP")}catch(q){e(null,"",null)}}}if("object"===typeof f)for(var l in f)Object.hasOwnProperty.call(f,l)&&(g.length&&(g+="&"),g+=encodeURIComponent(l),g+="=",g+=encodeURIComponent(f[l]));"GET"===c&&(b+="?"+g,g="");a(h,h);h.open(c,b,!0);h.onreadystatechange=
function(){if(4===h.readyState)if(200===h.status){var a=h.responseText,b=h.getResponseHeader("content-type");if(b&&0===b.indexOf("application/json"))try{a=ua.ia(a)}catch(c){}d(a,"",h)}else e(h,"",null)};"POST"===c&&h.setRequestHeader("Content-Type","application/x-www-form-urlencoded");h.send(g)};
za=function(a,b,c){var d=[],e=b.split(/\s+/);for(b=0;b<e.length;b++){var f=e[b].replace(/([\/\\\^$*+?.()|\[\]{}])/g,"\\$1");d.push(new RegExp("(^|\\s)"+f+"(\\s|$)"))}e=a.getElementsByTagName(c||"*");f=[];b=0;for(c=e.length;b<c;b++){var g=e[b],h=!0;for(a=0;a<d.length;a++)if(!d[a].test(g.className)){h=!1;break}h&&f.push(g)}return f};ua.ia=function(a){return window.JSON.parse(a)};
ua.$=function(a){for(var b=arguments[0],c=1;c<arguments.length;c++){var d=arguments[c],e;for(e in d)d.hasOwnProperty(e)&&(b[e]=d[e])}return b};ua.bc=sa.prototype;var p=ua;A("Cookies");function Ua(a){this.$=a}Ua.prototype={Ya:function(a){this.$.Ya(a)},flush:function(){this.$.flush()},Zc:function(){return this.$.Zc()}};function Va(){this.data=""}Va.prototype={log:A("BYTESTREAM"),Zc:function(){return this},Ya:function(a){if(255<a||0>a)throw"Bad data written to byte buffer";this.data+=String.fromCharCode(a)},flush:function(){},toString:function(){return this.data},Gb:function(){for(var a=[],b=0;b<this.data.length;b++)a.push(this.data.charCodeAt(b));return a}};var Wa={};
function Xa(){var a,b=new Va;a=["LZWEncoder","Ascii85Encoder"];a.reverse();for(var c=0;c<a.length;c++)b=new Wa[a[c]](b);return b};function Ya(a){this.$=a;this.aa=[]}Ya.prototype={Ya:function(a){4===this.aa.length&&Za(this);this.aa.push(a)},flush:function(){0<this.aa.length&&Za(this);for(var a=this.$,b=0;2>b;b++)a.Ya("~>".charCodeAt(b));this.$.flush()}};
function Za(a){var b,c,d,e,f,g,h,l;b=a.aa[0];c=a.aa[1];d=a.aa[2];e=a.aa[3];f=(b<<24|c<<16|d<<8|e)>>>0;b=(f/52200625|0)%85+33;g=(f/614125|0)%85+33;h=(f/7225|0)%85+33;l=(f/85|0)%85+33;f=f%85+33;(118<b||118<g||118<h||118<l||118<f)&&console.log(b,g,h,l,f);(33>b||33>g||33>h||33>l||33>f)&&console.log(b,g,h,l,f);a.$.Ya(b);a.$.Ya(g);isNaN(c)||(a.$.Ya(h),isNaN(d)||(a.$.Ya(l),isNaN(e)||a.$.Ya(f)));a.aa.length=0}Ya.prototype=p.$({},Ua.prototype,Ya.prototype);Wa.Ascii85Encoder=Ya;function $a(a){this.$=a;this.aa=this.ba=0;this.ia=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8193]}$a.prototype={log:A("BITWRITER"),Ya:function(a){ab(this,a,8)},flush:function(){this.aa&&(this.$.Ya(this.ba<<8-this.aa),this.ba=this.aa=0);this.$.flush()}};function ab(a,b,c){a.ba=a.ba<<c|b&a.ia[c];for(a.aa+=c;8<=a.aa;)a.$.Ya(a.ba>>>a.aa-8&255),a.aa-=8,a.ba&=a.ia[a.aa]}Wa.BitWriter=$a;$a.prototype=p.$({},Ua.prototype,$a.prototype);function bb(a){this.$=new $a(a);this.ia=258;this.aa=0;this.oa=!0;this.la=[];this.Ea=[];this.ta=[];this.ba=9;cb(this)}
bb.prototype={log:A("LZWEncoder"),Ya:function(a){var b;if(this.oa)this.aa=a,this.oa=!1;else{a:{b=this.aa;var c,d;c=a<<4^b;for(d=0===c?1:18041-c;;){if(void 0===this.la[c]||this.Ea[c]===b&&this.ta[c]===a){b=c;break a}c-=d;0>c&&(c+=18041)}}void 0!==this.la[b]?this.aa=this.la[b]:(ab(this.$,this.aa,this.ba),this.la[b]=this.ia,this.Ea[b]=this.aa,this.aa=this.ta[b]=a,4095>this.ia?(this.ia+=1,this.ba=Math.ceil(Math.log(this.ia)/Math.log(2))):cb(this))}},flush:function(){this.oa||(ab(this.$,this.aa,this.ba),
ab(this.$,257,this.ba))}};function cb(a){ab(a.$,256,a.ba);a.ia=258;a.ba=9;a.la.length=0;a.Ea.length=0;a.ta.length=0}Wa.LZWEncoder=bb;bb.prototype=p.$({},Ua.prototype,bb.prototype);(function(a){this.algorithm=a.algorithm||"wrap";this.$=a.gravity||"down";this.aa=!1!==a.resize;"down"===this.$?(this.offsetWidth="offsetWidth",this.offsetHeight="offsetHeight",this.width="width",this.height="height",this.top="top",this.left="left",this.clientWidth="clientWidth",this.clientHeight="clientHeight"):"up"===this.$?(this.offsetWidth="offsetWidth",this.offsetHeight="offsetHeight",this.width="width",this.height="height",this.top="bottom",this.left="left",this.clientWidth="clientWidth",this.clientHeight=
"clientHeight"):(this.offsetWidth="offsetHeight",this.offsetHeight="offsetWidth",this.width="height",this.height="width",this.top="left",this.left="top",this.clientWidth="clientHeight",this.clientHeight="clientWidth")}).prototype={log:A("Layout")};function db(a){this.$="en";"string"===typeof a&&(a=eb(this,a,{}));this.data=a}db.prototype={log:A("LANGUAGE"),bc:function(){var a=this;return function(b,c){return fb(a,arguments)}},get:function(a,b){return fb(this,arguments)}};function fb(a,b){var c=b[0],d="<not translated:"+c+">";a.$ in a.data&&c in a.data[a.$]&&(d=a.data[a.$][c]);for(c=1;c<b.length;c++)d=d.replace("^"+c,b[c]);return d}
function eb(a,b,c){b=b.split("\n");for(var d=/^([ \t]*)([^:]+):([^:]+):(.*)/,e=0;e<b.length;e++){var f=d.exec(b[e]);if(f){var g=f[2],h=f[3],f=f[4];g in c||(c[g]={});h in c[g]&&a.log("Warning: Replacing %s:%s",g,h);c[g][h]=f}}return c}function gb(a,b){b=b.split(",");a.log("Choice of languages: %s",b);for(var c=0;c<b.length;c++){var d=b[c].split("-")[0];if(d in a.data){a.log("Using language code %s",d);a.$=d;break}else a.log("No language for code %s",d)}};function hb(a,b,c,d,e){this.view=a;this.node=b;this.$=c;this.aa=b.Pd(c);this.Ia(d,e)}
hb.prototype={log:A("MoveEditNode"),Bb:function(){this.log("Entering MoveEditNode")},Fb:function(){this.log("Leaving MoveEditNode")},Ua:function(a){"touchmove"===a.type?(a=a.touches[0],a=C(this.view,a.pageX,a.pageY),this.La(a.x,a.y)):"touchend"===a.type&&(a=a.changedTouches[0],a=C(this.view,a.pageX,a.pageY),this.Ma(a.x,a.y))},Ia:function(a,b){this.log("onMouseDown(%s,%s)",a,b);this.ba=a;this.ia=b},La:function(a,b){var c=this.view.Sa(new E(a,b));a=c.x;b=c.y;this.node.zc(this.$,a,b);this.node.format(this.view.na,
this.view.request);this.view.ma()},Ma:function(a,b){this.log("onMouseUp(%s,%s)",a,b);var c=this.view.Sa(new E(a,b));a=c.x;b=c.y;a===this.ba&&b===this.ia||this.view.ya([new ib(this.node.id,this.$,this.aa.x,this.aa.y,a,b)]);this.view.ma();F(this.view,new jb(this.view))}};function kb(a,b){this.view=a;this.state="none";this.Pa=document.createElement("img");this.url=this.Pa.src=b}
kb.prototype={log:A("ImageStamp"),Bb:function(){this.log("Entering ImageStampBehaviour");this.view.canvas.style.cursor="move"},Fb:function(){this.log("Leaving ImageStampBehaviour");this.view.ma()},Ua:function(a){var b;"touchstart"===a.type?(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),this.Ia(b.x,b.y,a)):"touchmove"===a.type?(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),this.La(b.x,b.y,a)):"touchend"===a.type&&(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),this.Ma(b.x,b.y,a))},
Sa:function(a,b){this.Pa.complete&&(a-=this.Pa.width/2,b-=this.Pa.height/2);return this.view.Sa(new E(a,b))},Ia:function(a,b,c){this.log("onMouseDown type %s",c.type);a=this.Sa(a,b);this.view.ya([new G("ImageNode",{url:this.url,layer:this.view.Ha,matrix:new H(a.x,a.y)})]);this.view.ea.get("autoPickTool")&&I(this.view)},La:function(a,b){this.Pa.complete||this.log("Don't draw; image not loaded.");var c=this.Sa(a,b),d=this;this.view.ma(function(a){var b=a.globalAlpha;a.globalAlpha=.5;a.drawImage(d.Pa,
c.x,c.y);a.globalAlpha=b})},Ma:function(){},ob:function(a){"cancel"===a&&(I(this.view),this.view.mb.emit("goto-toolbar"))}};function lb(a){this.view=a;this.state="none"}
lb.prototype={log:A("PanTool"),Bb:function(){this.log("Entering PanToolBehaviour");this.view.canvas.style.cursor="all-scroll"},Fb:function(){this.log("Leaving PanToolBehaviour")},Ua:function(a){var b;"touchstart"===a.type?(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),this.Ia(b.x,b.y,a)):"touchmove"===a.type?(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),this.La(b.x,b.y,a)):"touchend"===a.type&&(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),this.Ma(b.x,b.y,a))},Ia:function(a,
b,c){this.log("onMouseDown type %s",c.type);this.state="dragging";this.start=mb(c);this.$=this.view.Ga;this.aa=this.view.Fa},La:function(a,b,c){"dragging"===this.state&&(a=mb(c),b=this.aa+a.y-this.start.y,this.view.Ga=this.$+a.x-this.start.x,this.view.Fa=b,J(this.view),this.view.ma())},Ma:function(){this.state="none"},Ad:function(a,b,c){if(!this.view.ea.get("allowZoom"))return this.log("Zooming is disabled."),!1;this.log("onMouseWheel(%s, %s, %s)",a,b,c);0<c?this.view.Uc():this.view.Vc()},ob:function(a){"cancel"===
a&&I(this.view)}};function mb(a){return"changedTouches"in a?new E(a.changedTouches[0].pageX,a.changedTouches[0].pageY):new E(a.pageX,a.pageY)};function nb(){this.$=[];this.next=0;this.$b=!1}
nb.prototype={log:A("UNDOSTACK"),ya:function(a,b,c){"object"===typeof a&&"[object Array]"===Object.prototype.toString.apply(a)||(a=[a]);this.next<this.$.length&&(this.$.length=this.next);if(!b){for(var d=[],e=2;e<arguments.length;e++)d.push(arguments[e]);for(e=0;e<a.length;e++)a[e].nb.apply(a[e],d)}for(d=this.top();d;)if(d[d.length-1].Ud(a[0])){if(a.shift(),0===a.length)break}else break;a.length&&this.$.push(a);this.$b=!0;this.next=this.$.length},Ta:function(a){this.log("Undo index %s of %s",this.next,
this.$.length);if(this.Yb()){for(var b=this.$[--this.next],c=b.length-1;0<=c;c--)b[c].Ta.apply(b[c],arguments);this.$b=!0}},Ob:function(a){this.log("Redo index %s of %s",this.next,this.$.length);if(this.Xb()){for(var b=this.$[this.next++],c=0;c<b.length;c++)b[c].nb.apply(b[c],arguments);this.$b=!0}},Yb:function(){return 0<this.next},Xb:function(){return this.next<this.$.length},top:function(){return this.$.length?this.$[this.$.length-1]:0}};function ob(){}
ob.prototype={nb:function(){},Ta:function(){},Ud:function(){return!1}};function pb(a,b){this.ka=b;this.Of=!0}pb.prototype={log:A("MoveSegment"),ma:function(a){a.moveTo(this.ka.x,this.ka.y)},sc:function(){return null},Sb:function(){return{x:1,y:0}}};function qb(a,b,c,d,e){this.ka=b;this.xa=a;this.sf=!0;this.ba=e;this.ta=d;c.next();this.la=c.next();this.oa=c.next();this.moveTo=this.gc=null;this.format()}
qb.prototype={log:A("LineSegment"),format:function(){var a=rb(this.xa.ka.x,this.xa.ka.y,this.ka.x,this.ka.y);this.ia=this.length=a;var b=this.xa.ka.clone();if(this.xa.sf&&this.ba){this.ba=Math.min(this.ba,a/2,this.xa.length/2);a=K(this.xa.ka.x,this.xa.ka.y,this.ka.x,this.ka.y);b.x+=a.x*this.ba;b.y+=a.y*this.ba;var a=this.xa,c=this.ba,d=K(a.aa.x,a.aa.y,a.ka.x,a.ka.y),e=a.ka.clone();e.x-=d.x*c;e.y-=d.y*c;a.gc=e;a.ia-=c;c=a.ia/10*a.ta;10<c&&(c=10);var d=a.aa.x,f=a.aa.y,g=e.x,h=e.y,d=d+c,f=f+c;a.$=new E(d+
a.la*(g+c-d),f+a.la*(h+c-f));a.log("RECALC ctrl1=%s",a.$);d=a.aa.x-c;g=e.x-c;f=a.aa.y-c;h=e.y-c;a.Na=new E(d+a.oa*(g-d),f+a.oa*(h-f));this.ia-=this.ba}this.aa=b;null===this.gc&&(this.gc=this.ka);a=this.ia/10*this.ta;10<a&&(a=10);e=b.x;c=b.y;d=this.ka.x;f=this.ka.y;e+=a;c+=a;this.$=new E(e+this.la*(d+a-e),c+this.la*(f+a-c));e=b.x-a;d=this.ka.x-a;c=b.y-a;f=this.ka.y-a;this.Na=new E(e+this.oa*(d-e),c+this.oa*(f-c))},ed:function(a){this.xa=a;this.format();this.xa.gc&&(this.moveTo=this.xa.gc)},ma:function(a){this.ba&&
(this.moveTo&&a.moveTo(this.moveTo.x,this.moveTo.y),a.quadraticCurveTo(this.xa.ka.x,this.xa.ka.y,this.aa.x,this.aa.y));a.bezierCurveTo(this.$.x,this.$.y,this.Na.x,this.Na.y,this.gc.x,this.gc.y)},sc:function(){return this.xa?K(this.xa.ka.x,this.xa.ka.y,this.$.x,this.$.y):null},Sb:function(){return K(this.Na.x,this.Na.y,this.ka.x,this.ka.y)}};
function sb(a,b,c){this.ka=b;this.xa=a;this.aa=c;var d=rb(a.ka.x,a.ka.y,b.x,b.y);d||(d=1);var e=(b.x-a.ka.x)/d,f=(b.y-a.ka.y)/d;this.Na=new E(b.x-d*c*e,b.y-d*c*f);if(b=a.Na){var g=K(a.xa.ka.x,a.xa.ka.y,a.ka.x,a.ka.y),h=rb(a.xa.ka.x,a.xa.ka.y,a.ka.x,a.ka.y),e=.5*(e+g.x),f=.5*(f+g.y);b.x=a.ka.x-h*c*e;b.y=a.ka.y-h*c*f}this.$=new E(a.ka.x+d*c*e,a.ka.y+d*c*f);this.length=d}
sb.prototype={ed:function(a){this.xa=a;var b=a.Na,c=(this.ka.x-a.ka.x)/this.length,d=(this.ka.y-a.ka.y)/this.length,e=this.aa;if(b){var f=K(a.xa.ka.x,a.xa.ka.y,a.ka.x,a.ka.y),g=rb(a.xa.ka.x,a.xa.ka.y,a.ka.x,a.ka.y),c=.5*(c+f.x),d=.5*(d+f.y);b.x=a.ka.x-g*e*c;b.y=a.ka.y-g*e*d}this.$=new E(a.ka.x+this.length*e*c,a.ka.y+this.length*e*d)},ma:function(a){a.bezierCurveTo(this.$.x,this.$.y,this.Na.x,this.Na.y,this.ka.x,this.ka.y)},sc:function(){return this.xa?K(this.xa.ka.x,this.xa.ka.y,this.$.x,this.$.y):
null},Sb:function(){return 0<this.aa?K(this.Na.x,this.Na.y,this.ka.x,this.ka.y):K(this.xa.ka.x,this.xa.ka.y,this.ka.x,this.ka.y)}};function tb(a,b,c){this.control=b;this.ka=c}tb.prototype={ma:function(a){a.quadraticCurveTo(this.control.x,this.control.y,this.ka.x,this.ka.y)},sc:function(){return this.xa?K(this.xa.ka.x,this.xa.ka.y,this.control.x,this.control.y):null},Sb:function(){return K(this.control.x,this.control.y,this.ka.x,this.ka.y)}};
function ub(a,b,c,d){this.control=b;this.ka=c;this.Tb=d}ub.prototype={ma:function(a){a.arcTo(this.control.x,this.control.y,this.ka.x,this.ka.y,this.Tb)}};function vb(a,b,c,d){this.$=b;this.Na=c;this.ka=d;this.xa=a}vb.prototype={ma:function(a){a.bezierCurveTo(this.$.x,this.$.y,this.Na.x,this.Na.y,this.ka.x,this.ka.y)},sc:function(){return this.xa?K(this.xa.ka.x,this.xa.ka.y,this.$.x,this.$.y):null},Sb:function(){return K(this.Na.x,this.Na.y,this.ka.x,this.ka.y)}};
function wb(a,b,c,d,e){this.xa=a;this.aa=b;e=2*e;var f=2*d.next()-1;d.next();d=this.xa.Sb();if(!this.xa.Of&&d){var g=rb(a.ka.x,a.ka.y,b.x,b.y);this.$=new E(a.ka.x+.5522847498*d.x*g,a.ka.y+.5522847498*d.y*g)}else this.$=new E(a.ka.x+.5522847498*(b.x-a.ka.x),a.ka.y+.5522847498*(b.y-a.ka.y));this.Na=new E(c.x-.5522847498*(c.x-b.x)*(1-f*e),c.y-.5522847498*(c.y-b.y)*(1-f*e));this.ka=c}
wb.prototype={log:A("SEGMENT"),ed:function(a){this.xa=a;var b=this.xa.Sb();if(b){var c=rb(a.ka.x,a.ka.y,this.aa.x,this.aa.y);this.$=new E(a.ka.x+.5522847498*b.x*c,a.ka.y+.5522847498*b.y*c)}else this.$=new E(a.ka.x+.5522847498*(this.aa.x-this.xa.ka.x),a.ka.y+.5522847498*(this.aa.y-this.xa.ka.y))},ma:function(a){a.bezierCurveTo(this.$.x,this.$.y,this.Na.x,this.Na.y,this.ka.x,this.ka.y)},sc:function(){return this.xa?K(this.xa.ka.x,this.xa.ka.y,this.$.x,this.$.y):null},Sb:function(){return K(this.Na.x,
this.Na.y,this.ka.x,this.ka.y)}};function xb(a){this.aa=a;this.Tb=30;this.$=[]}
xb.prototype={log:A("AngleAddon"),format:function(){var a=this.aa.ba,b=0,c=[],d=[];this.$.length=0;for(var e=0>yb(a);b<a.ga.length;){switch(a.ga[b]){case Ab:c=[new E(a.ga[b+1],a.ga[b+2])];d=c.concat();break;case Bb:3===c.length&&c.shift();c.push(new E(a.ga[b+1],a.ga[b+2]));d.push(c[c.length-1]);3===c.length&&Cb(this,c[0],c[1],c[2],e);break;case Db:3<=d.length&&Cb(this,d[d.length-2],d[0],d[1],e)}b+=Eb[a.ga[b]]}},ma:function(a){a.beginPath();var b,c;for(c=0;c<this.$.length;c++)b=this.$[c],a.moveTo(b.x+
this.Tb*Math.cos(b.pc),b.y+this.Tb*Math.sin(b.pc)),a.arc(b.x,b.y,this.Tb,b.pc,b.Xc,!1);a.lineWidth=3;a.strokeStyle="red";a.stroke();a.fillStyle="red";a.font="20px Arial";for(c=0;c<this.$.length;c++){b=this.$[c];var d=(b.pc+b.Xc)/2+Math.PI;0<b.pc&&0>b.Xc&&(d-=Math.PI);var e=b.Xc-b.pc;0>e&&(e+=2*Math.PI);a.fillText(""+Math.round(e/Math.PI*180)+"\u00b0",b.x+this.Tb*Math.cos(d),b.y+this.Tb*Math.sin(d))}}};
function Cb(a,b,c,d,e){var f;b=K(c.x,c.y,b.x,b.y);f=K(c.x,c.y,d.x,d.y);d=Math.atan2(b.y,b.x);b=Math.atan2(f.y,f.x);e&&(e=d,d=b,b=e);a.$.push({x:c.x,y:c.y,pc:b,Xc:d})};var L=[],Fb=null,Gb=A("ImageLoader");function Hb(){var a=[];Gb("Timeout running... %s images remaining",L.length);for(var b=0;b<L.length;b++)L[b].complete?L[b].bc(L[b],L[b].Pc):5E3>L[b].gd?(L[b].gd+=250,a.push(L[b])):L[b].bc(L[b],L[b].Pc);L=a;L.length?setTimeout(Hb,250):(Gb("Timeout Stopped"),Fb=!1)}
function Ib(a,b){function c(){Gb("LoadFn called. complete=%s",d.complete);if(d.complete)for(var a=0;a<L.length;a++){if(L[a]===d){L.splice(a,1);b(d,d.Pc);break}}else Fb||(Fb=!0,setTimeout(Hb,250),d.gd=250)}var d=document.createElement("img");L.push(d);d.bc=b;d.Pc=a;d.gd=0;-1===a.indexOf("://"+window.location.host)&&(Gb("Using cross origin request for img"),d.crossOrigin="");d.addEventListener?(d.addEventListener("load",function(){c()},!1),d.addEventListener("error",function(){Gb("Error loading %s",
a);b(null,d.Pc)},!1)):(d.attachEvent("onload",function(){c()}),d.attachEvent("onerror",function(){Gb("Error loading %s",a);b(null,d.Pc)}));d.src=a};function M(){this.Ra=!1;this.aa={}}
M.prototype={log:A("EventEmitter"),emit:function(a,b){var c,d=this;this.aa||(this.aa={});c=Array.prototype.slice.call(arguments,1);setTimeout(function(){var b,f,g,h,l=!1;if(a in d.aa)for(h=d.aa[a],f=0,g=h.length;f<g;f++)b=h[f],d.Ra||l||(d.log("Emit %s",a),l=!0),b.apply(null,c)},0);return this},uc:function(a,b){var c;this.aa||(this.aa={});c=Array.prototype.slice.call(arguments,1);var d,e,f,g,h=!1;if(a in this.aa)for(g=this.aa[a],e=0,f=g.length;e<f;e++)d=g[e],this.Ra||h||(this.log("Emit %s",a),h=!0),
d.apply(null,c);return this},on:function(a,b){this.aa||(this.aa={});this.bind(a,b);return this},bind:function(a,b){a in this.aa?this.aa[a].push(b):this.aa[a]=[b];return b}};function Jb(a,b){function c(){var d=c,e,f,g,h;if("done"in a.aa)for(e=a.aa.done,f=g=0,h=e.length-1;g<=h;f=g+=1)if(e[f]===d){e.splice(f,1);break}b.apply(null,arguments)}a.bind("done",c)};function Kb(a){M.call(this);this.ha=a;this.oa=!1;a.da("display","none");this.right=!0;a:{a=(document.body||document.documentElement).style;for(var b="transition",c=["Moz","Webkit","Khtml","O","ms"],b=b.charAt(0).toUpperCase()+b.substr(1),d=0;d<c.length;d++)if("string"===typeof a[c[d]+b]){Lb=c[d];a=!0;break a}a=!1}this.ia=a;this.ta=Lb;this.$=null;this.ia&&(a=this.ha.outerWidth(),this.da("TransitionProperty","transform"),this.da("Transform","translate("+a+"px,0)"));this.la=p(".body")}var Lb;
Kb.prototype={log:A("SlidingPanel",!1),show:function(a,b){var c=this;this.$&&(clearTimeout(this.$),this.$=null);!1!==b&&(b=!0);this.oa=!0;this.ha.show();var d=this.ha.outerWidth();this.ha.Ka();"right"===a?(this.left=!1,this.ha.da("left",""+(p(window).width()-d)+"px")):this.left=!0;b&&(c.ba=new aa,c.ba.$=c.ha.da("z-index"),c.ba.insertBefore=c.ha,c.ba.show(function(){c.Ka()}));c.ia?(this.log("Performing transition"),c.ha.da("display","block"),c.left?c.da("Transform","translate(-"+d+"px,0)"):c.da("Transform",
"translate("+d+"px,0)"),c.da("TransitionDuration","200ms"),c.da("TransitionDuration","200ms",c.la),window.setTimeout(function(){c.da("Transform","translate(0,0)");c.da("Transform","translate("+(c.left?d:-d)+"px,0)",c.la);window.setTimeout(function(){Mb(c)},200)},1)):(this.log("No transitions allowed"),c.ha.da("display","block"),Mb(c))},da:function(a,b,c){c=c||this.ha;a=""!==this.ta?this.ta+a:a.charAt(0).toLowerCase()+a.substr(1);c[0].style[a]=b;this.log("%s=%s",a,b)},ab:function(){return this.oa},
Ka:function(){var a=this;if(!this.$){this.oa=!1;a.ba&&a.ba.Ka();var b=this.ha.outerWidth();a.ia?this.left?a.da("Transform","translate(-"+b+"px,0)"):a.da("Transform","translate("+b+"px,0)"):a.ha.da("display","none");a.da("Transform","translate(0,0)",this.la);a.ia?this.$=window.setTimeout(function(){a.ha.da("display","none");a.emit("hide")},200):a.emit("hide")}}};function Mb(a){console.log("Set focus on ",a.ha.find(".focus"));a.ha.find(".focus").focus();a.emit("show")}
Kb.prototype=p.$({},M.prototype,Kb.prototype);function Nb(){var a=this;M.call(this);window.addEventListener("message",function(b){Ob(a,b)},!1);window.parent.postMessage('{"event": "ready"}',"*")}Nb.prototype={log:A("Api")};
function Ob(a,b){function c(a){"ticket"in d&&(a={ticket:d.ticket,args:a},window.parent.postMessage(window.JSON.stringify(a),"*"))}var d;try{d=window.JSON.parse(b.data)}catch(g){a.log("Error parsing %s from %s",b.data,b.origin);return}a.log("Received %s",b.data);if(d["function"]in a.aa)for(var e=a.aa[d["function"]],f=0;f<e.length;f++)(0,e[f])(d.args,c)}Nb.prototype=p.$({},M.prototype,Nb.prototype);function Pb(){M.apply(this,arguments);this.ba=[];this.$=!1;this.canvas=null}Pb.prototype={log:A("FORMAT",!0),add:function(a,b,c,d,e){var f,g,h,l;l=this.ba;g=0;for(h=l.length;g<h;g++)f=l[g],f.type===b&&f.node===a&&(f.fd=!0);this.log("Request URL %s",c);this.ba.push({node:a,type:b,url:c,xf:d,Id:e,fd:!1});Qb(this)}};
function Rb(a,b){a.$=!0;a.log("Processing request for item %s url=%s",b.node.id,b.url);0===b.type.indexOf("image")?Ib(b.url,function(c,d){null!==c?(a.log("Image request completed for item %s url %s",b.node.id,d),b.Id(c,d)):a.log("Image request failed for url %s",d);a.$=!1;b.fd=!0;Qb(a)}):p.aa({url:b.url,data:b.xf,dataType:"json",success:function(c){b.fd||(a.log("Request completed for item %s",b.node.id),b.Id(c),a.emit("reformat",b.node),a.$=!1,a.ba.shift(),Qb(a))},error:function(b,d,e){a.log("Error: %s %s",
d,e);a.$=!1;a.ba.shift();Qb(a)}})}function Qb(a){for(var b=0;!a.$&&b<a.ba.length;)a.ba[b].fd?a.ba.shift():(Rb(a,a.ba[0]),b+=1);a.$||a.emit("done")}Pb.prototype=p.$({},M.prototype,Pb.prototype);function Sb(a){var b=this;this.xb=0;"string"===typeof a?(this.getUint8=function(){u(b.xb<b.data.length);return b.data.charCodeAt(b.xb++)&255},this.data=a):this.data=new Uint8Array(a)}
Sb.prototype={log:A("BinaryReader"),seek:function(a){u(0<=a&&a<=this.data.length);var b=this.xb;this.xb=a;return b},getUint8:function(){u(this.xb<this.data.length);return this.data[this.xb++]},getUint16:function(){return(this.getUint8()<<8|this.getUint8())>>>0},getUint32:function(){return Tb(this)>>>0},getInt16:function(){var a=this.getUint16();a&32768&&(a-=65536);return a},getDate:function(){var a=1E3*(4294967296*this.getUint32()+this.getUint32())+Date.UTC(1904,1,1);return new Date(a)}};
function Ub(a,b){for(var c="",d=0;d<b;d++)c+=String.fromCharCode(a.getUint8());return c}function Tb(a){return a.getUint8()<<24|a.getUint8()<<16|a.getUint8()<<8|a.getUint8()}function Vb(a){this.format=0;this.$=[];for(var b=0;256>b;b++){var c=a.getUint8();this.log("   Glyph[%s] = %s",b,c);this.$.push(c)}}Vb.prototype={log:A("CMAP0"),map:function(a){return 0<=a&&255>=a?this.$[a]:0}};
function Wb(a){this.format=4;var b,c=[],d=a.getUint16()/2;a.getUint16();a.getUint16();a.getUint16();for(b=0;b<d;b++)c.push({Md:a.getUint16()});a.getUint16();for(b=0;b<d;b++)c[b].Cd=a.getUint16();for(b=0;b<d;b++)c[b].qf=a.getUint16();for(b=0;b<d;b++){var e=a.getUint16();e?c[b].bd=a.xb-2+e:c[b].bd=0}this.$=c;this.aa={};this.ba=a}
Wb.prototype={log:A("CMAP4"),map:function(a){if(!(a in this.aa)){for(var b=0;b<this.$.length;b++){var c=this.$[b];if(c.Cd<=a&&c.Md>=a){var d,e;c.bd?(e=c.bd+2*(a-c.Cd),this.ba.seek(e),d=this.ba.getUint16()):d=c.qf+a&65535;this.log("Charcode %s is between %s and %s; maps to %s (%s) roffset=%s",a,c.Cd,c.Md,e,d,c.bd);this.aa[a]=d;break}}b===this.$.length&&(this.aa[a]=0)}return this.aa[a]}};
function Xb(a,b,c){this.ba=b&&!c||!b&&c;this.offset=a.xb;this.aa=a.getUint16();a.getUint16();a.getUint16();a.getUint16();this.map={};for(b=0;b<this.aa;b++){c=a.getUint16();var d=a.getUint16(),e=a.getInt16();this.map[c<<16|d]=e}this.reset()}Xb.prototype={log:A("KERN0"),reset:function(){this.$=-1},get:function(a){var b=0;if(0<=this.$){var c=this.$<<16|a;c in this.map&&(b=this.map[c])}this.$=a;return this.ba?{x:0,y:b}:{x:b,y:0}}};
function Yb(a){this.aa=new Sb(a);this.la=[];this.yc=[];a=this.aa;var b={};a.getUint32();var c=a.getUint16();a.getUint16();a.getUint16();a.getUint16();for(var d=0;d<c;d++){var e=Ub(a,4);b[e]={Se:a.getUint32(),offset:a.getUint32(),length:a.getUint32()};"head"!==e&&this.log("Table %s has checksum 0x%s",e,b[e].Se.toString(16))}this.$=b;a=this.aa;u("head"in this.$);a.seek(this.$.head.offset);this.version=Tb(a)/65536;Tb(a);a.getUint32();this.Ea=a.getUint32();u(1594834165===this.Ea);a.getUint16();this.oa=
a.getUint16();a.getDate();a.getDate();this.hg=a.getInt16();this.jg=a.getInt16();this.gg=a.getInt16();this.ig=a.getInt16();a.getUint16();a.getUint16();a.getInt16();this.ta=a.getInt16();a.getInt16();a=this.aa;u("name"in this.$);b=this.$.name.offset;a.seek(b);a.getUint16();c=a.getUint16();d=a.getUint16();for(e=0;e<c;e++){var f=a.getUint16(),g=a.getUint16(),h=a.getUint16(),l=a.getUint16(),k=a.getUint16(),n=a.getUint16(),n=a.seek(b+d+n),q;if(0===f||3===f){q=a;for(var r="",t=0;t<k;t+=2)r+=String.fromCharCode(q.getUint16());
q=r}else q=Ub(a,k);this.log("Name %s/%s id %s language %s: %s",f,g,l,h,q);a.seek(n);switch(l){case 1:this.fontFamily=q;break;case 4:this.ba=q}}a=this.aa;u("cmap"in this.$);b=this.$.cmap.offset;a.seek(b);a.getUint16();c=a.getUint16();for(d=0;d<c;d++)e=a.getUint16(),g=a.getUint16(),f=a.getUint32(),this.log("CMap platformid=%s specificid=%s offset=%s",e,g,f),3===e&&1>=g&&(e=a,f=e.seek(b+f),g=e.getUint16(),h=e.getUint16(),e.getUint16(),l=void 0,this.log("    Cmap format %s length %s",g,h),0===g?l=new Vb(e):
4===g&&(l=new Wb(e)),l&&this.la.push(l),e.seek(f));a=this.aa;u("hhea"in this.$);a.seek(this.$.hhea.offset);Tb(a);a.getInt16();a.getInt16();a.getInt16();a.getUint16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();this.ia=a.getUint16();a=this.aa;if("kern"in this.$)for(a.seek(this.$.kern.offset),h=a.getUint16(),b=a.getUint16(),this.log("Kern Table version: %s",h),this.log("Kern nTables: %s",b),c=0;c<b;c++)h=
a.getUint16(),d=a.getUint16(),l=a.getUint16(),e=l>>8,f=l&4,g=0===(l&1),this.log("Kerning subtable version %s format %s length %s coverage: %s",h,e,d,l),h=null,0===e?h=new Xb(a,g,f):(this.log("Unknown format -- skip"),a.seek(a.xb+d)),h&&this.yc.push(h);u("maxp"in this.$);a=this.aa.seek(this.$.maxp.offset+4);b=this.aa.getUint16();this.aa.seek(a);this.length=b}Yb.prototype={log:A("TrueType"),transform:function(a,b){a.scale(b/this.oa,-b/this.oa)}};
function Zb(a,b){function c(b,c,e){for(var h=0,l=0;l<f;l++){var v=g[l];v&c?h=v&e?h+a.getUint8():h-a.getUint8():~v&e&&(h+=a.getInt16());d[l][b]=h}}b.type="simple";b.Rb=[];for(var d=b.qa=[],e=0;e<b.Ac;e++)b.Rb.push(a.getUint16());a.seek(a.getUint16()+a.xb);if(0!==b.Ac){for(var f=Math.max.apply(null,b.Rb)+1,g=[],e=0;e<f;e++){var h=a.getUint8();g.push(h);d.push({mc:0<(h&1)});if(h&8){var l=a.getUint8();u(0<l);for(e+=l;l--;)g.push(h),d.push({mc:0<(h&1)})}}c("x",2,16);c("y",4,32)}}
function $b(a,b){var c;u("loca"in a.$);c=a.$.loca;var d=a.aa,e,f;1===a.ta?(e=d.seek(c.offset+4*b),c=d.getUint32(),f=d.getUint32()):(e=d.seek(c.offset+2*b),c=2*d.getUint16(),f=2*d.getUint16());d.seek(e);c=c===f?0:c+a.$.glyf.offset;d=a.aa;if(0===c||c>=a.$.glyf.offset+a.$.glyf.length)return null;u(c>=a.$.glyf.offset);u(c<a.$.glyf.offset+a.$.glyf.length);d.seek(c);c={Ac:d.getInt16(),hg:d.getInt16(),jg:d.getInt16(),gg:d.getInt16(),ig:d.getInt16()};u(-1<=c.Ac);if(-1===c.Ac){var g,h,l,k,n;c.type="simple";
var q=32;c.Rb=[];for(c.qa=[];q&32;){var r,t,q=d.getUint16();n=d.getUint16();e=1;g=f=0;h=1;k=l=0;q&1?(r=d.getInt16(),t=d.getInt16()):(r=d.getUint8(),t=d.getUint8());q&2&&(l=r,k=t);q&8?h=e=d.getInt16()/16384:q&64?(e=d.getInt16()/16384,h=d.getInt16()/16384):q&128&&(e=d.getInt16()/16384,f=d.getInt16()/16384,g=d.getInt16()/16384,h=d.getInt16()/16384);a.log("Read component glyph index %s",n);a.log("Transform: [%s %s %s %s %s %s]",e,f,g,h,l,k);r=d.xb;if(n=$b(a,n)){var v=c.qa.length;for(t=0;t<n.Rb.length;t++)c.Rb.push(n.Rb[t]+
v);for(t=0;t<n.qa.length;t++){var v=n.qa[t].x,w=n.qa[t].y,v=e*v+f*w+l,w=g*v+h*w+k;c.qa.push({x:v,y:w,mc:n.qa[t].mc})}}d.seek(r)}c.Ac=c.Rb.length;q&256&&d.seek(d.getUint16()+d.xb)}else Zb(d,c);return c}function ac(){M.call(this);this.fonts={};this.error=null;this.$=0}
ac.prototype={log:A("FontCollection"),add:function(a,b){this.$+=1;var c=this;p.aa({url:a,Pf:function(d){var e=b;c.log("Got font %s; result is %s bytes",a,d.length);for(var f="",g=0;g<d.length;g++)f+=String.fromCharCode(d.charCodeAt(g)&255);d=new Yb(f);c.log("Loaded '%s'",d.ba);for(g=0;g<d.ba.length;g++)c.log("   %s, %s",d.ba.charAt(g),d.ba.charCodeAt(g));e=e||d.ba;c.fonts[e]={name:d.ba,url:a,data:f,font:d};--c.$;0===c.$&&c.emit("done")},error:function(){c.log("Error fetching "+a)},Re:function(a,b){b.overrideMimeType("text/plain; charset=x-user-defined")}})},
get:function(a){this.log("Lookup font %s",a);for(var b=0;b<a.length;b++)this.log("   %s, %s",a.charAt(b),a.charCodeAt(b));if(a in this.fonts)return this.fonts[a].font;this.log("Lookup font %s; not found",a)}};ac.prototype=p.$({},M.prototype,ac.prototype);function O(a,b){this.type=a;this.values=b;if(4>this.values.length)throw"Bad value";}var bc;
function cc(a,b){a.toLowerCase()in dc&&(a=dc[a.toLowerCase()]);var c=/\#([0-9a-f])([0-9a-f])([0-9a-f])/i,d=/rgb\( *([0-9]+) *, *([0-9]+) *, *([0-9]+) *\)/,e=/rgba\( *([0-9]+) *, *([0-9]+) *, *([0-9]+) *, *([0-9\.]+) *\)/,f;f=/\#([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])/i.exec(a);if(null!==f)c=parseInt(f[1],16)/255,d=parseInt(f[2],16)/255,e=parseInt(f[3],16)/255,f=1;else if(f=e.exec(a),null!==f)c=parseFloat(f[1])/255,d=parseFloat(f[2])/255,e=parseFloat(f[3])/255,f=parseFloat(f[4]);else{f=
d.exec(a);if(null!==f)c=parseFloat(f[1])/255,d=parseFloat(f[2])/255,e=parseFloat(f[3])/255;else if(f=c.exec(a),null!==f)c=parseInt(f[1],16),c=(16*c+c)/255,d=parseInt(f[2],16),d=(16*d+d)/255,e=parseInt(f[2],16),e=(16*e+e)/255;else{if(b)return null;c=1;d=0;e=1}f=1}return new O(0,[c,d,e,f])}
O.prototype={toString:function(){function a(a){a=Math.round(255*a);return 16>a?"0"+a.toString(16):a.toString(16)}var b=ec(this,0);return 1===b.values[3]?"#"+a(b.values[0])+a(b.values[1])+a(b.values[2]):"rgba("+Math.round(255*b.values[0])+","+Math.round(255*b.values[1])+","+Math.round(255*b.values[2])+","+b.values[3]+")"},kb:function(a){a.type!==this.type&&(a=ec(a,this.type));if(2===this.type){var b=this.values[0],c=a.values[0],b=b>c?Math.min(b-c,c-b+360):Math.min(c-b,b-c+360),b=b/360;return Math.pow(b*
b+(this.values[1]-a.values[1])*(this.values[1]-a.values[1])+(this.values[2]-a.values[2])*(this.values[2]-a.values[2]),.5)}return Math.pow((this.values[0]-a.values[0])*(this.values[0]-a.values[0])+(this.values[1]-a.values[1])*(this.values[1]-a.values[1])+(this.values[2]-a.values[2])*(this.values[2]-a.values[2]),.5)}};function ec(a,b){return bc[a.type][b](a)}
(function(){function a(a){var b=a.values[0],c=a.values[1],d=a.values[2];0>b&&(b+=360);var e=b/60-Math.floor(b/60),f=d*(1-c),g=d*(1-e*c),c=d*(1-(1-e)*c),h,l,k;switch(Math.floor(b/60)%6){case 0:h=d;l=c;k=f;break;case 1:h=g;l=d;k=f;break;case 2:h=f;l=d;k=c;break;case 3:h=f;l=g;k=d;break;case 4:h=c;l=f;k=d;break;case 5:h=d,l=f,k=g}return new O(0,[h,l,k,a.values[3]])}function b(a){var b,c=a.values[0],d=a.values[1],e=a.values[2],f=Math.max(c,d,e),g=Math.min(c,d,e);f===g?b=0:f===c?b=(60*(d-e)/(f-g)+360)%
360:f===d?b=60*(e-c)/(f-g)+120:f===e&&(b=60*(c-d)/(f-g)+240);return new O(2,[b,0===f?0:1-g/f,f,a.values[3]])}function c(a){function b(a){return a>6/29*(6/29)*(6/29)?Math.pow(a,1/3):1/3*(29/6)*(29/6)*a+4/29}var c=b(a.values[1]/k.nd);return new O(3,[116*c-16,500*(b(a.values[0]/k.md)-c),200*(c-b(a.values[2]/k.od)),a.values[3]])}function d(a){var b=(a.values[0]+16)/116,c=b+a.values[1]/500,d=b-a.values[2]/200,e=6/29;return new O(1,[c>e?k.md*c*c*c:3*(c-16/116)*e*e*k.md,b>e?k.nd*b*b*b:3*(b-16/116)*e*e*k.nd,
d>e?k.od*d*d*d:3*(d-16/116)*e*e*k.od,a.values[3]])}function e(a){for(var b=[],c=0;3>c;c++)b[c]=.04045>=a.values[c]?a.values[c]/12.92:Math.pow((a.values[c]+.055)/1.055,2.4);return new O(1,[.4124*b[0]+.3576*b[1]+.1805*b[2],.2126*b[0]+.7152*b[1]+.0722*b[2],.0193*b[0]+.1192*b[1]+.9505*b[2],a.values[3]])}function f(a){var b=[],c=[];b[0]=3.241*a.values[0]-1.5374*a.values[1]-.4986*a.values[2];b[1]=-.9692*a.values[0]+1.876*a.values[1]+.0416*a.values[2];b[2]=.0556*a.values[0]-.204*a.values[1]+1.057*a.values[2];
for(var d=0;3>d;d++)c[d]=.0031308>=b[d]?12.92*b[d]:1.055*Math.pow(b[d],1/2.4)-.055;c[3]=a.values[3];return new O(0,c)}function g(a){return new O(a.type,a.values.concat())}function h(a){return c(e(a))}function l(a){return b(f(a))}var k={md:.9505,nd:1,od:1.089};bc=[[g,e,b,h],[f,g,l,c],[a,function(b){return e(a(b))},g,function(b){return h(a(b))}],[function(a){return f(d(a))},d,function(a){return l(d(a))},g]]})();
var dc={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",
darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",
gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",
lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",
orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",
snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};var fc=A("MISC");function gc(a){window.jQuery&&a instanceof window.jQuery&&(a=a[0]);return p(a)}function jc(a){var b=document.createElement("canvas");a&&a.appendChild(b);"G_vmlCanvasManager"in window&&(fc("Emulating canvas in IE"),G_vmlCanvasManager.initElement(b),p(b).bind("selectstart",function(a){fc("Cancelled selectstart on canvas");a.stopPropagation();a.preventDefault()}));b.style.background="transparent";return b}var kc=/MSIE ([0-9]{1,}[\.0-9]{0,})/,lc=null;
function pc(){var a;if(null!==lc)a=lc;else{a=-1;if("Microsoft Internet Explorer"===navigator.appName){var b=kc.exec(navigator.userAgent);null!==b&&(a=parseFloat(b[1]))}lc=a;fc("IE version is %s",a)}return 0<=a&&9>a}function qc(a){for(var b=0;a;)try{var c=parseInt(p(a).da("z-index"),10);c&&(b=Math.max(b,c));a=a.parentNode}catch(d){break}return b}var rc=null;function sc(a,b){var c=cc(a);c.values[3]=b;return c.toString()}
function tc(a){var b=atob(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var c=new ArrayBuffer(b.length),d=new Uint8Array(c),e=0;e<b.length;e++)d[e]=b.charCodeAt(e);return new Blob([c],{type:a})}function uc(){return{width:p(window).width(),height:p(window).height(),x:document.body.scrollLeft,y:document.body.scrollTop}};function vc(a,b,c,d){wc(this,a,b,c,d)}
function wc(a,b,c,d,e){function f(a){for(var b=30;100>b;b+=20)a.values[2]=b/100,g.$.push(a.toString())}M.call(a);a.canvas=p(jc(b[0]));a.ha=a.canvas;a.canvas.da("position","absolute");a.canvas.da("border","none");a.canvas.da("border-top","1px solid black");a.canvas.da("display","block");a.na=a.canvas[0].getContext("2d");a.size=c;a.Hb=d;a.la=e;a.$="rgba(0,0,0,0.0) rgba(0,0,0,0.5) #000000 #ffffff #000088 #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" ");var g=
a;f(new O(2,[0,0,0,1]));for(b=0;720>b;b+=35)c=new O(2,[b,.5,0,1]),f(c);xc(a,100);a.canvas.bind("touchstart",function(a){var b=g.canvas.offset();g.pb(a.touches[0].pageX-b.left-0,a.touches[0].pageY-b.top-0,1);a.preventDefault();a.stopPropagation()});Oa(a.canvas,function(a){var b=g.canvas.offset();g.pb(a.pageX-b.left-0,a.pageY-b.top-0,a.which)||(a.preventDefault(),a.stopPropagation())});a.canvas.bind("contextmenu",function(a){a.preventDefault();a.stopPropagation();return!1})}m=vc.prototype;m.log=A("COLOURPANEL");
function yc(a,b){a.$=b.slice(0);a.log("Set colours to %s len=%s",a.$,a.$.length);a.format();a.ma()}function xc(a,b){a.width=b;a.canvas.Va("width",""+a.width);a.format();a.ma()}function zc(a,b){a.ia=b;a.canvas.Va("height",""+(a.ia-1))}m.height=function(){return this.ia};m.moveTo=function(a,b){this.canvas.da("left",""+a+"px");this.canvas.da("top",""+b+"px")};
m.format=function(){this.ba=Math.floor(this.width/this.size);var a=Math.ceil(this.$.length/this.ba);this.log("Format to width=%s; height=%s wrap=%s, cpr=%s",this.width,a*this.size,this.la,this.ba);this.la?zc(this,a*this.size):zc(this,this.size)};function Ac(a,b,c,d){a.fillStyle="#ffffff";a.fillRect(b,c,d,d);a.beginPath();a.strokeStyle="#000000";a.moveTo(b,c);a.lineTo(b+d,c+d);a.moveTo(b+d,c);a.lineTo(b,c+d);a.stroke()}
function Bc(a,b,c,d){for(var e,f=0;f<d;f+=5){e=0===f/5%2;for(var g=0;g<d;g+=5)a.fillStyle=e?"#000000":"#ffffff",e=!e,a.fillRect(b+g,c+f,5,5)}e=a.createLinearGradient(b+d,c+d,b,c);e.addColorStop(0,"rgba(255, 255, 255, 1.0)");e.addColorStop(1,"rgba(255, 255, 255, 0.0)");a.fillStyle=e;a.fillRect(b,c,d,d)}
m.ma=function(){for(var a=0,b=0,c=0;c<this.$.length;c++){var d=cc(this.$[c]);this.na.fillStyle=this.$[c];this.na.fillRect(a,b,this.size,this.size);0===d.values[3]?Ac(this.na,a,b,this.size):.5===d.values[3]&&Bc(this.na,a,b,this.size);a+=this.size;a>=this.width&&(b+=this.size,a=0)}};m.Ka=function(){this.canvas.Ka()};m.show=function(){this.canvas.show()};
m.pb=function(a,b,c){a=Math.floor(a/this.size);var d=Math.floor(b/this.size);b=d*this.ba+a;this.log("row=%s col=%s index=%s coloursPerRow=%s",d,a,b,this.ba);c=1===c;return 0===b?(this.emit("opacity",0,c),!0):1===b?(this.emit("opacity",.5,c),!0):b<this.$.length?(this.emit("colour",{Qa:this.$[b],Tc:c}),!0):!1};p.$(vc.prototype,M.prototype);function Cc(a,b,c){var d=this;M.call(this);this.ia=b;this.ha=p(a);b||(this.ha.da("overflow-y","scroll"),this.ha.da("text-align","center"));b||c||(a=p("<input>").Va("type","button").Va("value","Add Page"),this.ha.append(a),a.click(function(){d.va.hc(d.va.xc(d.va.cc()+1))}),a=p("<input>").Va("type","button").Va("value","Delete Page"),this.ha.append(a),a.click(function(){d.va.Kd(d.va.cc())}),this.ba=!1);this.$=[]}
Cc.prototype={log:A("PageSelector"),ib:function(a){this.log("Set page %s",a);this.page<this.$.length&&p(this.$[this.page]).da("border-color","transparent");this.page=a;this.page<this.$.length&&p(this.$[this.page]).da("border-color","#9fb3e7")}};
function Dc(a,b){var c=jc(a.ha[0]);a.ia||(p(c).da("margin-left","10px"),p(c).da("margin-right","10px"),p(c).da("margin-top","5px"),p(c).da("margin-bottom","5px"));p(c).da("border-width","3px");a.log("Make canvas for page %s, currentPage is %s",b,a.page);b===a.page?p(c).da("border-color","#9fb3e7"):p(c).da("border-color","transparent");p(c).da("border-style","solid");a.$.push(c);c.page=b;p(c).click(function(){a.va.hc(c.page)});return c}
function Ec(a){a.log("Regenerate page views.");var b=a.ha.width()-6-10;if(null===rc){var c=document.createElement("div");c.style.visibility="hidden";c.style.width="100px";document.body.appendChild(c);var d=c.offsetWidth;c.style.overflow="scroll";var e=document.createElement("div");e.style.width="100%";c.appendChild(e);e=e.offsetWidth;c.parentNode.removeChild(c);rc=d-e;fc("ScrollbarWidth calculated as %spx",rc)}b=b-rc;c=a.ha.height()-6;d=a.va.Jb();e=a.va.vc();c>b?c=b/e.width*e.height:b=c/e.height*
e.width;for(var f=0;f<d;f++){var g;g=f===a.$.length?Dc(a,f):a.$[f];g.width=b;g.height=c;g=g.getContext("2d");g.save();g.fillStyle="#ffffff";g.fillRect(0,0,b,c);g.scale(b/e.width,b/e.width);g.translate(-e.x,-e.y);a.va.ma(g,{page:f});g.restore()}for(;f<a.$.length;f++)p(a.$[f]).remove();a.$.length=d}
function Fc(a,b){function c(){null===e&&d.ba&&(e=setTimeout(function(){Ec(d);d.ib(d.va.cc());e=null},100))}var d=a,e=null;a.va=b;b.on("document-changed",function(){c()});b.on("resource-loaded",function(){c()});b.on("set-page",function(a){d.ib(a)})}function Gc(a,b){a.ba=b;a.ba&&a.va&&setTimeout(function(){Ec(a)},10)}Cc.prototype=p.$({},M.prototype,Cc.prototype);function Hc(a,b){this.ha=a;this.canvas=document.createElement("canvas");this.height=this.width=b;this.canvas.width=this.width;this.canvas.height=this.height;this.canvas.style.cursor="crosshair";this.ta=0;this.ha.appendChild(this.canvas);"G_vmlCanvasManager"in window&&window.G_vmlCanvasManager.initElement(this.canvas);this.na=this.canvas.getContext("2d");var c=document.createElement("input");c.setAttribute("type","range");this.la=document.createElement("input");this.la.setAttribute("type","checkbox");
"range"===c.type?(this.ha.appendChild(document.createElement("br")),this.ha.appendChild(c),c.min=0,c.max=255,c.value=255,this.ba=c):(this.ba=null,c="colourcheckbox"+this.ta,this.la.setAttribute("id",c),this.ha.appendChild(document.createElement("br")),this.ha.appendChild(this.la),this.ta+=1,c=p("<label>").Va("for",c).text("Transparent"),this.ha.appendChild(c[0]));this.$=this.height;this.ia=.8*this.height;if(Hc[b])this.data=Hc[b];else{for(var c=this.na.getImageData(0,0,this.$,this.$),d=this.$/2,e=
this.ia/2,f,g=0;g<this.$;g++){var h=Math.sqrt(d*d-(g-d)*(g-d)),l=Math.floor(-h+d),k=Math.floor(h+d),n=e*e-(g-d)*(g-d);if(0<=n){for(var h=Math.sqrt(n),n=Math.floor(-h+d),q=Math.floor(h+d),h=g*this.$*4+4*l;l<=n;l++)f=Math.atan2(g-d,l-d),f=new O(2,[f/Math.PI*180,1,1,1]),f=ec(f,0),c.data[h++]=255*f.values[0],c.data[h++]=255*f.values[1],c.data[h++]=255*f.values[2],c.data[h++]=255;h=g*this.$*4+4*q;l=q}else h=g*this.$*4+4*l;for(;l<=k;l++)f=Math.atan2(g-d,l-d),f=new O(2,[f/Math.PI*180,1,1,1]),f=ec(f,0),c.data[h++]=
255*f.values[0],c.data[h++]=255*f.values[1],c.data[h++]=255*f.values[2],c.data[h++]=255}this.data=c;Hc[b]=c}this.aa=new O(2,[20,1,1,1]);this.update();this.ma();var r=this;r.Ea=!1;r.oa="";Oa(p(this.canvas),function(a){var b=p(r.canvas).offset(),c=a.pageX-b.left,b=a.pageY-b.top;r.Ea=!0;Ic(r,c,b);a.stopPropagation();a.preventDefault()});Ma(p(this.canvas),function(a){if(r.Ea){var b=p(r.canvas).offset();Ic(r,a.pageX-b.left,a.pageY-b.top)}a.stopPropagation();a.preventDefault()});Na(p(window),function(){r.Ea=
!1;r.oa=""});null!==this.ba&&Ia(p(this.ba),function(){r.aa.values[3]=r.ba.value/255;r.update();r.ma()});Ia(p(this.la),function(){r.aa.values[3]=r.la.checked?0:1;r.update();r.ma()})}
Hc.prototype={update:function(){this.Ja&&this.Ja(this.aa.toString())},ma:function(){this.na.save();this.na.lineWidth=1;this.na.fillStyle="rgb(128, 128, 128)";this.na.fillRect(0,0,this.width,this.height);this.na.putImageData(this.data,0,0);var a=this.aa.values[0]/180*Math.PI;this.na.beginPath();var b={x:Math.cos(a)*this.ia/2+this.$/2,y:Math.sin(a)*this.ia/2+this.$/2},c={x:Math.cos(a+2*Math.PI/3)*this.ia/2+this.$/2,y:Math.sin(a+2*Math.PI/3)*this.ia/2+this.$/2},d={x:Math.cos(a+4*Math.PI/3)*this.ia/2+
this.$/2,y:Math.sin(a+4*Math.PI/3)*this.ia/2+this.$/2},e=Math.cos(a)*this.$/2+this.$/2,a=Math.sin(a)*this.$/2+this.$/2,f=c.x+(d.x-c.x)/2,g=c.y+(d.y-c.y)/2;this.na.moveTo(b.x,b.y);this.na.lineTo(c.x,c.y);this.na.lineTo(d.x,d.y);this.na.lineTo(b.x,b.y);var h=this.na.createLinearGradient(c.x,c.y,d.x,d.y);h.addColorStop(0,"#ffffff");h.addColorStop(1,"#000000");this.na.fillStyle=h;this.na.fill();h=this.na.createLinearGradient(b.x,b.y,f,g);f=ec(this.aa,2);f.values[1]=1;f.values[2]=1;f=ec(f,0);f.values[3]=
1;h.addColorStop(0,f.toString());f.values[3]=0;h.addColorStop(1,f.toString());this.na.fillStyle=h;this.na.fill();this.strokeStyle="#000000";this.na.beginPath();this.na.moveTo(b.x,b.y);this.na.lineTo(e,a);this.na.stroke();a=1-this.aa.values[2];e=this.aa.values[1]*b.x+a*d.x+(1-this.aa.values[1]-a)*c.x;a=this.aa.values[1]*b.y+a*d.y+(1-this.aa.values[1]-a)*c.y;this.na.beginPath();this.na.arc(e,a,4,0,2*Math.PI,!1);this.na.stroke();this.na.restore();this.Ra=b;this.Za=c;this.eb=d}};
function Ic(a,b,c){var d=Math.sqrt((b-a.$/2)*(b-a.$/2)+(c-a.$/2)*(c-a.$/2));if("ring"===a.oa||"triangle"!==a.oa&&d>=a.ia/2&&d<=a.$/2)a.aa.values[0]=Math.atan2(a.$/2-c,a.$/2-b)/Math.PI*180+180,0===a.aa.values[1]&&(a.aa.values[1]=1,a.aa.values[2]=1),a.oa="ring";else{var e,f=a.Ra,d=a.Za,g=a.eb;e=(f.x-g.x)*(d.y-g.y)-(d.x-g.x)*(f.y-g.y);d=((d.y-g.y)*(b-g.x)-(d.x-g.x)*(c-g.y))/e;b=1-Math.max(0,d)-Math.max(0,(-(f.y-g.y)*(b-g.x)+(f.x-g.x)*(c-g.y))/e);a.aa.values[1]=Math.min(Math.max(d,0),1);a.aa.values[2]=
1-Math.min(Math.max(b,0),1);a.oa="triangle"}0===a.aa.values[3]&&(a.aa.values[3]=1,null!==a.ba&&(a.ba.value=255));a.ma();a.update()}function Jc(a,b){a.aa=ec(cc(b),2);null!==a.ba&&(a.ba.value=Math.round(255*a.aa.values[3]));a.la.checked=0===a.aa.values[3]?!0:!1;a.ma();a.update()}function Kc(){var a=document.createElement("canvas");"G_vmlCanvasManager"in window&&window.G_vmlCanvasManager.initElement(a);return a.getContext&&a.getContext("2d").getImageData};function Lc(a){if("string"===typeof a){for(;8>a.length;)a+=a;for(var b=16777619,c=0;c<a.length;c++)b=(16777619*b^a.charCodeAt(c))&4294967295;a=b}this.ba=a;this.reset()}Lc.prototype={reset:function(){this.aa=this.$=this.ba},next:function(){this.aa=36969*(this.aa&65535)+(this.aa>>16);this.$=18E3*(this.$&65535)+(this.$>>16);return((this.aa<<16)+this.$)/4294967295/2+.5}};function Mc(a,b){for(var c in a)a.hasOwnProperty(c)&&!b.hasOwnProperty(c)&&(b[c]=a[c])};function Nc(a,b){M.call(this);this.Pb=b;this.ha=document.createElement("div");this.ha.style.width=b+"px";this.ha.style.height="320px";this.ha.style.border="none";this.ha.style.backgroundColor="#ffffff";this.ha.style.MozUserSelect="none";this.ha.style.WebkitUserSelect="none";this.ha.style.$="none";this.ha.style.ia="none";this.ia={};this.la=1;this.$=[];this.ba=0}
Nc.prototype={width:function(){return parseInt(this.ha.style.width,10)},focus:function(a){0<this.$.length&&(0<arguments.length&&(Oc(this,!1),this.ba=a),Oc(this,!0))},blur:function(){0<this.$.length&&Oc(this,!1)},ob:function(a,b){if(0!==this.$.length){var c="next"===a||"previous"===a;c&&Oc(this,!1);switch(a){case "next":this.ba=Math.min(this.ba+1,this.$.length-1);break;case "previous":this.ba=Math.max(this.ba-1,0);break;case "enter":this.$[this.ba].Ve(b)}c&&(Oc(this,!0),b.stopPropagation(),b.preventDefault())}},
moveTo:function(a,b){p(this.ha).da("left",""+a+"px");p(this.ha).da("top",""+b+"px")},show:function(a){this.ha.style.display=a||0===arguments.length?"block":"none"},log:A("TOOLBAR"),sb:function(a,b,c){function d(){var a=e.style.background;e.style.background="#e7d69f";f.style.background="#e7d69f";var b=e.style.background;setTimeout(function(){e.style.background===b&&(e.style.background=a,f.style.background=a)},200)}var e=document.createElement("div"),f=document.createElement("img"),g=this;e.style.display=
"inline";e.style.cssFloat="left";e.style.overflow="hidden";e.style.width=this.Pb+"px";e.style.height=this.Pb+"px";e.style.margin="1px";f.src=a;f.ha=e;f.style.cursor="hand";f.setAttribute("title",b);f.style.maxWidth=this.Pb+"px";f.style.maxHeight=this.Pb+"px";f.draggable=!1;e.appendChild(f);p(f).bind("load",function(){g.log("Toolbar image loaded; %sx%s",f.width,f.height);var a=(this.Pb-f.height)/2;f.style.marginLeft=(this.Pb-f.width)/2+"px";f.style.marginTop=a+"px"});this.ha.appendChild(e);var h=this.$.length;
c&&(p(e).bind("touchstart",function(a){a.preventDefault();g.log("Got touchstart");d();c(a);g.emit("click",a)}),p(e).click(function(a){g.log("Got a click");d();c(a);g.focus(h);g.emit("click",a)}));this.la+=this.Pb+1;this.$.push({element:e,Ve:c});return f}};
function Pc(a,b){for(var c in a.ia)a.ia.hasOwnProperty(c)&&(a.ia[c].ha.style.background="#ffffff",a.ia[c].style.background="#ffffff");b in a.ia?(c=a.ia[b],a.log("Highlight %s",b),c.ha.style.background="#9fb3e7",c.style.background="#9fb3e7"):a.log("Failed to highlight %s",b)}function Qc(a,b,c,d,e){a.ia[b]=a.sb(d,c,e)}function Oc(a,b){a.$[a.ba].element.style.outline=b?"1px dotted gray":"none"}Mc(M.prototype,Nc.prototype);function Rc(){M.call(this);Sc(this)}
Rc.prototype={log:A("KEYMAP"),map:function(a,b){var c=a.toLowerCase().split(","),d;if("string"===typeof b){var e=b.split(",");for(d=0;d<c.length;d++)for(var f=0;f<e.length;f++)Tc(this,c[d],e[f])}else for(d=0;d<c.length;d++)Tc(this,c[d],b)},translate:function(a){var b=[],c="";a.keyCode&&(c+=a.keyCode);a.shiftKey&&(c+="-shift");a.ctrlKey&&(c+="-control");a.altKey&&(c+="-alt");a.metaKey&&(c+="-meta");a=c;a in this.keys&&(b=this.keys[a]);this.log("%s",a);return b},lb:function(a,b){for(var c=this.translate(a),
d=0;d<c.length;d++)b(c[d])}};function Uc(a,b){p(b).bind("keydown",a.$)}
function Tc(a,b,c){if(0!==b.length){var d=b.match(a.ba)||[],e=!1,f=!1,g=!1,h=!1,l=[],k;for(k=0;k<d.length;k++)switch(d[k]){case "alt":g=!0;break;case "control":case "ctrl":f=!0;break;case "shift":e=!0;break;case "shift":e=!0;break;case "home":l.push(36);break;case "end":l.push(35);break;case "pageup":l.push(33);break;case "pagedown":l.push(34);break;case "delete":case "del":l.push(46);break;case "backspace":l.push(8);break;case "up":l.push(38);break;case "right":l.push(39);break;case "down":l.push(40);
break;case "left":l.push(37);break;case "escape":case "esc":l.push(27);break;case "enter":l.push(13);break;case "ins":case "insert":l.push(45);break;case "f4":l.push(115);break;case "meta":case "command":case "cmd":case "\u2318":h=!0;break;default:alert("key entry not found: "+d[k])}d=function(b){e&&-1===b.indexOf("-shift")&&(b+="-shift");f&&-1===b.indexOf("-control")&&(b+="-control");g&&-1===b.indexOf("-alt")&&(b+="-alt");h&&-1===b.indexOf("-meta")&&(b+="-meta");"string"===typeof c?a.log("Keyboard mapping: %s->%s",
b,c):a.log("Keyboard mapping: %s->%s",b,"function()");if(b in a.keys){for(var d=0,l=a.keys[b],d=0;d<l.length&&l[d]!==c;d++);d===l.length&&a.keys[b].push(c)}else a.keys[b]=[c]};if(0===l.length)switch(b=b.toUpperCase().charAt(b.length-1),b){case "=":d("107-shift");d("187");d("61");break;case "+":d("107");d("61-shift");break;case "-":d("109");d("189");d("173");break;default:l.push(b.charCodeAt(0))}for(k=0;k<l.length;k++)d(""+l[k])}}
function Sc(a){a.keys={};a.Ra=!0;a.ba=new RegExp("alt backspace cmd command control ctrl del delete down end enter esc escape f4 home ins insert left meta pagedown pageup right shift up \u2318".split(" ").sort(function(a,c){return c.length-a.length}).join("|"),"g");a.$=function(b){for(var c=a.translate(b),d=0;d<c.length;d++)if("string"===typeof c[d])a.log("action: %s",c[d]),a.uc("*",c[d],b);else c[d](b)}}Mc(M.prototype,Rc.prototype);function Vc(){var a=document.createElement("input");p(a).Va("type","range");if("range"===a.type)return a.If=function(b,c){a.min=b;a.max=c},a.nf=function(){return a.value},a.ee=function(b){a.value=b},a;var b=p("<div>");b.da("display","inline-block");b.da("vertical-align","top");b.da("height","1em");b.da("width","10em");b.da("padding","0.25em");b.da("position","relative");var c=p("<div>");c.da("top","50%");c.da("height","0");c.da("border-top","1px solid black");c.da("border-bottom","1px solid #888888");
c.da("position","absolute");c.da("left","0");c.da("right","0");var d=p("<div>");d.da("height","1em");d.da("left","0px");d.da("background","#888888");d.da("border-top","1px solid #cccccc");d.da("border-left","1px solid #cccccc");d.da("border-bottom","1px solid #000000");d.da("border-right","1px solid #000000");d.da("width","0.5em");d.da("position","absolute");d.da("cursor","pointer");b.append(c);b.append(d);b[0].type="range";b[0].min=0;b[0].max=100;b[0].value=0;b[0].onchange=function(){};b[0].If=function(a,
c){b[0].min=a;b[0].max=c};b[0].ee=function(a){b[0].value=a;var c=b.width()-d.width();a=a/b[0].max*c;a=Math.round(a);a=Math.max(a,0);a=Math.min(a,b.width());d.da("left",""+a+"px")};b[0].nf=function(){return b[0].value};var e,f,g,h=A("RANGE");Oa(p(d),function(a){g=!0;e=a.pageX;f=parseInt(d.da("left"),10);h("Mousedown at %s, ox=%s",e,f);a.stopPropagation();a.preventDefault()});Oa(p(b),function(a){var c=b.width()-d.width(),h=a.pageX-p(b).offset().left,h=Math.max(h,0),h=Math.min(h,c);d.da("left",""+h+
"px");e=a.pageX;f=h;h=h/c*(b[0].max-b[0].min)+b[0].min;h=Math.round(h);b[0].value=h;b[0].onchange();g=!0});Ma(p(b),function(a){if(g){var c=b.width()-d.width();a=a.pageX-e+f;a=Math.max(a,0);a=Math.min(a,c);d.da("left",""+a+"px");a=a/c*(b[0].max-b[0].min)+b[0].min;a=Math.round(a);b[0].value=a;b[0].onchange()}});Na(p(document.body),function(){g=!1});return b[0]};function E(a,b){this.x=a;this.y=b}E.prototype.kb=function(a){return Math.sqrt((a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y))};E.prototype.toString=function(){return"("+this.x+", "+this.y+")"};E.prototype.ac=function(a){return this.x===a.x&&this.y===a.y};E.prototype.clone=function(){return new E(this.x,this.y)};function Wc(a,b){this.width=a;this.height=b}function rb(a,b,c,d){return Math.sqrt((a-c)*(a-c)+(b-d)*(b-d))}
function K(a,b,c,d){var e=rb(a,b,c,d);return 0===e?{x:1,y:0}:{x:(c-a)/e,y:(d-b)/e}}function Xc(a){a.x*=-1;a.y*=-1;return a}function P(a,b,c,d){this.x=a;this.y=b;this.width=c;this.height=d;0>this.width&&(this.x+=this.width,this.width=-this.width);0>this.height&&(this.y+=this.height,this.height=-this.height)}
function $c(a){if(0===a.length)return new P(0,0,0,0);for(var b=a[0].x,c=a[0].x,d=a[0].y,e=a[0].y,f=1;f<a.length;f++)a[f].x<b&&(b=a[f].x),a[f].x>c&&(c=a[f].x),a[f].y<d&&(d=a[f].y),a[f].y>e&&(e=a[f].y);return new P(b,d,c-b,e-d)}
P.prototype={save:function(){return{x:this.x,y:this.y,width:this.width,height:this.height}},clone:function(){return new P(this.x,this.y,this.width,this.height)},ac:function(a){return this.x===a.x&&this.y===a.y&&this.width===a.width&&this.height===a.height},contains:function(a){return this.x<=a.x&&this.x+this.width>a.x+a.width&&this.y<=a.y&&this.y+this.height>a.y+a.height},Qb:function(a,b){return this.x<=a&&this.x+this.width>a&&this.y<=b&&this.y+this.height>b},Mb:function(a,b){void 0===b&&(b=a);this.x-=
a/2;this.y-=b/2;this.width+=a;this.height+=b},transform:function(a){var b,c,d;b=a.apply(this.x,this.y);c=a.apply(this.x+this.width,this.y);d=a.apply(this.x+this.width,this.y+this.height);a=a.apply(this.x,this.y+this.height);this.x=Math.min(b.x,c.x,d.x,a.x);this.y=Math.min(b.y,c.y,d.y,a.y);this.width=Math.max(b.x,c.x,d.x,a.x)-this.x;this.height=Math.max(b.y,c.y,d.y,a.y)-this.y},right:function(){return this.x+this.width},bottom:function(){return this.y+this.height},toString:function(){return"Rectangle("+
this.x+", "+this.y+", "+this.width+", "+this.height+")"}};function ad(a){return new E(a.x+a.width/2,a.y+a.height/2)}function bd(a,b,c){b<a.x?(a.width+=a.x-b,a.x=b):b>a.x+a.width&&(a.width=b-a.x);c<a.y?(a.height+=a.y-c,a.y=c):c>a.y+a.height&&(a.height=c-a.y)}function cd(a,b){b.x<a.x&&(a.width+=a.x-b.x,a.x=b.x);b.y<a.y&&(a.height+=a.y-b.y,a.y=b.y);b.x+b.width>a.x+a.width&&(a.width+=b.x+b.width-a.x-a.width);b.y+b.height>a.y+a.height&&(a.height+=b.y+b.height-a.y-a.height)}
function Q(a){if(0===arguments.length)this.m11=1,this.m21=this.m12=0,this.m22=1,this.Ba=this.Aa=0;else if(1===arguments.length){if(6!==arguments[0].length)throw"Bad array initializer for Matrix.";this.m11=arguments[0][0];this.m12=arguments[0][1];this.m21=arguments[0][2];this.m22=arguments[0][3];this.Aa=arguments[0][4];this.Ba=arguments[0][5]}else if(6===arguments.length)this.m11=arguments[0],this.m12=arguments[1],this.m21=arguments[2],this.m22=arguments[3],this.Aa=arguments[4],this.Ba=arguments[5];
else throw"Bad initializer for Matrix.";}
Q.prototype={log:A("MATRIX"),toString:function(){return"[ "+this.m11+" "+this.m12+" "+this.Aa+"    "+this.m21+" "+this.m22+" "+this.Ba+"    0 0 1 ]"},Gb:function(){return[this.m11,this.m12,this.m21,this.m22,this.Aa,this.Ba]},multiply:function(a){var b=new Q;b.m11=this.m11*a.m11+this.m12*a.m21;b.m21=this.m21*a.m11+this.m22*a.m21;b.m12=this.m11*a.m12+this.m12*a.m22;b.m22=this.m21*a.m12+this.m22*a.m22;b.Aa=this.m11*a.Aa+this.m12*a.Ba+this.Aa;b.Ba=this.m21*a.Aa+this.m22*a.Ba+this.Ba;return b},apply:function(a,
b){return new E(this.m11*a+this.m12*b+this.Aa,this.m21*a+this.m22*b+this.Ba)},clone:function(){return new Q(this.m11,this.m12,this.m21,this.m22,this.Aa,this.Ba)},inverse:function(){var a=this.m11*this.m22-this.m12*this.m21;return new Q(this.m22/a,-this.m12/a,-this.m21/a,this.m11/a,(this.m12*this.Ba-this.Aa*this.m22)/a,(this.Aa*this.m21-this.m11*this.Ba)/a)}};function dd(a,b){b.transform(a.m11,a.m21,a.m12,a.m22,a.Aa,a.Ba)}
function ed(a){return 1===a.m11&&0===a.m12&&0===a.m21&&1===a.m22&&0===a.Aa&&0===a.Ba}function fd(a,b,c,d){void 0===c?(this.m11=a,this.m21=this.m12=0,this.m22=b,this.aa=this.$=this.Ba=this.Aa=0):(this.m11=a,this.m21=this.m12=0,this.m22=b,this.Aa=c-a*c,this.Ba=d-b*d,this.$=c,this.aa=d);this.ba=a;this.ia=b}fd.prototype.inverse=function(){return new fd(1/this.ba,1/this.ia,this.$,this.aa)};Mc(Q.prototype,fd.prototype);
function gd(a,b,c){var d=Math.cos(a),e=Math.sin(a);this.m11=d;this.m12=e;this.m21=-e;this.m22=d;this.Aa=-b*d-c*e+b;this.Ba=b*e-c*d+c;this.$=a;this.x=b;this.y=c}gd.prototype.inverse=function(){return new gd(-this.$,this.x,this.y)};Mc(Q.prototype,gd.prototype);function id(a,b,c){var d=Math.cos(2*a),e=Math.sin(2*a);this.m11=d;this.m21=this.m12=e;this.m22=-d;this.Aa=-b*d-c*e+b;this.Ba=-b*e+c*d+c;this.$=a;this.x=b;this.y=c}id.prototype.inverse=function(){return new id(-this.$,this.x,this.y)};
Mc(Q.prototype,id.prototype);function H(a,b){this.m11=1;this.m21=this.m12=0;this.m22=1;this.Aa=a;this.Ba=b}H.prototype.inverse=function(){return new H(-this.Aa,-this.Ba)};Mc(Q.prototype,H.prototype);
function jd(a,b,c,d,e,f,g,h,l,k){if(!(8<++kd)){var n=(b+d)/2,q=(c+e)/2,r=(d+f)/2,t=(e+g)/2,v=(f+h)/2,w=(g+l)/2,z=(n+r)/2,pa=(q+t)/2,r=(r+v)/2,t=(t+w)/2,Yc=(z+r)/2,Zc=(pa+t)/2,hc=h-b,ic=l-c;d=Math.abs((d-h)*ic-(e-l)*hc);f=Math.abs((f-h)*ic-(g-l)*hc);(d+f)*(d+f)<k*(hc*hc+ic*ic)?a.push(new E(Yc,Zc)):(jd(a,b,c,n,q,z,pa,Yc,Zc,k),jd(a,Yc,Zc,r,t,v,w,h,l,k))}--kd}var kd=0;
function ld(a,b,c,d,e,f,g,h){if(!(8<++kd)){var l=(b+d)/2,k=(c+e)/2,n=(d+f)/2,q=(e+g)/2,r=(l+n)/2,t=(k+q)/2,v=f-b,w=g-c;d=Math.abs((d-f)*w-(e-g)*v);d*d<=h*(v*v+w*w)?a.push(new E(r,t)):(ld(a,b,c,l,k,r,t,h),ld(a,r,t,n,q,f,g,h))}--kd}function md(a,b,c){var d,e,f,g,h,l,k,n,q=0;if(3>a.length)return 0;f=a[a.length-1].x;g=a[a.length-1].y;for(n=0;n<a.length;n++)d=a[n].x,e=a[n].y,d>f?(h=f,k=d,l=g,g=e):(h=d,k=f,l=e),d<b===b<=f&&(c-l)*(k-h)<(g-l)*(b-h)&&(q=!q),f=d,g=e;return q}
function nd(a){this.closed=!1;this.ga=[];a instanceof P&&(this.moveTo(a.x,a.y),this.lineTo(a.x+a.width,a.y),this.lineTo(a.x+a.width,a.y+a.height),this.lineTo(a.x,a.y+a.height),this.lineTo(a.x,a.y),this.close())}var Ab=0,Bb=1,Db=4,Eb=[3,3,7,5,1],od=[1,1,3,2,0];
nd.prototype={moveTo:function(a,b){this.ga.push(Ab,a,b)},lineTo:function(a,b){this.ga.push(Bb,a,b)},bezierCurveTo:function(a,b,c,d,e,f){this.ga.push(2,a,b,c,d,e,f)},quadraticCurveTo:function(a,b,c,d){this.ga.push(3,a,b,c,d)},close:function(){this.ga.push(Db)},ma:function(a){for(var b=0;b<this.ga.length;){switch(this.ga[b]){case Ab:a.moveTo(this.ga[b+1],this.ga[b+2]);break;case Bb:a.lineTo(this.ga[b+1],this.ga[b+2]);break;case 2:a.bezierCurveTo(this.ga[b+1],this.ga[b+2],this.ga[b+3],this.ga[b+4],this.ga[b+
5],this.ga[b+6]);break;case 3:a.quadraticCurveTo(this.ga[b+1],this.ga[b+2],this.ga[b+3],this.ga[b+4]);break;case Db:a.closePath();break;default:alert("Error!")}b+=Eb[this.ga[b]]}},transform:function(a){for(var b=0,c,d;b<this.ga.length;){d=od[this.ga[b]];for(c=0;c<d;c++){var e=a.apply(this.ga[b+1+2*c],this.ga[b+1+2*c+1]);this.ga[b+1+2*c]=e.x;this.ga[b+1+2*c+1]=e.y}b+=Eb[this.ga[b]]}},clone:function(){var a=new nd;a.ga=this.ga.concat();return a},append:function(a){this.ga=this.ga.concat(a.ga)}};
function yb(a){function b(a,b){f-=(a-d)*(b+e);d=a;e=b}for(var c=0,d,e,f=0;c<a.ga.length;){switch(a.ga[c]){case Ab:d=a.ga[c+1];e=a.ga[c+2];break;case Bb:b(a.ga[c+1],a.ga[c+2]);break;case 2:b(a.ga[c+5],a.ga[c+6]);break;case 3:b(a.ga[c+3],a.ga[c+4])}c+=Eb[a.ga[c]]}return f/2}
function pd(a,b,c){for(var d=0,e=0,f=c[0],g,h=new E(0,0),l;d<a.ga.length;){switch(a.ga[d]){case Ab:l=a.ga[d+1];g=a.ga[d+2];b.moveTo(l,g);h=new E(l,g);break;case Bb:l=a.ga[d+1];var k=g=a.ga[d+2],n=new E(l,k);g=h.kb(n);if(!(0>=g)){for(;g>f;)h.x+=(n.x-h.x)*f/g,h.y+=(n.y-h.y)*f/g,e&1?b.moveTo(h.x,h.y):b.lineTo(h.x,h.y),g-=f,e=(e+1)%c.length,f=c[e];g<=f&&(h=new E(l,k),e&1?b.moveTo(h.x,h.y):b.lineTo(h.x,h.y),f-=g)}}d+=Eb[a.ga[d]]}}
function qd(a,b){for(var c=0,d,e,f=new P(a.ga[1],a.ga[2],0,0),g;c<a.ga.length;){switch(a.ga[c]){case Ab:case Bb:d=a.ga[c+1];e=a.ga[c+2];bd(f,d,e);break;case 2:var h=g=[],l=a.ga[c+5],k=a.ga[c+6];d!==l&&e!==k&&jd(h,d,e,a.ga[c+1],a.ga[c+2],a.ga[c+3],a.ga[c+4],l,k,b*b);h.push(new E(l,k));for(d=0;d<g.length;d++)bd(f,g[d].x,g[d].y);d=a.ga[c+5];e=a.ga[c+6];break;case 3:h=g=[];l=a.ga[c+3];k=a.ga[c+4];d!==l&&e!==k&&ld(h,d,e,a.ga[c+1],a.ga[c+2],l,k,b*b);h.push(new E(l,k));for(d=0;d<g.length;d++)bd(f,g[d].x,
g[d].y);d=a.ga[c+3];e=a.ga[c+4]}c+=Eb[a.ga[c]]}return f}function rd(a){for(var b=0,c,d=[];b<a.ga.length;){var e=od[a.ga[b]];for(c=0;c<e;c++)d.push(new E(a.ga[b+1+2*c],a.ga[b+1+2*c+1]));b+=Eb[a.ga[b]]}return d}
function sd(a,b,c,d,e){var f;if(2>=d-c)e.push(a[c]);else{var g=a[c],h=a[d-1],l=0,k=0;for(f=c+1;f<d;f++){var n,q=a[f],r=g.x;n=g.y;var t=q.x,q=q.y,v=h.x-r,w=h.y-n,z=((t-r)*v+(q-n)*w)/(v*v+w*w);1<z?z=1:0>z&&(z=0);r=r+z*v-t;n=n+z*w-q;n=Math.sqrt(r*r+n*n);n>l&&(l=n,k=f)}0<k&&l>b?(sd(a,b,c,k,e),sd(a,b,k,d,e)):e.push(g)}}function td(a,b){var c=[];sd(a,b,0,a.length,c);0<a.length&&0<c.length&&!a[a.length-1].ac(c[c.length-1])&&c.push(a[a.length-1]);return c}
function ud(a){this.qa=[];if(1===arguments.length){var b=arguments[0];if(b instanceof P)this.qa.push(new E(b.x,b.y)),this.qa.push(new E(b.right(),b.y)),this.qa.push(new E(b.right(),b.bottom())),this.qa.push(new E(b.x,b.bottom()));else if(b instanceof Array)this.qa=b;else throw alert("Bad parameter passed to Polygon() constructor."),"Error";}}
ud.prototype={transform:function(a){for(var b=0;b<this.qa.length;b++)this.qa[b]=a.apply(this.qa[b].x,this.qa[b].y)},add:function(a,b){this.qa.push(new E(a,b))},Qb:function(a,b){return md(this.qa,a,b)},clone:function(){return new ud(this.qa.slice(0))},ac:function(a){if(this.qa.length!==a.qa.length)return!1;for(var b=0;b<this.qa.length;b++){var c=this.qa[b],d=a.qa[b];if(c.x!==d.x||c.y!==d.y)return!1}return!0},Mb:function(a){for(var b=[],c=0;c<this.qa.length;c++){var d=this.qa[0===c?this.qa.length-1:
c-1],e=this.qa[c],f=this.qa[c===this.qa.length-1?0:c+1],g=rb(d.x,d.y,e.x,e.y),h=rb(f.x,f.y,e.x,e.y);b.push({x:e.x+((e.x-d.x)/g+(e.x-f.x)/h)/Math.sqrt(2)*a,y:e.y+((e.y-d.y)/g+(e.y-f.y)/h)/Math.sqrt(2)*a})}this.qa=b},ma:function(a){if(!(1>this.qa.length)){a.moveTo(this.qa[0].x,this.qa[0].y);for(var b=1;b<this.qa.length;b++)a.lineTo(this.qa[b].x,this.qa[b].y);a.closePath()}}};
function vd(a,b){function c(a){var b,c,h,l,k;b=[];c=h=0;for(l=a.length;c<l;c++)k=a[c],a[h+1]&&(b[h]=d(k,a[h+1])),h+=1;return b}function d(a,b){return new E(a.x+(b.x-a.x)/2,a.y+(b.y-a.y)/2)}return b?vd(c(c(function(a){var b,c,h,l,k;a=[a[0]].concat(a).concat(a[a.length-1]);k=[];b=c=0;for(h=a.length;b<h;b++)l=a[b],k[2*c]=l,a[c+1]&&(k[2*c+1]=d(l,a[c+1])),c+=1;return k}(a))),b-1):a};function wd(a,b){xd(this,a,b)}
function xd(a,b,c){M.call(a);a.Ra=!0;a.id=b;a.canvas=jc(document.body);a.canvas.style.position="absolute";a.canvas.style.border="none";a.na=a.canvas.getContext("2d");a.Lb=c;a.width=32;a.height=500;a.canvas.width=a.width;a.canvas.height=a.height;p(a.canvas).bind("click",function(b){a.pb(b)});p(a.canvas).bind("mousedown",function(b){a.Ia(b)});p(document.body).bind("mousemove",function(b){a.La(b)});p(document.body).bind("mouseup",function(b){a.Ma(b)});p(a.canvas).bind("touchstart",function(b){a.Ua(b)});
p(document.body).bind("touchmove",function(b){a.Ua(b)});p(document.body).bind("touchend",function(b){a.Ua(b)});a.$=null;a.Oa=!1;a.ta="#c0c0c0";a.oa="#808080";a.borderWidth=1;a.ia=0;a.ba=100;a.la=10;a.position=5;a.format()}m=wd.prototype;m.log=A("SCROLLBAR",!0);m.moveTo=function(a,b){this.canvas.style.left=""+a+"px";this.canvas.style.top=""+b+"px"};function yd(a,b,c){a.width=b;a.height=c;a.canvas.width=a.width;a.canvas.height=c;a.format();a.ma()}m.Ka=function(){this.canvas.style.display="none"};
m.show=function(){this.canvas.style.display="block"};m.format=function(){var a;a=this.Lb?this.width:this.height;var b=this.la/this.ba*a;a=(this.position-this.ia)/this.ba*a;this.$=this.Lb?new P(a,0,b-1,this.height-1):new P(0,a,this.width-1,b-1);this.$.x=Math.round(this.$.x)+.5;this.$.y=Math.round(this.$.y)+.5;this.$.width=Math.round(this.$.width);this.$.height=Math.round(this.$.height)};
m.ma=function(){this.na.beginPath();this.na.fillStyle=this.ta;this.na.strokeStyle=this.oa;this.na.lineWidth=this.borderWidth;this.na.rect(this.borderWidth/2,this.borderWidth/2,this.width-this.borderWidth,this.height-this.borderWidth);this.na.fill();this.na.stroke();this.na.beginPath();this.na.fillStyle=this.oa;this.na.strokeStyle="#000000";this.na.rect(this.$.x,this.$.y,this.$.width,this.$.height);this.na.fill();this.na.stroke()};
function zd(a,b){var c=p(a.canvas).offset();if("touchstart"===b.type||"touchend"===b.type||"touchmove"===b.type)b=b.changedTouches[0];return new E(b.pageX-c.left,b.pageY-c.top)}m.Ua=function(a){switch(a.type){case "touchstart":this.Ia(a);break;case "touchend":this.Ma(a);break;case "touchmove":this.La(a)}};m.pb=function(){};function Ad(a,b){var c;c=a.Lb?b.x/a.width*a.ba+a.ia:b.y/a.height*a.ba+a.ia;c=Math.min(c,a.ba-a.la+a.ia);return c=Math.max(c,a.ia)}
m.Ia=function(a){a.preventDefault();a=zd(this,a);this.$.Qb(a.x,a.y)?this.Lb?(this.offset=a.x-this.$.x,a.x-=this.offset):(this.offset=a.y-this.$.y,a.y-=this.offset):(this.position=Ad(this,a),this.offset=0,this.Lb?this.$.x=(this.position-this.ia)/this.ba*this.width:this.$.y=(this.position-this.ia)/this.ba*this.height,this.emit("scroll",this.position),this.ma());this.Oa=!0};
m.La=function(a){this.Oa&&(this.Oa&&"mousemove"===a.type&&("buttons"in a&&0===a.buttons||0===a.which)?this.Oa=!1:(a.preventDefault(),a=zd(this,a),this.Lb?a.x-=this.offset:a.y-=this.offset,this.position=Ad(this,a),this.emit("scroll",this.position),this.format(),this.ma()))};m.Ma=function(){this.Oa&&(this.Oa=!1)};function Bd(a){return a.Lb?a.height:a.width}wd.prototype=p.$({},M.prototype,wd.prototype);function Cd(a,b,c,d,e){this.view=a;this.$=b;this.ta=c;this.view.Kc=this.$ instanceof Dd;this.oa=!1;this.Ia(d,e)}function Ed(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].id);return b}
Cd.prototype={log:A("TransformSelectionBehaviour"),Ua:function(a){var b;if(!this.oa){for(b=0;b<a.touches.length;){b=a.touches[b];b=C(this.view,b.pageX,b.pageY);"touchmove"===a.type&&this.La(b.x,b.y,a);break}for(b=0;b<a.changedTouches.length;){b=a.changedTouches[b];b=C(this.view,b.pageX,b.pageY);"touchend"===a.type&&this.Ma(b.x,b.y,a);break}}},nc:function(a){this.log("%s scale=%s rotation=%s",a.type,a.scale,a.rotation);this.oa=!0;var b=this.la.x+this.la.width/2,c=this.la.y+this.la.height/2,d=a.scale;
this.view.vb||(d=1);var e=-a.rotation/180*Math.PI;if(0<this.view.ea.get("snap"))var f=Math.PI/16,e=Math.floor(e/f)*f;b=(new fd(d,d,b,c)).multiply(new gd(e,b,c));c=b.inverse();for(d=0;d<this.za.length;d++)Fd(this.za[d],b.multiply(this.ia[d]),this.ba[d].multiply(c)),this.za[d].format(this.view.na,this.view.request);this.view.ec=b;this.view.ma();if("gestureend"===a.type){for(d=0;d<this.za.length;d++)Fd(this.za[d],this.ia[d],this.ba[d]);this.view.ya([new R(Ed(this.za),b,b.inverse())]);Gd(this)}},Ia:function(a,
b){this.log("onMouseDown(%s,%s)",a,b);this.aa=this.view.Sa(new E(a,b));var c=this.za=Hd(this.view);this.ia=[];this.ba=[];for(var d=0;d<c.length;d++)this.ia.push(S(c[d])),this.ba.push(Id(c[d]));this.la=new P(this.view.ba.x,this.view.ba.y,this.view.ba.width,this.view.ba.height)},La:function(a,b){var c=this,d=this.view.Sa(new E(a,b));a=d.x;b=d.y;for(var d=this.$.wc(new E(d.x-this.aa.x,d.y-this.aa.y)),e=d.inverse(),f=0;f<this.za.length;f++)Fd(this.za[f],d.multiply(this.ia[f]),this.ba[f].multiply(e)),
this.za[f].format(this.view.na,this.view.request);this.view.ec=d;this.view.ma(function(){if(c.$ instanceof Dd){var d=c.view.na;d.save();d.beginPath();d.strokeStyle="#0050B7";d.lineWidth=1/c.view.scale;d.moveTo(c.$.origin.x,c.$.origin.y);d.lineTo(a,b);d.stroke();d.restore()}})},Ma:function(a,b){this.log("onMouseUp(%s,%s)",a,b);var c=this.view.Sa(new E(a,b));a=c.x;b=c.y;if(c.ac(this.aa))this.ta?(c=this.view.ja.cb(a,b,this.view.Ha))&&c.ad()&&(this.log("Didn't move, and has edit mode. Selecting node %s",
c.id),this.view.Wa(),this.view.Ca=c):this.log("Didn't move, but toggleEditNode=false");else{for(var c=this.$.wc(new E(c.x-this.aa.x,c.y-this.aa.y)),d=0;d<this.za.length;d++)Fd(this.za[d],this.ia[d],this.ba[d]);this.view.ya([new R(Ed(this.za),c,c.inverse())])}Gd(this)},dc:function(){this.log("onDoubleClick")}};function Gd(a){var b=new Q;a.view.ec=b;a.view.Kc=!0;Jd(a.view);a.view.update(!0);I(a.view)};var Kd=A("FitCurve");
function Ld(a){function b(a){z.bezierCurveTo(a[1].x,a[1].y,a[2].x,a[2].y,a[3].x,a[3].y);Kd("Bezier: (%s,%s), (%s,%s), (%s,%s), (%s,%s)",a[0].x,a[0].y,a[1].x,a[1].y,a[2].x,a[2].y,a[3].x,a[3].y)}function c(a,b){return a.x*b.x+a.y*b.y}function d(a){var b=1-a;return 3*a*b*b}function e(a){return 3*a*a*(1-a)}function f(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)}function g(a){return a.x*a.x+a.y*a.y}function h(a,b){var c=Math.sqrt(g(a));0!==c&&(a.x*=b/c,a.y*=b/c);return a}function l(a,b,c){void 0===
c&&Kd("Undef!");c.x=a.x+b.x;c.y=a.y+b.y}function k(a,b){return{x:a.x+b.x,y:a.y+b.y}}function n(a,b){return{x:a.x*b,y:a.y*b}}function q(a,b){return{x:a.x-b.x,y:a.y-b.y}}function r(a,b,g,r,t){var v,w=[],z,B=[[],[]],N=[],ea,U;U=[{},{},{},{}];z=b-0+1;for(v=0;v<z;v++){ea={x:r.x,y:r.y};var fa={x:t.x,y:t.y};h(ea,d(g[v]));h(fa,e(g[v]));w[v]=[ea,fa]}B[0][0]=0;B[0][1]=0;B[1][0]=0;B[1][1]=0;N[0]=0;for(v=N[1]=0;v<z;v++)B[0][0]+=c(w[v][0],w[v][0]),B[0][1]+=c(w[v][0],w[v][1]),B[1][0]=B[0][1],B[1][1]+=c(w[v][1],
w[v][1]),ea=1-g[v],fa=g[v],ea=q(a[0+v],k(n(a[0],ea*ea*ea),k(n(a[0],d(g[v])),k(n(a[b],e(g[v])),n(a[b],fa*fa*fa))))),N[0]+=c(w[v][0],ea),N[1]+=c(w[v][1],ea);g=B[0][0]*B[1][1]-B[1][0]*B[0][1];v=B[0][0]*N[1]-B[0][1]*N[0];N=N[0]*B[1][1]-N[1]*B[0][1];0===g&&(g=B[0][0]*B[1][1]*1E-11);B=N/g;N=v/g;if(0>B||0>N)return B=f(a[b],a[0])/3,U[0]=a[0],U[3]=a[b],l(U[0],h(r,B),U[1]),l(U[3],h(t,B),U[2]),U;U[0]=a[0];U[3]=a[b];l(U[0],h(r,B),U[1]);l(U[3],h(t,N),U[2]);return U}function t(a,b,c){var d,e;e=[];for(d=0;d<=a;d++)e[d]=
{x:b[d].x,y:b[d].y};for(d=1;d<=a;d++)for(b=0;b<=a-d;b++)e[b].x=(1-c)*e[b].x+c*e[b+1].x,e[b].y=(1-c)*e[b].y+c*e[b+1].y;return e[0]}function v(a){var b=Math.sqrt(Math.sqrt(g(a)));0!==b&&(a.x/=b,a.y/=b);return a}function w(a,b,c,d){var e,f,h,k=(b-0+1)/2;f=0;for(e=1;e<b;e++)h=t(3,c,d[e-0]),h=q(h,a[e]),h=g(h),h>=f&&(f=h,k=e);return{vf:f,mg:k}}var z=new nd;z.moveTo(a[0].x,a[0].y);(function(a,c,d){var e;e=q(a[1],a[0]);e=v(e);var g=c-1,g=q(a[g-1],a[g]),g=v(g);a:{c=c-1;var k,n;k=[{},{},{},{}];if(2===c-0+1)d=
f(a[c],a[0])/3,k[0]=a[0],k[3]=a[c],l(k[0],h(e,d),k[1]),l(k[3],h(g,d),k[2]),b(k);else{var z=[0];for(n=1;n<=c;n++)z[n-0]=z[n-0-1]+f(a[n],a[n-1]);for(n=1;n<=c;n++)z[n-0]/=z[c-0];k=r(a,c,z,e,g);n=w(a,c,k,z).vf;if(n<d)b(k);else for(;;){d=a;n=c;for(var B=void 0,N=[],N=[],B=0;B<=n;B++){for(var ea=N,U=B-0,fa=k,mc=d[B],nc=z[B-0],ya=[],oc=[],zb=void 0,D=void 0,hd=void 0,D=void 0,zb=t(3,fa,nc),D=0;2>=D;D++)ya[D]={},ya[D].x=3*(fa[D+1].x-fa[D].x),ya[D].y=3*(fa[D+1].y-fa[D].y);for(D=0;1>=D;D++)oc[D]={},oc[D].x=
2*(ya[D+1].x-ya[D].x),oc[D].y=2*(ya[D+1].y-ya[D].y);D=t(2,ya,nc);hd=t(1,oc,nc);ea[U]=nc-((zb.x-mc.x)*D.x+(zb.y-mc.y)*D.y)/(D.x*D.x+D.y*D.y+(zb.x-mc.x)*hd.x+(zb.y-mc.y)*hd.y)}d=N;k=r(a,c,d,e,g);w(a,c,k,d);b(k);break a}}}})(a,a.length,25);return z};function Md(a,b,c,d,e,f){var g=this;this.view=a;this.nodeType=b;this.fa=c;this.width=d;this.height=e;this.$=f;this.state="initial";this.node=this.aa=null;this.ba=function(){};"rectangle-tl"===f&&(this.ba=function(a){a.lineWidth=1/g.view.scale;a.strokeStyle="#ccc";a.beginPath();a.rect(g.start.x,g.start.y,g.end.x-g.start.x,g.end.y-g.start.y);a.stroke()})}
Md.prototype={log:A("DrawShape"),Bb:function(){this.log("Entering DrawShapeBehaviour");this.view.canvas.style.cursor="crosshair"},Fb:function(){this.log("Leaving DrawShapeBehaviour");this.node&&(this.view.ja.removeNode(this.node),this.view.update(),this.node=null)},ob:function(a){"cancel"===a&&I(this.view)},Ua:function(a){var b;"touchstart"===a.type?(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),this.Ia(b.x,b.y)):"touchmove"===a.type?(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),this.La(b.x,
b.y,a)):"touchend"===a.type&&(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),this.Ma(b.x,b.y,a))},Ia:function(a,b){"initial"===this.state&&(this.start=this.view.Sa(new E(a,b)),this.state="predraw",this.log("initial -> predraw"))},La:function(a,b,c){a=this.view.Sa(new E(a,b));"predraw"===this.state&&10<this.start.kb(a)&&(Nd(this),this.state="drawing",this.log("predraw -> drawing"));"drawing"===this.state&&(this.transform(this.start,a,c.ctrlKey),this.end=a,this.view.update(!1,this.ba))},Ma:function(a,
b,c){"predraw"===this.state?(Nd(this),this.transform(this.start,null,c.ctrlKey),this.ya(),this.view.ea.get("autoPickTool")&&I(this.view),this.state="initial"):"drawing"===this.state&&(this.transform(this.start,this.view.Sa(new E(a,b)),c.ctrlKey),this.ya(),this.view.ea.get("autoPickTool")&&I(this.view),this.state="initial")},transform:function(a,b,c){var d,e;if(b)if("circle"===this.$)d=a,a=a.kb(b),e=2*a/this.width,a=2*a/this.height;else if("rectangle-tl"===this.$)a=a.clone(),b=b.clone(),a.x>b.x&&(e=
a.x,a.x=b.x,b.x=e),a.y>b.y&&(e=a.y,a.y=b.y,b.y=e),d=a,e=(b.x-a.x)/this.width,a=(b.y-a.y)/this.height;else{e=[a,b];if(0===e.length)d=new E(0,0);else{d=e[0].x;for(var f=e[0].y,g=1;g<e.length;g++)d+=e[g].x,f+=e[g].y;d=new E(d/e.length,f/e.length)}e=(b.x-a.x)/this.width;a=(b.y-a.y)/this.height}else d=a,a=e=1;c&&(a=e=Math.min(e,a));c=new H(d.x,d.y);c=c.multiply(new fd(e,a));Fd(this.node,c,c.inverse());Od(this.view.ja,this.node.id)},ya:function(){this.fa.matrix=S(this.node);this.fa.inverse=Id(this.node);
this.view.ja.removeNode(this.node);this.node=null;this.view.ya([new G(this.nodeType,this.fa)])},wb:function(a){jb.prototype.wb.call(this,a);this.fa[a.Tc?"fillStyle":"strokeStyle"]=a.Qa},Nb:function(a,b){jb.prototype.Nb.call(this,a,b);var c=b?"fillStyle":"strokeStyle",d=sc(this.fa[c]);this.fa[c]=d},Kb:function(){return this.$}};function Nd(a){a.node=Pd(a.nodeType,a.view.ja.fb,a.view.ja);Qd(a.node,a.fa);Rd(a.view.ja,a.node)};function Sd(a){this.view=a;this.ba=!1;this.aa=this.$=null;this.la=a.ea.get("multilineText");this.ia="normal";a.ea.get("iPadNoScrollText")&&null!==navigator.userAgent.match(/iPad/i)&&(this.ia="top")}
Sd.prototype={log:A("Text"),Bb:function(){this.log("Entering text mode");this.view.canvas.style.cursor="text"},Fb:function(){this.ba&&Td(this);this.view.canvas.style.cursor="default";this.log("Leaving text mode");this.$&&(this.$.parentNode.removeChild(this.$),this.$=null)},Ua:function(a){for(var b=0;b<a.touches.length;b++){var c=a.touches[b],c=C(this.view,c.pageX,c.pageY);"touchstart"===a.type&&this.Ia(c.x,c.y,a)}},Ia:function(a,b){if(this.ba&&(this.log("Editing somewhere else on mousedown; submit that first."),
Td(this),this.view.ea.get("autoPickTool"))){I(this.view);return}var c=this.view.ja.cb(a,b,this.view.Ha);Ud(this,c,a,b)},La:function(){},ob:function(a){this.log("keyboard: %s",a);"cancel"===a&&null===this.$&&(I(this.view),this.view.mb.emit("goto-toolbar"))},wb:function(a){this.log("Set text colour to %s",a.Qa);this.view.setProperty("textFillStyle",a.Qa)},Nb:function(a,b){Vd(this.view,a,b)},Kb:function(){return"text"}};
function Td(a){var b=a.$.value;Wd(a);if(a.Ca&&a.Ca.sa("text")===b)a.log("Text was not changed.");else if(null===a.Ca&&""===b)a.log("No text entered.");else if(a.Ca)a.log("Update text in node %s",a.Ca.id),a.view.ya([new Xd([a.Ca.id],"text",b)]);else{a.log("Create new text node.");var c=a.view.ja.fb,d=new H(a.aa.x,a.aa.y+a.view.ua.fontSize);a.view.ya([new G("TextNode",{text:b,fontSize:a.view.ua.fontSize,fontName:a.view.ua.fontName,bold:a.view.ua.bold,italic:a.view.ua.italic,textFillStyle:a.view.ua.textFillStyle,
strokeStyle:a.view.ua.textStrokeStyle,lineWidth:a.view.ua.textLineWidth,layer:a.view.Ha,wrap:a.view.ea.get("multilineText")}),new R([c],d,d.inverse())])}}function Wd(a){a.$&&(a.$.parentNode.removeChild(a.$),a.view.va.emit("edit-text-hidden"));a.$=null;a.ba=!1;a.Ca&&(a.Ca.Nc(!1),a.view.ma())}
function Ud(a,b,c,d){function e(){a.$&&(a.log("Set editBox height to %s",""+a.$.scrollHeight+"px"),a.$.style.height=""+a.$.scrollHeight+"px",a.$.style.width=""+a.$.scrollWidth+"px");n=null}var f,g,h,l,k=0;b&&"TextNode"===b.type()||b&&"PathNode"===b.type()&&a.view.ea.get("allowTextInShape")?(a.Ca=b,"top"!==a.ia&&"TextNode"===b.type()&&a.Ca.Nc(!0),a.view.ma(),a.aa=new E(b.rect.x,b.rect.y),f=b.sa("fontName"),g=b.sa("fontSize"),h=b.sa("bold"),l=b.sa("italic"),k=b.hb().width*a.view.scale,k=Math.max(k,
200)):(a.Ca=null,a.aa=new E(c,d),f=a.view.ua.fontName,g=a.view.ua.fontSize,h=a.view.ua.bold,l=a.view.ua.italic);a.$=document.createElement("textarea");b=p(a.$).height();k&&(a.$.style.width=""+k+"px");k=Yd(a.view,a.aa.x,a.aa.y);a.$.style.position="absolute";a.$.style.fontFamily=f;a.$.style.fontSize=""+g*a.view.scale+"px";a.$.style.overflow="auto";a.$.style.fontWeight=h?"bold":"normal";a.$.style.fontStyle=l?"italic":"normal";a.$.style.zIndex=a.view.lc()+1;"top"===a.ia?(f=p(a.view.canvas).offset(),g=
p(a.view.canvas).width(),k=p(a.$).width(),a.$.style.left=""+(f.left+g/2-k/2)+"px",a.$.style.top=""+f.top+"px"):(a.$.style.left=""+Math.round(k.x)+"px",a.$.style.top=""+Math.round(k.y)+"px");a.$.style.WebkitTransitionDuration="0";a.$.style.MozTransitionDuration="0";a.$.style.ba="0";a.$.style.aa="0";a.$.style.transitionDuration="0";document.body.appendChild(a.$);a.ba=!0;a.aa=new E(c,d+b);a.Ca&&(a.$.value=a.Ca.sa("text"));var n=null,n=setTimeout(e,0);p(a.$).bind("keydown",function(b){27===b.keyCode&&
a.la||13===b.keyCode&&(b.shiftKey||!a.la)?(a.log("Enter pressed. create text."),Td(a),a.view.Da.ab&&Zd(a.view),a.view.mb.uc("goto-canvas"),a.view.ea.get("autoPickTool")&&I(a.view)):27===b.keyCode?(a.log("ESC pressed; cancel."),Wd(a),I(a.view),a.view.mb.emit("goto-toolbar")):13===b.keyCode&&(n||(n=setTimeout(e,0)))});setTimeout(function(){a.$&&a.$.focus()},200);a.$.focus();a.view.va.emit("edit-text-shown",a.$)};function $d(a,b,c,d){this.node=a;this.wa=b;this.$=c;this.origin=d;a=this.wa.apply(c.x,c.y);this.x=a.x;this.y=a.y}$d.prototype={wc:function(a){var b=1,c=1,d=this.wa.inverse(),e=d.apply(this.x+a.x,this.y+a.y);a=new E(this.$.x-this.origin.x,this.$.y-this.origin.y);e=new E(e.x-this.origin.x,e.y-this.origin.y);e=(e.x*a.x+e.y*a.y)/(a.x*a.x+a.y*a.y);0!==a.x&&0!==a.y?c=b=e:0!==a.x?b=e:c=e;return this.wa.multiply(new fd(b,c,this.origin.x,this.origin.y)).multiply(d)}};
function Dd(a,b,c,d,e){this.node=a;this.wa=b;this.origin=this.wa.apply(d.x,d.y);a=this.wa.apply(c.x,c.y);this.x=a.x;this.y=a.y;this.aa=Math.atan2(this.y-this.origin.y,this.x-this.origin.x);this.$=e}Dd.prototype={log:A("RotationSelHandle"),wc:function(a){a=Math.atan2(this.y+a.y-this.origin.y,this.x+a.x-this.origin.x)-this.aa;if(this.$){var b=Math.PI/16;a=Math.floor(a/b)*b}return new gd(-a,this.origin.x,this.origin.y)}};function ae(a,b){this.node=a;this.wa=b;this.y=this.x=0}
ae.prototype={wc:function(a){return new H(a.x,a.y)}};function be(){}be.prototype={wc:function(){return new Q}};function ce(){this.text="";this.font="10px Arial";this.la="Arial";this.fontSize=10;this.$=[];this.rect=new P(0,0,0,this.fontSize);this.ba="left";this.aa="top";this.oa=this.ia=!1}m=ce.prototype;m.log=A("TextBox");function de(a,b,c){switch(b){case "left":case "centre":case "right":a.aa=b;break;case null:break;default:a.log("Unknnown alignment: %s",b)}switch(c){case "top":case "middle":case "bottom":a.ba=c;break;case null:break;default:a.log("Unknnown alignment: %s",c)}}
m.format=function(a,b,c){this.font=""+this.fontSize+'px "'+this.la+'"';this.ia&&(this.font="bold "+this.font);this.oa&&(this.font="italic "+this.font);this.$.length=0;var d,e;a.font=this.font;var f=0;this.rect.width=0;if(0===b){var g=this.text.split("\n");for(d=0;d<g.length;d++){var h=g[d];e=a.measureText(h).width;f+=this.fontSize;this.$.push({x:0,y:f,width:e,text:h});this.rect.width=Math.max(this.rect.width,e)}}else{var h=g=0,l=!1;for(d=0;d<this.text.length;d++){var k=this.text.charAt(d);e=a.measureText(this.text.substr(g,
d-g+1)).width;"\n"===k?l=!0:e>b?h?(d=h,l=!0):d>g&&(--d,l=!0):" "===k&&(h=d);l&&(e=" "===this.text.charAt(d)?a.measureText(this.text.substr(g,d-g)).width:a.measureText(this.text.substr(g,d-g+1)).width,f+=this.fontSize,this.$.push({x:0,y:f,width:e,text:this.text.substr(g,d-g+1)}),g=d+1,h=0,l=!1,this.rect.width=Math.max(this.rect.width,e))}e&&(f+=this.fontSize,this.$.push({x:0,y:f,width:e,text:this.text.substr(g,d-g)}),this.rect.width=Math.max(this.rect.width,e))}this.rect.x=0;this.rect.y=0;this.rect.height=
f;if("centre"===this.aa)for(d=0;d<this.$.length;d++)a=this.$[d],a.x=this.rect.width/2-a.width/2;else if("right"===this.aa)for(d=0;d<this.$.length;d++)a=this.$[d],a.x=this.rect.width-a.width;b&&"centre"===this.aa?this.rect.x=b/2-this.rect.width/2:b&&"right"===this.aa&&(this.rect.x=b-this.rect.width);c&&"middle"===this.ba?this.rect.y=c/2-this.rect.height/2:c&&"bottom"===this.ba&&(this.rect.y=c-this.rect.height)};m.ma=function(a,b,c){this.fillText(a,b,c)};
m.fillText=function(a,b,c){a.textBaseline="alphabetic";a.font=this.font;for(var d=0;d<this.$.length;d++){var e=this.$[d];a.fillText(e.text,this.rect.x+e.x+b,this.rect.y+e.y+c)}};m.strokeText=function(a,b,c){a.textBaseline="alphabetic";a.font=this.font;for(var d=0;d<this.$.length;d++){var e=this.$[d];a.strokeText(e.text,this.rect.x+e.x+b,this.rect.y+e.y+c)}};function ee(a,b){fe(this,a,b,ee)}var ge={fillStyle:"#cccccc",strokeStyle:"#000000",lineWidth:2,shadow:!1};
ee.prototype={log:A("BaseNode"),clip:function(){},ad:function(){return!1},yd:function(){return null},wd:function(){},xd:function(){return"text"in this.fa},clone:function(a){a=new this.constructor(a(),this.ja);Qd(a,he(this));return a},type:function(){return"BaseNode"},setProperty:function(a,b){if(a in this.fa||"tag"===a||"locked"===a||"lockSize"===a||"lockRotation"===a||"lockPosition"===a||"lockEditMode"===a||"rotationHandles"===a||"lockAspectRatio"===a)this.fa[a]=b},sa:function(a){return this.fa[a]},
hb:function(){return this.rect},Od:function(){return new ud(this.rect)},lc:function(){return this.sa("zIndex")||0},transform:function(a,b){this.fa.matrix=a.multiply(this.fa.matrix);this.fa.inverse=this.fa.inverse.multiply(b)},format:function(){},cb:function(a,b){var c=Id(this).apply(a,b);return this.oa||this.sa("locked")||!this.Eb.Qb(c.x,c.y)?null:this},Nc:function(a){this.oa=a},rc:function(){},Wd:function(){},Yd:function(){},ma:function(a){a.save();var b=this.fa.matrix;a.transform(b.m11,b.m21,b.m12,
b.m22,b.Aa,b.Ba);"erase"===this.fa.strokeStyle?(a.strokeStyle="#000000",a.globalCompositeOperation="destination-out"):a.strokeStyle=this.fa.strokeStyle;a.fillStyle=this.fa.fillStyle;a.lineWidth=this.fa.lineWidth;this.fa.shadow&&(a.shadowOffsetX=3,a.shadowOffsetY=3,a.shadowBlur=5,a.shadowColor="rgba(0,0,0,0.5)");this.ic(a);a.restore()},ic:function(){}};function Fd(a,b,c){a.fa.matrix=b;a.fa.inverse=c}function Id(a){return a.fa.inverse}function S(a){return a.fa.matrix}
function ie(a){return null!==a.parent&&null!==a.parent.parent&&"PageNode"!==a.parent.type()}function je(a){return void 0!==a.children}function ke(a){return(a=a.sa("layer"))?""+a:"default"}function Qd(a,b){for(var c in b)b.hasOwnProperty(c)&&a.setProperty(c,b[c])}function he(a){var b={},c;for(c in a.fa)a.fa.hasOwnProperty(c)&&(b[c]=a.sa(c));return b}function le(a,b){for(var c in b)b.hasOwnProperty(c)&&(a.fa[c]=b[c])}
function fe(a,b,c,d){a.id=b;a.ja=c;a.fa={};le(a,ge);a.rect=new P(0,0,1,1);a.fa.matrix=new Q;a.fa.inverse=new Q;a.fa.layer="default";a.parent=null;a.constructor=d;a.oa=!1;a.Eb=new P(0,0,1,1)}var me={};function ne(a,b,c){var d=[{},ee.prototype];c&&d.push(c.prototype);d.push(b.prototype);b.prototype=p.$.apply(null,d);me[a]=b}function Pd(a,b,c){return a in me?new me[a](b,c):null};function oe(a,b){fe(this,a,b,oe);this.parent=null;this.children=[]}m=oe.prototype;m.type=function(){return"GroupNode"};m.clone=function(a){for(var b=new oe(a(),this.ja),c=0;c<this.children.length;c++){var d=this.children[c].clone(a);d.parent=b;b.children.push(d)}return b};m.format=function(a,b){for(var c=0;c<this.children.length;c++)this.children[c].format(a,b),0===c?this.rect=this.children[c].rect.clone():cd(this.rect,this.children[c].rect)};m.ma=function(a){for(var b=0;b<this.children.length;b++)this.children[b].ma(a)};
m.cb=function(a,b){for(var c=this.children.length-1;0<=c;c--){var d=this.children[c].cb(a,b);if(d)return d}return null};function pe(a,b){for(var c=0;c<a.children.length;c++)if(b===a.children[c])return c;return-1}ne("GroupNode",oe);function qe(a,b){fe(this,a,b,qe);this.children=[]}qe.prototype={log:A("PAGE",!0),type:function(){return"PageNode"},format:function(){},cb:function(){return null},ma:function(){}};ne("PageNode",qe,oe);function re(a,b){fe(this,a,b,re);this.log("New BrushNode created.");this.fa.points=[];this.fa.strokeStyle="#ff00ff";this.fa.lineWidth=10;this.qa=[];this.ia=[];this.inverse=null}
re.prototype={log:A("BRUSH",!0),type:function(){return"BrushNode"},setProperty:function(a,b){"fillStyle"===a&&(a="strokeStyle");a in this.fa||"dashes"===a?this.fa[a]=b:ee.prototype.setProperty.call(this,a,b)},sa:function(a){"fillStyle"===a&&(a="strokeStyle");return ee.prototype.sa.call(this,a)},format:function(){var a,b,c,d;this.qa.length=0;b=this.fa.points;a=c=0;for(d=b.length-1;c<=d;a=c+=2)this.qa.push(new E(b[a],b[a+1]));a=$c(this.qa);this.Eb=a.clone();a.Mb(this.fa.lineWidth+3,this.fa.lineWidth+
3);a=new ud(a);a.transform(this.fa.matrix);this.rect=$c(a.qa);this.inverse=this.fa.matrix.inverse();this.ia=[];if("dashes"in this.fa)for(b=this.fa.dashes.split(","),a=0;a<b.length;a++)c=parseFloat(b[a]),isNaN(c)||this.ia.push(c)},cb:function(a,b){var c;if(this.rect.Qb(a,b)){c=this.inverse.apply(a,b);var d;a:{d=this.qa;var e=c.x;c=c.y;for(var f=this.fa.lineWidth/2,f=f*f,g=1;g<d.length;g++){var h=d[g-1].x,l=d[g-1].y,k=d[g].x-h,n=d[g].y-l,q=((e-h)*k+(c-l)*n)/(k*k+n*n);1<q?q=1:0>q&&(q=0);h=h+q*k-e;l=
l+q*n-c;if(h*h+l*l<=f){d=!0;break a}}d=!1}if(d)return this}return null},ic:function(a){var b,c,d,e;c=this.fa.points;if(0!==c.length){a.save();a.beginPath();a.lineCap="round";a.lineJoin="round";if(1<this.ia.length){if(b=this.qa,d=this.ia,0!==b.length){a.moveTo(b[0].x,b[0].y);e=0;for(var f=1,g=d[0],h=b[0].clone(),l;f<b.length;)l=h.kb(b[f]),0===l?f+=1:l<=g?(h=b[f].clone(),e&1?a.moveTo(h.x,h.y):a.lineTo(h.x,h.y),g-=l,f+=1):(h.x+=(b[f].x-h.x)*g/l,h.y+=(b[f].y-h.y)*g/l,e&1?a.moveTo(h.x,h.y):a.lineTo(h.x,
h.y),e=(e+1)%d.length,g=d[e])}}else for(a.moveTo(c[0],c[1]),b=d=2,e=c.length-1;d<=e;b=d+=2)a.lineTo(c[b],c[b+1]);a.stroke();if(se){a.beginPath();b=d=0;for(e=c.length-1;d<=e;b=d+=2)a.rect(c[b]-2,c[b+1]-2,4,4);a.fillStyle="#ff0000";a.fill()}a.restore()}}};var se=!1;ne("BrushNode",re);function te(a,b,c,d){this.zb=c;this.view=a;this.ba=d;this.Oa=!1;this.Td=!0;this.$=[];this.ia={}}
te.prototype={log:A("Brush"),Bb:function(){this.view.canvas.style.cursor="crosshair"},reset:function(){this.Oa=!1;this.$=[];this.ia={}},Mc:function(a){this.zb.strokeStyle=a},Ua:function(a){var b,c,d,e,f;if("touchstart"===a.type)for(f=a.changedTouches,d=0,e=f.length;d<e;d++)c=f[d],a=C(this.view,c.pageX,c.pageY),this.$.push([a]),c.identifier&&(this.ia[c.identifier]=this.$[this.$.length-1]);else if("touchmove"===a.type){f=a.changedTouches;d=0;for(e=f.length;d<e;d++){c=f[d];a=C(this.view,c.pageX,c.pageY);
if(c.identifier)c.identifier in this.ia?b=this.ia[c.identifier]:(b=[a],this.$.push(b),this.ia[c.identifier]=b);else{c=a;var g=b=void 0,h=void 0;b=null;for(h=0;h<this.$.length;h++){var l=this.$[h],k=l[l.length-1].kb(c);if(null===b||k<g)b=l,g=k}}b?a.x===b[b.length-1].x&&a.y===b[b.length-1].y||b.push(a):this.log("WARNING: Can't find path for touch!")}this.view.ma()}else"touchend"===a.type&&0===a.touches.length&&this.ya()},Ia:function(a,b){var c;c=this.view.Sa(new E(a,b));this.Oa=!0;this.$.push([c])},
Xd:function(a){var b,c,d,e,f,g,h,l=ue(this.view);"erase"===this.zb.strokeStyle?(a.strokeStyle="#000000",a.globalCompositeOperation="destination-out"):a.strokeStyle=this.zb.strokeStyle;a.lineCap="round";a.lineJoin="round";a.lineWidth=this.zb.lineWidth;a.beginPath();g=this.$;d=0;for(f=g.length;d<f;d++)for(c=g[d],a.moveTo(c[0].x,c[0].y),b=e=1,h=c.length-1;e<=h;b=e+=1)b=c[b],a.lineTo(b.x,b.y);a.stroke();a.globalCompositeOperation="source-over";l&&a.restore()},La:function(a,b){var c;"freehand"===this.ba?
c=new E(a,b):c=this.view.Sa(new E(a,b));this.Oa&&(this.aa=this.$[0][this.$[0].length-1],c.x!==this.aa.x||c.y!==this.aa.y)&&(this.$[0].push(c),this.view.ma())},Ma:function(a,b){this.La(a,b);this.Oa=!1;this.ya()},ya:function(){var a,b,c,d,e,f,g,h,l,k;a=[];l=this.$;var n=this.view.ja.fb;f=0;for(h=l.length;f<h;f++)if(e=l[f],"brush"===this.ba){if(c=[],1===e.length&&e.push(new E(e[0].x+.1,e[0].y+.1)),1<e.length){d=b=0;for(g=e.length-1;b<=g;d=b+=1)c.push(e[d].x),c.push(e[d].y);a.push(new G("BrushNode",p.$({points:c,
layer:this.view.Ha},this.zb)))}}else{if("shapebrush"===this.ba){e=td(e,20);c=e;g=k=b=e=k=d=void 0;if(!(3>c.length)){e=c[0];b=c[c.length-1];g=40>e.kb(b);for(d=0;d<c.length;d++){var q=c[d];for(k=d+1;k<c.length;k++){var r=c[k];20>Math.abs(q.x-r.x)?r.x=q.x:20>Math.abs(q.y-r.y)&&(r.y=q.y)}}q=ad($c(c));for(d=0;d<c.length;d++)k=c[d],20>Math.abs(k.x-q.x)&&(k.x=q.x),20>Math.abs(k.y-q.y)&&(k.y=q.y);g&&(e.x=b.x,e.y=b.y)}e=c}else if("freehand"===this.ba)c=e,c=td(c,2),c=vd(c,4),e=c=td(c,.5);else if("quadratic"===
this.ba){e=td(e,10);b=Ld(e);c=b.ga[1];d=b.ga[2];k=b.ga[4];g=b.ga[5];e=b.ga[8];b=b.ga[9];k=((3*k-c)/2+(3*k-e)/2)/2;g=((3*g-d)/2+(3*g-b)/2)/2;q=new nd;q.moveTo(c,d);q.quadraticCurveTo(k,g,e,b);e=q;c=new ve;d=0;for(e=e.ga;d<e.length;){switch(e[d]){case Ab:c.moveTo(e[d+1],e[d+2]);break;case Bb:c.lineTo(e[d+1],e[d+2]);break;case 2:b=c;g=e[d+1];k=e[d+2];var q=e[d+3],r=e[d+4],t=e[d+5],v=e[d+6];b.ga.push(4);b.ga.push(t);b.ga.push(v);b.ga.push(g);b.ga.push(k);b.ga.push(q);b.ga.push(r);break;case 3:b=c;g=e[d+
1];k=e[d+2];q=e[d+3];r=e[d+4];b.ga.push(2);b.ga.push(q);b.ga.push(r);b.ga.push(g);b.ga.push(k);break;case Db:c.close()}d+=Eb[e[d]]}c=c.ga;a.push(new G("PathNode",p.$({commands:c,fillStyle:this.view.Xa,sloppiness:0,layer:this.view.Ha},this.zb)));continue}1===e.length&&"freehand"===this.ba&&e.push(new E(e[0].x+.1,e[0].y+.1));if(1<e.length){c=new ve;c.moveTo(e[0].x,e[0].y);b=e[0].ac(e[e.length-1]);d=g=1;for(k=e.length-1;g<=k;d=g+=1)c.lineTo(e[d].x,e[d].y);b&&c.close();a.push(new G("PathNode",p.$({commands:c.Gb(),
fillStyle:this.view.Xa,sloppiness:0,layer:this.view.Ha},this.zb)))}}this.view.ya(a);this.view.Wa();f=T(this.view.ja,n);a.length&&"quadratic"===this.ba?(this.view.Ca=f,I(this.view)):this.view.ea.get("singleStrokeBrush")?(we(this.view,f),I(this.view)):this.reset();V(this.view)},Fb:function(){this.view.canvas.style.cursor="default";this.view.ma()},wb:function(a){this.zb.strokeStyle=a.Qa;var b;a.Tc?(this.view.Xa=a.Qa,this.view.gb=a.Qa,b="fillStyle"):(this.view.bb=a.Qa,b="strokeStyle");this.view.setProperty(b,
a.Qa)},Nb:function(a){this.view.gb=sc(this.view.gb,a);this.zb.strokeStyle=sc(this.zb.strokeStyle,a);this.view.Xa=this.view.gb},ob:function(a){this.log("keyboard: %s",a);"cancel"===a&&(this.log("ESC pressed. Abort brush and go back to toolbar."),I(this.view),this.view.mb.emit("goto-toolbar"))},Kb:function(){return"circle"===this.ba?"ellipse":this.ba}};function xe(a,b){fe(this,a,b,xe);this.$=null}
xe.prototype={log:A("CUSTOM"),type:function(){return"CustomNode"},setProperty:function(a,b){var c;null===this.$&&"type"===a&&(c=ye[b],this.$=new c);this.$&&this.$.setProperty?this.$.setProperty(a,b):ee.prototype.setProperty.call(this,a,b)},sa:function(a){return this.$&&this.$.setProperty?this.$.getProperty(a):ee.prototype.sa.call(this,a)},format:function(a){"format"in this.$?this.$.format(a):alert("Error: custom item must have a format(ctx) function");a=this.$.rect;this.rect=new P(a.x,a.y,a.width,
a.height)},ma:function(a){this.$.draw(a)}};ne("CustomNode",xe);function ze(a,b){fe(this,a,b,ze);this.fa.data="";this.fa.locked=!1;this.element=null;this.ia=void 0;this.ba=null;this.$=new Q;this.la=!1}
ze.prototype={log:A("DomNode",!0),type:function(){return"DomNode"},setProperty:function(a,b){if("data"===a)this.element&&(p(this.element).remove(),this.ia=this.element=null);else if("border"===a||"lockSize"===a||"lockRotate"===a){this.fa[a]=b;return}ee.prototype.setProperty.call(this,a,b)},be:function(a){this.log("Node %s receives DOM element and requests reformat",this.id);this.element=a;this.element.style.position="absolute";"IFRAME"!==a.tagName&&(this.element.style.pointerEvents="none");this.rc(this.la);
this.width=this.element.offsetWidth;this.height=this.element.offsetHeight;this.element.style.top="0px";this.element.style.left="0px";Ae(this,"transformOrigin","top left");this.aa.emit("reformat",this)},Nc:function(a){ee.prototype.Nc.call(this,a);this.element&&(this.element.style.visibility=this.oa?"hidden":"visible")},rc:function(a){this.la=a;this.element&&this.aa&&(a?Ta(p(this.element),p(this.aa.canvas)):ba(p(this.element),p(this.aa.canvas)))},format:function(a,b){null===this.element&&this.ia!==
this.sa("data")&&b&&(this.ia=this.sa("data"),this.aa=b,this.log("DomNode %s requests conversion to DOM element",this.id),this.aa.emit("convert-dom-request",this.ia,this.id));if(this.element){var c=this.$,c=c.multiply(S(this));1===c.m11&&1===c.m22&&0===c.m12&&0===c.m21?(Ae(this,"transform",""),this.element.style.left=""+c.Aa+"px",this.element.style.top=""+c.Ba+"px"):(this.element.style.left="0px",this.element.style.top="0px",Ae(this,"transform","matrix("+c.m11+","+c.m21+","+c.m12+","+c.m22+","+c.Aa+
","+c.Ba+")"));this.rect.x=0;this.rect.y=0;this.rect.width=this.width;this.rect.height=this.height;this.element.style.visibility=this.oa?"hidden":"visible"}else this.rect.x=0,this.rect.y=0,this.rect.width=100,this.rect.height=22;this.ba=new ud(this.rect);this.Eb=this.rect.clone();this.rect.transform(S(this));this.ba.transform(S(this));if(c=this.fa.border)this.rect.Mb(c),this.ta=this.ba.clone(),this.ta.Mb(c/2),this.ba.Mb(c)},ic:function(a){!a.Wb||a.Wb.m11===this.$.m11&&a.Wb.m21===this.$.m21&&a.Wb.m12===
this.$.m12&&a.Wb.m22===this.$.m22&&a.Wb.Aa===this.$.Aa&&a.Wb.Ba===this.$.Ba||(this.log("Moving DOM element as result of draw zooming"),this.$=a.Wb,this.format(a,null));if(this.element){var b=this.fa.border;if(b){var c=this.ta;a.setTransform(1,0,0,1,0,0);a.beginPath();a.lineWidth=b;a.strokeStyle="#cccccc";a.moveTo(c.qa[0].x,c.qa[0].y);a.lineTo(c.qa[1].x,c.qa[1].y);a.lineTo(c.qa[2].x,c.qa[2].y);a.lineTo(c.qa[3].x,c.qa[3].y);a.lineTo(c.qa[0].x,c.qa[0].y);a.closePath();a.stroke()}}else a.beginPath(),
a.lineWidth=1,a.fillStyle="#888888",a.strokeStyle="#CCCCCC",a.rect(0,0,100,22),a.stroke(),a.font="20px Arial",a.textBaseline="top",a.fillText("DomNode",0,0)},cb:function(a,b){return!this.fa.locked&&this.rect.Qb(a,b)&&this.ba.Qb(a,b,3)?this:null},Wd:function(){this.element&&ba(p(this.element),p(this.aa.canvas))},Yd:function(){this.log("Removed DOM NODE");this.element&&p(this.element).remove()}};
function Ae(a,b,c){for(var d=b.charAt(0).toUpperCase()+b.substr(1),e=["ms","Webkit","O","Moz"],f=0;f<e.length;f++)a.element.style[e[f]+d]=c;a.element.style[b]=c}ne("DomNode",ze);function Be(a,b){fe(this,a,b,Be);this.fa.url="";this.Pa=null;this.width=100;this.height=20;this.ia=new ud;this.ba=[];this.aa=new P(0,0,this.width,this.height);this.$=new P(0,0,this.width,this.height)}
Be.prototype={log:A("IMAGE",!0),type:function(){return"ImageNode"},setProperty:function(a,b){ee.prototype.setProperty.call(this,a,b);if("url"===a)this.Pa=null;else if("allowCrop"===a||"crop"===a)this.fa[a]=b},format:function(a,b){function c(a,b,c){k.ba.push({x:k.$.x+a*k.$.width,y:k.$.y+b*k.$.height,Lb:c})}var d,e,f,g,h,l=this;null===this.Pa&&"ImageSurface"in window?(this.Pa=new ImageSurface(this.fa.url),this.aa=new P(0,0,this.Pa.width,this.Pa.height)):null===this.Pa?(this.aa=new P(0,0,this.width,
this.height),b.add(this,"image",this.fa.url,null,function(a){l.log("Got image response.");l.Pa=a;return b.emit("reformat",l)})):this.aa=new P(0,0,this.Pa.width,this.Pa.height);this.$=Ce(this);this.rect=this.$.clone();if(d=this.sa("boundingPolygon")){f=[];e=g=0;for(h=d.length-1;g<=h;e=g+=2)f.push(new E(d[e],d[e+1]));this.ia=new ud(f)}else this.ia=new ud(this.rect);this.Eb=this.rect.clone();this.ia.transform(this.fa.matrix);this.rect.transform(this.fa.matrix);this.ba.length=0;var k=this;c(.5,0,!0);
c(1,.5,!1);c(.5,1,!0);c(0,.5,!1)},Od:function(){return this.ia},cb:function(a,b){return!this.fa.locked&&this.ia.Qb(a,b,3)?this:null},ic:function(a){var b,c,d,e,f=!1;if(this.Pa)try{if(a.drawImage(this.Pa,this.$.x,this.$.y,this.$.width,this.$.height,this.$.x,this.$.y,this.$.width,this.$.height),De){c=this.ia.qa;a.save();a.setTransform(1,0,0,1,0,0);a.beginPath();a.lineWidth=2;a.strokeStyle="#000000";a.moveTo(c[0].x,c[0].y);b=d=1;for(e=c.length-1;d<=e;b=d+=1)a.lineTo(c[b].x,c[b].y);a.closePath();a.stroke();
a.restore()}}catch(g){this.log("Error drawing image: %s",g.message),f=g}if(null===this.Pa||f)a.save(),a.lineWidth=1,a.strokeStyle="#cccccc",a.strokeRect(0,0,this.width,this.height),a.restore()},ad:function(){return!1!==this.sa("allowCrop")&&!0!==this.sa("lockEditMode")},wd:function(a,b){a.save();a.beginPath();a.lineWidth=1*b;a.strokeStyle="#0050B7";a.globalCompositeOperation="xor";for(var c=S(this),d=0;d<this.ba.length;d++){var e=this.ba[d],f=c.apply(e.x,e.y),g,h,l,k;e.Lb?(g=20,l=h=0,k=3,e=f.x-10,
f=f.y-6):(g=0,h=20,l=3,k=0,e=f.x-6,f=f.y-10);for(var n=0;5>n;n++)a.moveTo(e,f),a.lineTo(e+g*b,f+h*b),e+=l*b,f+=k*b}a.stroke();a.restore()},yd:function(a,b,c){var d=S(this);c=10*c;for(var e=0;e<this.ba.length;e++){var f=this.ba[e],f=d.apply(f.x,f.y);if(f.x-c<=a&&a<f.x+c&&f.y-c<=b&&b<f.y+c)return e}return null},Pd:function(a){a=this.ba[a];return S(this).apply(a.x,a.y)},zc:function(a,b,c){var d=Ce(this);b=Id(this).apply(b,c);0===a&&0<=b.y?(d.height-=b.y-d.y,d.y=b.y):1===a&&b.x<this.aa.width?d.width=
b.x-d.x:2===a&&b.y<this.aa.height?d.height=b.y-d.y:3===a&&0<=b.x&&(d.width-=b.x-d.x,d.x=b.x);d.x=Math.max(d.x,0);d.y=Math.max(d.y,0);d.width=Math.min(d.width,this.aa.width);d.height=Math.min(d.height,this.aa.height);d.width=Math.max(1,d.width);d.height=Math.max(1,d.height);this.fa.crop=[d.x,d.y,d.width,d.height].join()}};
function Ce(a){var b=a.fa.crop;a=new P(0,0,a.aa.width,a.aa.height);b&&(b=b.split(","),a.x=parseFloat(b[0])|0,a.y=parseFloat(b[1])|0,a.width=parseFloat(b[2])|0,a.height=parseFloat(b[3])|0);return a}var De=!1;ne("ImageNode",Be);function Ee(a,b){fe(this,a,b,Ee);this.aa="UnknownNode";this.width=100;this.height=20;this.$=new ce;de(this.$,"centre","middle")}
Ee.prototype={log:A("UNKNOWN",!0),type:function(){return this.aa},setProperty:function(a,b){this.fa[a]=b},format:function(a){this.log("Formatting placeholder for %s",this.aa);this.rect=new P(0,0,this.width,this.height);this.rect.transform(this.fa.matrix);this.$.format(a,this.width,this.height)},ic:function(a){this.log("Drawing placeholder for for %s",this.aa);a.save();a.lineWidth=1;a.fillStyle="#888888";a.fillRect(0,0,this.width,this.height);a.fillStyle="#000000";this.$.ma(a,0,0);a.restore()}};
ne("UnknownNode",Ee);function Fe(a,b){fe(this,a,b,Fe);le(this,Ge);this.fa.text="lorum ipsum dolor";this.$=new ce;this.Rd=0}
Fe.prototype={log:A("TEXT",!0),type:function(){return"TextNode"},setProperty:function(a,b){this.fa[a]=b;if("fontName"===a||"text"===a)this.path=null;"textFillStyle"===a?this.fa.fillStyle=b:"fillStyle"===a&&(this.fa.textFillStyle=b)},format:function(a){var b,c=this.$;b=this.fa.fontSize;var d=this.fa.bold,e=this.fa.italic;c.la=this.fa.fontName;c.fontSize=b;c.ia=d;c.oa=e;c=this.fa.text;c.length&&10===c.charCodeAt(c.length-1)&&(this.log("Lastchar=%s; remove trailing newline",c.charCodeAt(c.length-1)),
c=c.substr(0,c.length-1));this.$.text=c;b=this.fa.matrix;c=b.apply(0,0);b=b.apply(1,0);c=c.kb(b);de(this.$,this.fa.textAlign,"top");!0===this.sa("wrap")?(b=this.fa.baseWidth,void 0===b&&(this.$.format(a,0,0),b=Math.max(this.$.rect.width,10),500<b&&(b=500),this.fa.baseWidth=b,this.log("Formatting text for first time; baseWidth=%s",b)),c=Math.ceil(c*b),this.$.format(a,c,0),a=this.$.rect.height,this.Eb=new P(0,0,b,a)):(this.$.format(a,0,0),c=this.$.rect.width,a=this.$.rect.height,this.Eb=new P(0,-(0+
this.sa("fontSize")),c,a));a=new ud(this.Eb);a.transform(S(this));this.rect=$c(a.qa);this.Rd=this.rect.height;this.rect.height+=1.3*this.fa.fontSize;a=this.sa("lineWidth")+0;this.rect.Mb(a,a)},ma:function(a){if(0!==this.fa.text.length){a.save();if(this.sa("wrap")){var b;b=S(this);var c=b.m11,d=b.m21,e=b.m12,f=b.m22,g=Math.sqrt(c*c+d*d),h=Math.sqrt(e*e+f*f);b=new Q(c/g,e/h,d/g,f/h,b.Aa,b.Ba);dd(b,a)}else dd(S(this),a);a.strokeStyle=this.fa.strokeStyle;a.fillStyle=this.fa.fillStyle;a.lineWidth=this.fa.lineWidth;
b=0;this.fa.wrap||(b=-(0+this.sa("fontSize")));this.fa.shadow&&(a.shadowOffsetX=3,a.shadowOffsetY=3,a.shadowBlur=5,a.shadowColor="rgba(0,0,0,0.5)");0<this.fa.lineWidth&&this.$.strokeText(a,0,b);this.$.fillText(a,0,b);a.restore()}}};Fe.prototype=p.$({},ee.prototype,Fe.prototype);var Ge={textFillStyle:"#000000",fontName:"Arial",fontSize:20,lineWidth:0,fillStyle:"#000000",wrap:!1,textAlign:"left",bold:!1,italic:!1};ne("TextNode",Fe);function He(a,b){fe(this,a,b,He);le(this,Ie);this.fa.closed=!1;this.fa.commands=[];this.$=[];this.ta=0;this.fa.seed=0;this.aa=new Fe(0,b);this.aa.setProperty("text",this.fa.text);this.la=[];this.Ja=!1}
var Ie={strokeStyle:"#000000",fillStyle:"#ffffff",textFillStyle:"#000000",fontName:"Arial",fontSize:20,lineWidth:2,dashes:"",shapeWidth:0,smoothness:.3,sloppiness:0,shadow:!1,closed:!1,arrowSize:0,arrowXOffset:null,arrowStyle:"simple",doubleArrow:!1,text:"",roundRadius:0,wrap:!1,angleArcs:0},Je=[2,2,4,5,6,2,4,0];m=He.prototype;m.log=A("PATHNODE");m.moveTo=function(a,b){var c=this.fa.commands;c.push(0);c.push(a);c.push(b)};m.type=function(){return"PathNode"};m.xd=function(){return!0===this.fa.closed};
m.setProperty=function(a,b){ee.prototype.setProperty.apply(this,arguments);"fontName"===a||"fontSize"===a||"text"===a||"wrap"===a?this.aa.setProperty(a,b):"textFillStyle"===a?this.aa.setProperty("fillStyle",b):"spotHighlight"===a&&(this.fa.spotHighlight=!0)};m.Pd=function(a){for(var b=0,c=this.fa.commands,d=a/2|0,e=0;e<d|0;e++)b+=Je[c[b]]+1;a&1?(d=c[b+3],b=c[b+4]):(d=c[b+1],b=c[b+2]);this.log("getEditHandle(%s) = (%s, %s)",a,d,b);return S(this).apply(d,b)};
m.zc=function(a,b,c){for(var d=0,e=this.fa.commands,f=a/2|0,g=0;g<f;g++)d+=Je[e[d]]+1;f=this.fa.inverse.apply(b,c);a&1?(e[d+3]=f.x,e[d+4]=f.y):(e[d+1]=f.x,e[d+2]=f.y);if(0===a&&this.fa.closed){for(a=null;d<e.length;)f=Je[e[d]],2<=f&&(a=d),d+=f+1;a&&(d=a,f=this.fa.inverse.apply(b,c),e[d+1]=f.x,e[d+2]=f.y)}};
m.format=function(a,b){this.origin=null;this.$.length=0;for(var c=new E(0,0),d=this.fa.commands,e=null,f,g,h=this.fa.matrix,l=new Lc(this.fa.seed),k=0;k<d.length;){switch(d[k++]){case 0:c=h.apply(d[k++],d[k++]);this.$.push(new pb(0,c));null===this.origin&&(this.origin=c);break;case 1:c=h.apply(d[k++],d[k++]);this.$.push(new qb(e,c,l,this.fa.sloppiness,this.fa.roundRadius));break;case 2:c=h.apply(d[k++],d[k++]);e=h.apply(d[k++],d[k++]);this.$.push(new tb(0,e,c));break;case 3:c=h.apply(d[k++],d[k++]);
e=h.apply(d[k++],d[k++]);f=d[k++];this.$.push(new ub(0,e,c,f));break;case 4:c=h.apply(d[k++],d[k++]);f=h.apply(d[k++],d[k++]);g=h.apply(d[k++],d[k++]);this.$.push(new vb(e,f,g,c));break;case 5:c=h.apply(d[k++],d[k++]);this.$.push(new sb(e,c,this.fa.smoothness));break;case 6:c=h.apply(d[k++],d[k++]);f=h.apply(d[k++],d[k++]);this.$.push(new wb(e,f,c,l,this.fa.sloppiness));break;case 7:this.fa.closed=!0;break;default:k++}e=this.$[this.$.length-1]}this.fa.closed&&4<=this.$.length&&this.$[1].ed&&(this.$[1].ed(e),
e.ka=this.origin);this.ta=this.$.length;Ke(this,l);this.rect.x=this.origin.x;this.rect.y=this.origin.y;this.rect.width=0;this.rect.height=0;c=this.fa.dashes.split(",");this.ia=[];for(k=0;k<c.length;k++)d=parseFloat(c[k]),isNaN(d)||this.ia.push(d);k=this.ia.length?2:8;c=new nd;for(d=0;d<this.$.length;d++)this.$[d].ma(c);this.fa.closed&&c.close();f=e=d=0;for(h=new nd;d<c.ga.length;){switch(c.ga[d]){case Ab:e=c.ga[d+1];f=c.ga[d+2];h.moveTo(e,f);break;case Bb:e=c.ga[d+1];f=c.ga[d+2];h.lineTo(e,f);break;
case 2:g=l=[];var n=c.ga[d+5],q=c.ga[d+6];e!==n&&f!==q&&jd(g,e,f,c.ga[d+1],c.ga[d+2],c.ga[d+3],c.ga[d+4],n,q,k*k);g.push(new E(n,q));2===l.length&&1E-4>e*(l[0].y-l[1].y)+l[0].x*(l[1].y-f)+l[1].x*(f-l[0].y)&&(l[0]=l[1],l.length=1);for(e=0;e<l.length;e++)h.lineTo(l[e].x,l[e].y);e=c.ga[d+5];f=c.ga[d+6];break;case 3:g=l=[];n=c.ga[d+3];q=c.ga[d+4];e!==n&&f!==q&&ld(g,e,f,c.ga[d+1],c.ga[d+2],n,q,k*k);g.push(new E(n,q));for(e=0;e<l.length;e++)h.lineTo(l[e].x,l[e].y);e=c.ga[d+3];f=c.ga[d+4];break;case Db:h.close()}d+=
Eb[c.ga[d]]}this.ba=h;c=0+this.sa("shapeWidth");if(0<c){h=this.ba;this.log("ConvertToRects: width=%s",c);var d=0,h=h.ga,r,t;for(f=new nd;d<h.length;){this.log("cmd %s %s %s",h[d],h[d+1],h[d+2]);switch(h[d]){case Ab:r=h[d+1];t=h[d+2];break;case Bb:l=h[d+1],e=h[d+2],this.log("(%s,%s-%s,%s)",r,t,l,e),0<rb(r,t,l,e)&&(n=K(r,t,l,e),g=n.y*c/2,n=-n.x*c/2,f.moveTo(r+g,t+n),f.lineTo(l+g,e+n),f.lineTo(l-g,e-n),f.lineTo(r-g,t-n),f.close()),r=l,t=e}d+=Eb[h[d]]}this.ba=f}this.rect=qd(this.ba,k);r=this.rect.width-
2*(this.fa.lineWidth/2+1);t=this.fa.lineWidth;k=this.ba.clone();k.transform(Id(this));this.Eb=qd(k,3);this.Eb.Mb(2*t+1,2*t+1);this.rect.Mb(2*t+1,2*t+1);8>this.rect.width&&(this.rect.x+=this.rect.width/2-4,this.rect.width=8);8>this.rect.height&&(this.rect.y+=this.rect.height/2-4,this.rect.height=8);this.fa.closed&&(t=ad(this.rect),this.aa.setProperty("textAlign","centre"),this.aa.setProperty("baseWidth",r),this.aa.format(a,b),r=t.x-this.aa.rect.x-this.aa.rect.width/2,t=t.y-this.aa.rect.y-this.aa.Rd/
2,this.aa.transform(new H(r,t),new H(-r,-t)),this.aa.format(a,b));this.Ja=0===cc(this.fa.fillStyle).values[3];this.la.length=0;0<this.fa.angleArcs&&(this.la.push(new xb(this)),this.la[this.la.length-1].Tb=this.fa.angleArcs);for(k=0;k<this.la.length;k++)this.la[k].format(a)};m.$c=function(){return this.ba};
function Ke(a,b){function c(a,c){var h,q,r,t;h=a.x-c.x*f;q=a.y-c.y*f;r=h+c.y*e/2;t=q-c.x*e/2;h+=-c.y*e/2;q+=c.x*e/2;d.$.push(new pb(0,new E(h,q)));d.$.push(new sb(d.$[d.$.length-1],a,g));d.$.push(new sb(d.$[d.$.length-1],new E(r,t),g));"solid"===d.fa.arrowStyle&&d.$.push(new qb(d.$[d.$.length-1],new E(h,q),b,d.fa.smoothness,0))}a.Ra=0<a.fa.arrowSize&&!a.fa.closed&&0<a.$.length;if(a.Ra){var d=a,e=a.fa.arrowSize,f=a.fa.arrowXOffset,g=a.fa.smoothness;null===f&&(f=e);var h=a.$[a.$.length-1];c(h.ka,h.Sb());
a.fa.doubleArrow&&c(a.$[0].ka,Xc(a.$[1].sc()))}}m.close=function(){this.fa.commands.push(7)};m.clip=function(a){if(this.fa.closed){this.log("Clipping to a path");for(var b=0;b<this.$.length;b++)this.$[b].ma(a);a.closePath()}};
m.ic=function(a){if(!this.fa.spotHighlight){var b=this.fa.inverse;a.save();a.lineJoin="round";a.transform(b.m11,b.m21,b.m12,b.m22,b.Aa,b.Ba);a.beginPath();a.lineCap="round";for(b=0;b<this.$.length;b++)this.$[b].ma(a);this.fa.closed&&(a.closePath(),a.fill(),a.shadowColor="rgba(0,0,0,0.0)");this.ia.length&&0<this.fa.lineWidth?(a.beginPath(),pd(this.ba,a,this.ia),a.lineCap="butt"):0<0+this.sa("shapeWidth")&&(a.beginPath(),this.ba.ma(a));0<this.fa.lineWidth&&a.stroke();if(this.fa.arrowSize&&"solid"===
this.fa.arrowStyle){a.beginPath();for(b=this.ta;b<this.$.length;b++)this.$[b].ma(a);a.fillStyle=this.fa.strokeStyle;a.fill()}this.fa.closed&&this.aa.ma(a);for(b=0;b<this.la.length;b++)this.la[b].ma(a);a.restore()}};
m.cb=function(a,b){if(this.oa||this.sa("locked"))return null;var c=8+this.fa.shapeWidth/2+this.fa.lineWidth/2;if(a>=this.rect.x-c&&a<this.rect.x+c+this.rect.width&&b>=this.rect.y-c&&b<this.rect.y+c+this.rect.height)if(this.fa.closed&&!this.Ja){if(md(rd(this.ba),a,b))return this}else{a:{for(var d=this.ba,e=0,f=0,g=0,h,l,k,n,q;g<d.ga.length;){switch(d.ga[g]){case Ab:e=d.ga[g+1];f=d.ga[g+2];break;case Bb:h=d.ga[g+1];l=d.ga[g+2];n=h-e;k=l-f;q=n*n+k*k;q=((a-e)*n+(b-f)*k)/q;1<q?q=1:0>q&&(q=0);e+=q*n;k=
f+q*k;f=e-a;k=k-b;f=f*f+k*k;if(f<=c){c=!0;break a}e=h;f=l}g+=Eb[d.ga[g]]}c=!1}if(c)return this}return null};m.lineTo=function(a,b){var c=this.fa.commands;c.push(1);c.push(a);c.push(b)};m.ud=function(a,b){var c=this.fa.commands;c.push(5);c.push(a);c.push(b)};m.ad=function(){return!1!==this.fa.editable&&!0!==this.fa.lockEditMode};
m.yd=function(a,b,c){c=8*c;if(a>=this.origin.x-c&&a<this.origin.x+c&&b>=this.origin.y-c&&b<this.origin.y+c)return 0;for(var d=0;d<this.ta;d++){var e=this.$[d];if(e.control&&a>=e.control.x-c&&a<e.control.x+c&&b>=e.control.y-c&&b<e.control.y+c)return 2*d+1;if(a>=this.$[d].ka.x-c&&a<this.$[d].ka.x+c&&b>=this.$[d].ka.y-c&&b<this.$[d].ka.y+c)return 2*d}return null};
m.wd=function(a,b){a.save();a.lineWidth=1*b;a.strokeStyle="#0050B7";var c=4*b;a.strokeRect(this.origin.x-c,this.origin.y-c,2*c,2*c);var d=this.$.length;this.fa.closed&&--d;a.beginPath();for(d=1;d<this.ta;d++){var e=this.$[d];e.control?(a.arc(this.$[d].control.x,this.$[d].control.y,c,0,2*Math.PI),a.arc(this.$[d].control.x,this.$[d].control.y,2*c,0,2*Math.PI)):e instanceof vb&&(a.arc(e.$.x,e.$.y,c,0,2*Math.PI),a.arc(e.Na.x,e.Na.y,c,0,2*Math.PI));a.rect(this.$[d].ka.x-c,this.$[d].ka.y-c,2*c,2*c)}a.stroke();
a.restore()};function ve(a){void 0===a?this.ga=[]:this.ga=a}ve.prototype={moveTo:function(a,b){this.ga.push(0);this.ga.push(a);this.ga.push(b)},lineTo:function(a,b){this.ga.push(1);this.ga.push(a);this.ga.push(b)},ud:function(a,b){this.ga.push(5);this.ga.push(a);this.ga.push(b)},arcTo:function(a,b,c,d,e){this.ga.push(3);this.ga.push(c);this.ga.push(d);this.ga.push(a);this.ga.push(b);this.ga.push(e)},close:function(){this.ga.push(7)},Gb:function(){return this.ga}};
function Le(a,b,c,d,e){a.ga.push(6);a.ga.push(d);a.ga.push(e);a.ga.push(b);a.ga.push(c)}function Me(){var a=new E(0,0),b=new ve;b.moveTo(a.x,a.y-50);Le(b,a.x+50,a.y-50,a.x+50,a.y);Le(b,a.x+50,a.y+50,a.x,a.y+50);Le(b,a.x-50,a.y+50,a.x-50,a.y);Le(b,a.x-50,a.y-50,a.x,a.y-50);b.close();return b.Gb()}ne("PathNode",He);function Ne(a,b,c,d,e){this.view=a;this.node=null;this.type=b;this.url=c||"";this.fa=d||{};this.ba=e;"wrap"in this.fa||(this.fa.wrap=this.view.ea.get("multilineText"));"fontSize"in this.fa||(this.fa.fontSize=this.view.ea.get("defaultFontSize"))}
Ne.prototype={Bb:function(){this.log("Entering DrawLinesBehaviour");this.view.canvas.style.cursor="crosshair";this.view.ea.Hb()||Oe(this.view,"click-to-place-first-point-of-line");this.view.ma();this.$=new E(0,0);this.aa=new E(0,0);this.node=null;this.state="start"},log:A("DRAWLINES"),reset:function(){this.Bb()},Ua:function(a){var b;"touchstart"===a.type?(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),this.Ia(b.x,b.y,a)):"touchmove"===a.type?(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),
this.La(b.x,b.y,a)):"touchend"===a.type&&(b=a.changedTouches[0],b=C(this.view,b.pageX,b.pageY),this.Ma(b.x,b.y,a))},ob:function(a){"cancel"===a&&(null!==this.node&&this.view.rf&&"curve"===this.type&&this.ya(),null!==this.node&&this.view.ja.removeNode(this.node),this.view.Da.ab?this.view.mb.emit("goto-toolbar"):I(this.view))},done:function(){this.view.ea.get("autoPickTool")?I(this.view):this.state="start"},Ia:function(a,b){var c=this.view.Sa(new E(a,b));if("start"===this.state)if(this.$=new E(a,b),
"stampline"===this.type)this.node=Pd("StampLineNode",Pe(this.view.ja),this.view.ja),this.node.setProperty("x1",c.x),this.node.setProperty("y1",c.y),this.node.setProperty("x2",c.x),this.node.setProperty("y2",c.y),this.node.setProperty("url",this.url),Rd(this.view.ja,this.node),Oe(this.view,"click-to-set-the-end-of-the-line"),this.view.update(),this.index=2;else{this.node=new He(Pe(this.view.ja),this.view.ja);this.node.setProperty("seed",Math.round(65535*Math.random()));this.node.setProperty("strokeStyle",
this.view.bb);this.node.setProperty("lineWidth",this.view.ua.lineWidth);this.node.setProperty("sloppiness",this.view.ua.sloppiness);this.node.setProperty("smoothness",this.view.ua.smoothness);for(var d in this.fa)this.fa.hasOwnProperty(d)&&this.node.setProperty(d,this.fa[d]);Rd(this.view.ja,this.node);"arrow"===this.type&&(this.node.setProperty("arrowSize",this.view.ea.ra.defaultArrowSize),this.node.setProperty("arrowStyle",this.view.ea.ra.defaultArrowStyle));this.node.moveTo(c.x,c.y);Qe(this,c.x,
c.y);this.index=2;this.view.update();this.state="predrag"}else if("placing"===this.state)if("arrow"!==this.type&&8>this.$.kb(new E(a,b))&&2<this.index)this.log("Clicked close to start; automatically closing path"),this.node.close(),this.ya(),this.done();else if(8>this.aa.kb(new E(a,b))){if(2<this.index){for(var c=this.node.fa.commands,e=d=0;e<this.index;e++)d+=Je[c[d]]+1;c.splice(d,Je[c[d]]+1);this.ya()}else this.node&&(this.view.ja.removeNode(this.node),this.node=null);this.done()}else{if(this.ba){this.ya();
this.done();return}Qe(this,c.x,c.y);this.index+=2;Od(this.view.ja,this.node.id);this.view.update()}else throw"Invalid state";this.aa=new E(a,b)},Ma:function(a,b){var c=this.$.kb(new E(a,b));this.log("onMouseUp (%s,%s) %s",a,b,this.state);"predrag"===this.state&&(this.log("MovedBy: %s",c),10<c?(this.ya(),this.done()):(this.state="placing",Oe(this.view,"click-to-place-another-point-or-double-click-to-end-the-line")))},La:function(a,b){var c=this.view.Sa(new E(a,b));a=c.x;b=c.y;this.node&&(this.node.zc(this.index,
a,b),this.node.format(this.view.na,this.view.request),this.view.ma())},ya:function(){var a=this.node,b=a.$[a.$.length-1];8>=rb(b.ka.x,b.ka.y,a.origin.x,a.origin.y)&&a.close();this.view.ja.removeNode(this.node);a=this.view.ea.ra.defaultArrowSize;b=this.node.sa("commands");if("linear-bezier"===this.type){for(var c=0,d=[],e,f,g,h,l,k;c<b.length;){var n=b[c];switch(n){case 0:g=b[c+1];h=b[c+2];d.push(n,g,h);break;case 1:e=b[c+1],f=b[c+2],void 0!==l&&d.push(4,e,f,(l+g)/2,(k+h)/2,(g+e)/2,(h+f)/2),l=g,k=
h,g=e,h=f}c+=Je[n]+1}b=d}g={arrowSize:"arrow"===this.type?a:0,arrowStyle:this.view.ea.ra.defaultArrowStyle,commands:b,seed:this.node.sa("seed"),fillStyle:this.view.Xa,strokeStyle:this.view.bb,lineWidth:this.view.ua.lineWidth,sloppiness:this.view.ua.sloppiness,smoothness:this.view.ua.smoothness,layer:this.view.Ha};for(var q in this.fa)this.fa.hasOwnProperty(q)&&(g[q]=this.fa[q]);this.view.ya([new G("PathNode",g)]);this.node=null},Fb:function(){this.view.canvas.style.cursor="default";Oe(this.view,null);
this.view.ma()},wb:function(a){var b;a.Tc?(this.view.Xa=a.Qa,this.view.gb=a.Qa,b="fillStyle",this.log("We are drawing lines. Set strokeStyle instead of fillStyle")):b="strokeStyle";this.view.bb=a.Qa;this.view.setProperty(b,a.Qa)},Nb:function(a,b){b?(this.view.Xa=sc(this.view.Xa,a),this.view.gb=sc(this.view.gb,a)):this.view.bb=sc(this.view.bb,a);Vd(this.view,a,b)},Kb:function(){return this.type}};
function Qe(a,b,c){"curve"===a.type||"arrow"===a.type||"linear-bezier"===a.type?a.node.ud(b,c):a.node.lineTo(b,c)};function Re(){}Re.prototype={rb:"Action",Zd:function(a){var b,c,d,e;this.id&&(this.id=a(this.id));if(this.$&&0<this.$.length){e=[];b=c=0;for(d=this.$.length-1;0<=d?c<=d:c>=d;b=0<=d?++c:--c)e.push(this.$[b]=a(this.$[b]));return e}},log:A("ACTION"),toString:function(){return""+this.rb+"()"}};Re.prototype=p.$({},ob.prototype,Re.prototype);function G(a,b,c,d){this.type=a;this.aa=c;this.index=d;this.fa=b;this.id=0}
G.prototype={rb:"CreateAction",nb:function(a){this.id=this.id||Pe(a);this.node=Pd(this.type,this.id,a);if(!this.node)if(this.type in ye)this.node=new xe(this.id,a),this.node.setProperty("type",this.type);else{this.log("Bad node type: %s",this.type);var b=this.node=Pd("UnknownNode",this.id,a),c=this.type;b.aa=c;b.$.text=c;b.log("Creating placeholder for node type %s",c)}Qd(this.node,this.fa);if(void 0===this.aa||void 0===this.index)this.aa=a.$[a.jb].id,this.index=-1;b=T(a,this.aa);W(a,b,this.node,
this.index);this.log("Add %s id %s to parent %s index %s",this.node.type(),this.id,b.type(),this.index)},toString:function(){return""+this.rb+"("+this.type+", "+JSON.stringify(this.fa)+", parent="+this.aa+", index="+this.index+")"},Ta:function(a){a.removeNode(this.node)}};G.prototype=p.$({},Re.prototype,G.prototype);function Se(a){this.$=a;this.aa=[]}
Se.prototype={rb:"DeleteAction",nb:function(a){var b,c,d,e;this.aa.length=0;e=this.$;c=0;for(d=e.length;c<d;c++)b=e[c],b=T(a,b),this.aa.push({node:b,parent:b.parent,index:a.removeNode(b)})},Ta:function(a){var b,c,d,e;if(0!==this.aa.length)for(e=this.aa,c=0,d=e.length;c<d;c++)b=e[c],W(a,b.parent,b.node,b.index)}};Se.prototype=p.$({},Re.prototype,Se.prototype);function Xd(a,b,c){this.$=a;this.name=b;this.value=c;this.aa=[]}
Xd.prototype={rb:"SetAction",nb:function(a){var b,c,d,e;this.aa.length=0;e=this.$;c=0;for(d=e.length;c<d;c++)b=e[c],b=T(a,b),this.aa.push(b.sa(this.name)),b.setProperty(this.name,this.value)},Ta:function(a){var b,c,d,e;if(0!==this.$.length)for(b=d=0,e=this.$.length-1;0<=e?d<=e:d>=e;b=0<=e?++d:--d)c=T(a,this.$[b]),c.setProperty(this.name,this.aa[b])},Ud:function(a){if(this.name!==a.name)return!1;this.$.sort();a.$.sort();if(this.$.length!==a.$.length)return!1;for(var b=0;b<this.$.length;b++)if(this.$[b]!==
a.$[b])return!1;this.log("Merging property change %s",this.name);this.value=a.value;return!0}};Xd.prototype=p.$({},Re.prototype,Xd.prototype);function R(a,b,c){this.$=a;this.wa=b;this.inverse=c}
R.prototype={rb:"TransformAction",nb:function(a){this.log("Execute transformAction");var b,c,d,e;e=this.$;c=0;for(d=e.length;c<d;c++)b=e[c],b=T(a,b),b.transform(this.wa,this.inverse)},Ta:function(a){var b,c,d,e;e=this.$;c=0;for(d=e.length;c<d;c++)b=e[c],b=T(a,b),b.transform(this.inverse,this.wa)},Zd:function(a){var b,c,d;if(0!==this.$.length)for(b=c=0,d=this.$.length-1;0<=d?c<=d:c>=d;b=0<=d?++c:--c)this.$[b]=a(this.$[b])}};R.prototype=p.$({},Re.prototype,R.prototype);
function ib(a,b,c,d,e,f){this.id=a;this.aa=b;this.ba=c;this.ia=d;this.x=e;this.y=f}ib.prototype={rb:"MoveEditHandleAction",nb:function(a){T(a,this.id).zc(this.aa,this.x,this.y)},Ta:function(a){T(a,this.id).zc(this.aa,this.ba,this.ia)}};ib.prototype=p.$({},Re.prototype,ib.prototype);function Te(a){this.id=0;this.$=a;this.aa=[]}
Te.prototype={rb:"GroupAction",nb:function(a){var b,c,d,e;this.aa.length=0;e=this.$;c=0;for(d=e.length;c<d;c++)b=e[c],b=T(a,b),this.aa.push({node:b,parent:b.parent,index:pe(b.parent,b)});this.id=this.id||Pe(a);this.node=a.kc(this.id,this.$)},Ta:function(a){var b,c;if(0!==this.$.length){for(b=c=this.$.length-1;0<=c&&!(0>b);b=c+=-1)b=this.aa[b],W(a,b.parent,b.node,b.index);a.removeNode(this.node)}},toString:function(){return"GroupAction("+JSON.stringify(this.$)+")"}};
Te.prototype=p.$({},Re.prototype,Te.prototype);function Ue(a){this.$=a;this.aa=[]}
Ue.prototype={rb:"UngroupAction",nb:function(a){var b,c,d,e,f,g,h,l,k;d={};l=this.$;e=0;for(g=l.length;e<g;e++)if(b=l[e],b=T(a,b),je(b)&&!(b.id in d))for(d[b.id]=!0,c={node:b,parent:b.parent,children:b.children.concat(),index:a.removeNode(b)},this.aa.push(c),k=c.children,f=0,h=k.length;f<h;f++)b=k[f],W(a,c.parent,b,-1)},Ta:function(a){var b,c,d,e;if(0!==this.aa.length){for(b=d=this.aa.length-1;0<=d&&!(0>b);b=d+=-1)if(b=this.aa[b],0!==b.children.length){for(c=e=b.children.length-1;0<=e&&!(0>c);c=e+=
-1)W(a,b.node,b.children[c],-1);W(a,b.parent,b.node,b.index)}a.Yc()}}};Ue.prototype=p.$({},Re.prototype,Ue.prototype);function Ve(a,b,c){var d,e,f;if(je(a))for(f=a.children,d=0,e=f.length;d<e;d++)a=f[d],Ve(a,b,c);else a.transform(b,c)}function We(a,b){this.$=a;this.offset=b;this.za=[];this.aa=[]}
We.prototype={rb:"DuplicateAction",nb:function(a){var b,c,d,e,f,g,h;e=new H(this.offset,this.offset);c=e.inverse();this.za.length=0;var l=this;d=this.aa.length?function(){return l.aa[f]}:function(){var b=Pe(a);l.aa.push(b);return b};h=this.$;f=0;for(g=h.length;f<g;f++)b=h[f],b=T(a,b).clone(d),Ve(b,e,c),Rd(a,b),this.za.push(b)},Ta:function(a){var b,c;if(0!==this.za.length)for(b=c=this.za.length-1;0<=c&&!(0>b);b=c+=-1)a.removeNode(this.za[b])}};We.prototype=p.$({},Re.prototype,We.prototype);
function Xe(a,b){this.$=a;this.type=b;this.za=[];this.aa=[]}
Xe.prototype={rb:"ChangeOrderAction",nb:function(a){var b,c,d,e,f,g;this.aa.length=0;this.za.length=0;g=this.$;e=0;for(f=g.length;e<f;e++)switch(b=g[e],b=T(a,b),d=b.parent,c=a.removeNode(b),this.aa.push(c),this.za.push(b),this.type){case Ye:W(a,d,b,-1);break;case Ze:W(a,d,b,0);break;case $e:0<c?W(a,d,b,c-1):W(a,d,b,c);break;case af:c<d.children.length?W(a,d,b,c+1):W(a,d,b,c)}},Ta:function(a){var b,c,d,e;if(0!==this.$.length)for(b=e=this.$.length-1;0<=e&&!(0>b);b=e+=-1)c=this.za[b],d=c.parent,a.removeNode(c),
W(a,d,c,this.aa[b])}};var Ye=0,Ze=1,af=2,$e=3;Xe.prototype=p.$({},Re.prototype,Xe.prototype);function bf(a){this.fa=a}bf.prototype={rb:"SetDocumentPropertiesAction",nb:function(a){var b;this.aa={};for(b in this.fa)this.fa.hasOwnProperty(b)&&(this.aa[b]=a.sa(b),a.setProperty(b,this.fa[b]))},Ta:function(a){for(var b in this.aa)this.aa.hasOwnProperty(b)&&a.setProperty(b,this.aa[b])}};bf.prototype=p.$({},Re.prototype,bf.prototype);function cf(a){M.apply(this,arguments);this.la=new nb;this.za={};this.ta=new y;this.Yc=this.Za=!0;this.fb=0;this.ia=new y;this.ba=new y;this.oa=new y;this.root=new oe(Pe(this),this);this.za[this.root.id]=this.root;this.vb=0;this.ub="magenta";this.eb=this.la.next;this.fa={};this.Ja=new y;this.Cb=new y;this.Ea=[];this.$=[];this.jb=0;a||(df(this,this.root),this.ib(this.xc(0)))}
cf.prototype={log:A("DOC"),empty:function(){return 0===this.root.children.length},$b:function(){return this.eb!==this.la.next},ya:function(a,b){this.ia=new y;this.ba=new y;this.oa=new y;if(b){this.log("Performing actions without adding to undo stack");for(var c=0;c<a.length;c++)a[c].nb(this)}else this.la.ya(a,!1,this);return{tb:la(this.ia),Ub:la(this.ba),Vb:la(ma(ma(this.oa,this.ia),this.ba))}},Ta:function(){this.ia=new y;this.ba=new y;this.oa=new y;this.la.Ta(this);return{tb:la(this.ia),Ub:la(this.ba),
Vb:la(ma(ma(this.oa,this.ia),this.ba))}},Ob:function(){this.ia=new y;this.ba=new y;this.oa=new y;this.la.Ob(this);return{tb:la(this.ia),Ub:la(this.ba),Vb:la(ma(ma(this.oa,this.ia),this.ba))}},Yb:function(){return this.la.Yb()},Xb:function(){return this.la.Xb()},format:function(a,b){var c,d,e,f,g;d=this.Za?this.za:this.ta.keys;e=[];for(c in d)d.hasOwnProperty(c)&&e.push(this.za[c]);g=ef(this,e);d=0;for(f=g.length;d<f;d++)c=g[d],c.format(a,b);this.ta.keys={};this.Za=!1;return e.length},ma:function(a){function b(b){ff(f,
a,b);gf(f,function(c){f.Ja.contains(ke(c))||c.lc()===b&&(c.oa||c.ma(a))})}var c,d,e,f=this;c=la(this.Cb);c.sort();d=0;for(e=c.length;d<e;d++)b(c[d])},cb:function(a,b,c){var d;d=null;gf(this,function(e){ke(e)===c&&e.cb(a,b)&&(null===d||d.lc()<=e.lc())&&(d=e)});return d},lb:function(a,b){var c;c=function(d){var e,f,g;if(d.children)for(a&&b(d),g=d.children,e=0,f=g.length;e<f;e++)d=g[e],c(d);else b(d)};c(this.root)},kc:function(a,b){var c,d,e,f;c=new oe(a,this);Rd(this,c);e=0;for(f=b.length;e<f;e++)d=
b[e],W(this,c,this.za[d],-1);return c},removeNode:function(a,b){var c,d,e=this;void 0===b&&(b=!0);c=pe(a.parent,a);0<=c&&(a.parent.children.splice(c,1),a.parent=null,b&&(d=function(b){var c,h,l,k;delete e.za[b.id];a.Yd();e.ta.remove(b.id);if(je(b))for(k=b.children,h=0,l=k.length;h<l;h++)c=k[h],d(c);b.sa("spotHighlight")&&hf(e.Ea,b)},d(a)));"PageNode"===a.type()&&(this.$.splice(c,1),c===this.jb&&(this.log("Removed current page."),this.ib(Math.min(c,this.$.length-1))));this.ba.add(a.id);return c},hb:function(){var a,
b,c,d,e;a=e=d=b=null;this.lb(!1,function(c){if(null===b||c.rect.x<b)b=c.rect.x;if(null===d||c.rect.right()>d)d=c.rect.right();if(null===e||c.rect.y<e)e=c.rect.y;if(null===a||c.rect.bottom()>a)a=c.rect.bottom()});c=null===b?new P(0,0,10,10):new P(b,e,d-b,a-e);this.log("getDrawingRectangle: %s",c);return c},sa:function(a){return this.fa[a]},setProperty:function(a,b){void 0===b?a in this.fa&&delete this.fa[a]:this.fa[a]=b},Oc:function(a,b){this.log("showLayer(%s, %s)",a,b);b?this.Ja.remove(a):this.Ja.add(a)},
zd:function(a){return!this.Ja.contains(a)},xc:function(a){this.log("Adding page to document with index %s",a);if(a>this.$.length)return this.log("Error: Can insert page with index %s",a),-1;var b=Pd("PageNode",Pe(this),this);W(this,this.root,b,a);return a},Jb:function(){return this.$.length},ib:function(a){if(0<=a&&a<this.$.length)return this.log("Set current page to %s/%s",a,this.$.length),this.jb=a,!0;this.log("Tried to set page to non-existing %s",a);return!1},rc:function(a){this.lb(!1,function(b){b.rc(a)})}};
function jf(a){var b=816,c=1056;"width"in a.fa&&(b=a.fa.width);"height"in a.fa&&(c=a.fa.height);return new Wc(b,c)}function kf(a){return"width"in a.fa?new P(0,0,a.fa.width,a.fa.height):a.hb()}function hf(a,b){var c;"function"!==typeof b?c=function(a){return a===b}:c=b;for(var d=0,e=0;e<a.length;e++)c(a[e])?d+=1:d&&(a[e-d]=a[e]);a.length-=d}
function W(a,b,c,d){c.parent&&a.removeNode(c,!1);-1===d?b.children.push(c):b.children.splice(d,0,c);df(a,c);a.Yc=!0;"PageNode"===c.type()&&(-1===d?a.$.push(c):a.$.splice(d,0,c));c.parent=b}
function lf(a,b,c){var d,e,f,g,h,l,k,n,q,r;0===b.indexOf("zwibblerclip.")&&(b=b.substr(13));f=JSON.parse(b);b=[];h=a.fb;q=0;for(r=f.length;q<r;q++)if(e=f[q],"GroupAction"===e.type)b.push(new Te(e.members)),c.push(h++);else if("CreateAction"===e.type){n=e.properties;l={};for(g in n)n.hasOwnProperty(g)&&(k=n[g],"[object Array]"===Object.prototype.toString.apply(k)&&"Matrix"===k[0]&&(k.splice(0,1),k=new Q(k)),l[g]=k);b.push(new G(e.node,l));c.push(h++)}d=a.fb;g=function(b){a.log("Remap %s -> %s",b,b+
d);return b+d};e=0;for(f=b.length;e<f;e++)c=b[e],c.Zd(g);return b}function mf(a,b,c,d){var e,f,g,h;if(je(b)){e=[];h=b.children;f=0;for(g=h.length;f<g;f++)b=h[f],d=mf(a,b,c,d),e.push(d-1);c.push({type:"GroupAction",members:e})}else{a=he(b);g={};for(e in a)a.hasOwnProperty(e)&&(f=a[e],f instanceof Q&&(f=["Matrix",f.m11,f.m12,f.m21,f.m22,f.Aa,f.Ba]),g[e]=f);c.push({type:"CreateAction",node:b.type(),properties:g})}return d+1}
function nf(a,b){var c;c=0;a.Yc&&(a.Yc=!1,a.lb(!0,function(a){a.Ea=c++}));b.sort(function(a,b){return a.Ea-b.Ea})}function gf(a,b){function c(a){if(a.children)for(var e=0;e<a.children.length;e++)c(a.children[e]);else"PageNode"!==a.type()&&b(a)}c(a.$[a.jb])}function ef(a,b){var c,d,e,f,g;e=[];c={};f=0;for(g=b.length;f<g;f++){for(d=b[f];ie(d);)d=d.parent;d.id in c||(c[d.id]=!0,e.push(d))}nf(a,e);return e}function of(a,b){var c=[];gf(a,function(a){b.contains(a.hb())&&c.push(a)});return c}
function ff(a,b,c){if(0!==a.Ea.length&&c===a.vb){b.save();b.beginPath();c=kf(a);b.moveTo(c.x,c.y);b.lineTo(c.x,c.bottom());b.lineTo(c.right(),c.bottom());b.lineTo(c.right(),c.y);b.closePath();for(var d=0;d<a.Ea.length;d++)a.Ea[d].clip(b);b.clip();b.fillStyle=a.ub;b.fillRect(c.x,c.y,c.width,c.height);b.restore()}}function pf(a){a.la=new nb}function T(a,b){var c;ia(b);return b in a.za?(c=a.za[b],a.ta.add(b),a.oa.add(b),c):null}function Rd(a,b){W(a,a.$[a.jb],b,-1)}
function Od(a,b){ia(b);a.oa.add(b);a.ta.add(b)}function df(a,b,c){var d,e,f,g;void 0===c&&(c=!0);u("id"in b,"Must be a node");if(!(b.id in a.za)&&(a.za[b.id]=b,a.ia.add(b.id),je(b)))for(g=b.children,e=0,f=g.length;e<f;e++)d=g[e],df(a,d,c);b.rc(!1);c&&a.ta.add(b.id);a.Cb.add(b.lc());b.sa("spotHighlight")&&"PathNode"===b.type()&&a.Ea.push(b);b.Wd()}function Pe(a){a.log("nextId bumped to %s",a.fb+1);return a.fb++}p.$({},M.prototype,cf.prototype);function qf(){return"localStorage"in window&&null!==window.localStorage}var rf={};function sf(a,b,c,d){this.view=a;this.Ba=this.Aa=0;this.Oa=!1;this.$=b;this.Ia(c,d)}
sf.prototype={log:A("SELECT"),Ua:function(a){"touchmove"===a.type?(a=tf(this.view,a.changedTouches[0]),this.La(a.x,a.y)):"touchend"===a.type&&(a=tf(this.view,a.changedTouches[0]),this.Ma(a.x,a.y))},Ia:function(a,b){this.Aa=a;this.Ba=b;this.Oa=!0},La:function(a,b){if(this.Oa){var c=this.view.na,d=this;this.view.ma(function(){c.save();c.strokeStyle="#0050B7";c.lineWidth=2/d.view.scale;c.fillStyle="rgba(0, 80, 183, 0.2)";var e=new P(d.Aa+.5,d.Ba+.5,a-d.Aa,b-d.Ba);c.fillRect(e.x,e.y,e.width,e.height);
c.strokeRect(e.x,e.y,e.width,e.height);c.restore()})}},Ma:function(a,b){this.Oa=!1;this.view.Wa();for(var c=this.view,d=of(c.ja,new P(this.Aa,this.Ba,a-this.Aa,b-this.Ba)),e=0;e<d.length;e++)we(c,d[e]);V(this.view);this.view.ma();this.view.pa=this.$}};function jb(a){this.view=a;Oe(this.view,"");this.Hb=this.view.ea.Hb();this.ia=1;this.Hb&&(this.ia=2)}
jb.prototype={log:A("DefaultBehaviour"),Bb:function(){this.log("Entering pick tool.");this.view.canvas.style.cursor="default"},Fb:function(){this.log("Leaving pick tool.")},Ua:function(a){for(var b,c=0;c<a.touches.length;c++){b=a.touches[c];b=C(this.view,b.pageX,b.pageY);if("touchstart"===a.type)return this.Ia(b.x,b.y,a);if("touchend"===a.type)return this.Ma(b.x,b.y)}return!1},Ia:function(a,b,c){var d,e;this.log("onMouseDown");if(this.view.ea.get("readOnly"))(d=this.view.ja.cb(a,b,this.view.Ha))?
(this.log("layer=%s active=%s",ke(d),this.view.Ha),this.view.va.emit("node-clicked",d.id)):this.log("readOnly mode: Ignoring click.");else{d=this.view;if(d.Ca)e=null;else{e=d.hd/d.scale;for(var f=null,g=Number.MAX_VALUE,h=0;h<d.la.length;h++){var l=d.la[h],k=rb(l.x,l.y,a,b);k<e&&k<g&&(g=k,f=l)}e=f}if(e)F(this.view,new Cd(this.view,e,!1,a,b));else{if(d=this.view.selection.length)d=this.view,g=uf(d),h=p(d.canvas).offset(),f=Bd(d.$),"changedTouches"in c?(e=c.changedTouches[0].pageX-h.left-g,g=c.changedTouches[0].pageY-
h.top-g):(e=c.pageX-h.left-g,g=c.pageY-h.top-g),d=d.Ja&&e>d.canvas.width-d.Ja.width-f&&g<d.Ja.height;d&&vf(this.view);if(this.view.Ca&&(d=this.view.Ca,e=d.yd(a,b,1/this.view.scale*this.ia),null!==e)){F(this.view,new hb(this.view,d,e,a,b));return}if(d=this.view.ja.cb(a,b,this.view.Ha))this.log("layer=%s active=%s",ke(d),this.view.Ha),this.view.va.emit("node-clicked",d.id);if(d&&ke(d)===this.view.Ha)e=d===this.view.Ca,f=d.qb===this.view.qb,this.log("wasEditNode: %s, wasSelected: %s",e,f),f||(c.shiftKey||
this.view.Wa(),we(this.view,d),V(this.view)),F(this.view,new Cd(this.view,this.view.qc?new ae(d,S(d)):new be,!e&&f,a,b));else if(c=this.view,c.selection.length&&c.Qc.Qb(a,b))F(this.view,new Cd(this.view,this.view.qc?new ae(this.view.selection[0],S(this.view.selection[0])):new be,!0,a,b));else if(c=this.view.ea,"auto"===c.ra.allowSelectBox?(d=c.Hb(),e=document.documentElement.clientHeight,f=window.innerHeight,g=!d||d&&0<f-e+50,c.log("Allowing select box: %s (useTouch=%s, documentHeight=%s, windowHeight=%s)",
g,d,e,f),c=g):c=c.ra.allowSelectBox,c)this.view.Ca=null,F(this.view,new sf(this.view,this,a,b));else return this.log("Disabled select box -- mobile touch active."),this.view.Ca=null,this.view.Wa(),V(this.view),this.view.ma(),!1}}},Ma:function(){this.log("onMouseUp")},ob:function(a,b){this.log("keyboard: %s",a);var c=!0,d=this.view.ea.get("nudge");b&&b.ctrlKey&&(d=this.view.ea.get("preciseNudge"));switch(a){case "bring-to-front":this.view.tc();break;case "send-to-back":this.view.Lc();break;case "left":wf(this.view,
-1,0,d)||(this.view.Ga=Math.min(this.view.Ga+16,0),J(this.view),this.view.ma());break;case "right":wf(this.view,1,0,d)||(this.view.Ga=Math.max(-(this.view.canvas.width*this.view.scale-this.view.canvas.width),this.view.Ga-16),J(this.view),this.view.ma());break;case "up":wf(this.view,0,-1,d)||(this.view.Fa=Math.min(this.view.Fa+16,0),J(this.view),this.view.ma());break;case "down":wf(this.view,0,1,d)||(this.view.Fa=Math.max(-(this.view.canvas.height*this.view.scale-this.view.canvas.height),this.view.Fa-
16),J(this.view),this.view.ma());break;case "select-none":this.view.Wa();V(this.view);this.view.ma();this.view.Da.ab&&this.view.mb.emit("goto-toolbar");break;case "select-all":var e=[];gf(this.view.ja,function(a){e.push(a)});this.view.selectNodes(e);this.view.ma();this.view.Da.ab&&this.view.mb.emit("goto-toolbar");break;case "duplicate":this.view.duplicate();break;case "move-up":this.view.dd();break;case "move-down":this.view.cd();break;case "delete":vf(this.view);break;case "curve-tool":xf(this.view);
break;case "line-tool":yf(this.view);break;case "group":this.view.group();break;case "ungroup":this.view.Sc();break;case "undo":this.view.Ta();break;case "redo":this.view.Ob();break;case "cut":this.view.vd();break;case "copy":this.view.Zb();break;case "paste":this.view.Bc();break;case "zoom-normal":this.view.ea.get("allowZoom")?(d=zf(this.view),this.view.scale=1,this.view.Ga=-d.x,this.view.Fa=-d.y,J(this.view),this.view.ma()):this.log("Zooming is disabled.");break;case "zoom-in":this.view.ea.get("allowZoom")?
this.view.Uc():this.log("Zooming is disabled.");break;case "zoom-out":this.view.ea.get("allowZoom")?this.view.Vc():this.log("Zooming is disabled.");break;default:c=!1}c&&(b.preventDefault(),b.stopPropagation())},wb:function(a){var b;a.Tc?(this.view.Xa=a.Qa,this.view.gb=a.Qa,b="fillStyle"):(this.view.bb=a.Qa,b="strokeStyle");this.view.setProperty(b,a.Qa)},Nb:function(a,b){b?(this.view.Xa=sc(this.view.Xa,a),this.view.gb=sc(this.view.gb,a)):this.view.bb=sc(this.view.bb,a);Vd(this.view,a,b)},dc:function(a,
b){this.log("onDoubleClick");var c=this.view.ja.cb(a,b,this.view.Ha);this.log("hittest: %s, hasText: %s",null!==c,null!==c&&c.xd());this.view.va.emit("double-click",a,b,c?c.id:null);c&&"PathNode"===c.type()&&!this.view.ea.get("allowTextInShape")?this.log("Editing text in shape is disabled."):c&&c.xd()&&(this.log("Text double-clicked."),Af(this.view),Ud(this.view.pa,c,a,b))},Kb:function(){return"pick"}};for(var Bf=[],Cf=0;4>Cf;Cf++)Bf.push(String.fromCharCode(">2$-".charCodeAt(Cf)^"zwibbler3".charCodeAt(Cf%9)));for(var Df=[115,116,114,111,107,101,84,101,120,116],Ef=[],Ff=0;Ff<Df.length;Ff++)Ef.push(String.fromCharCode(Df[Ff]));
function Gf(a,b,c,d,e,f,g){this.ea=e;this.kg=f;this.jd=c;this.mb=d;this.canvas=a[0];this.na=this.canvas.getContext("2d");this.va=g;this.Ea=!0===e.get("pageView");Hf(this);this.Da={ab:!1,Oa:!1,sd:!1,x:100,y:100};this.pa=new jb(this);this.Cb=null;this.aa=new wd("horizontal",!0);this.canvas.parentNode.appendChild(this.aa.canvas);this.$=new wd("vertical",!1);this.canvas.parentNode.appendChild(this.$.canvas);this.oa="none";this.Za=0;this.qc=this.fc=this.vb=!0;this.la=[];this.Ha="default";e.Hb()&&(this.Ja=
document.createElement("img"),this.Ja.setAttribute("src",X(e,"wd-trash.png")));var h=this;this.request=new Pb;this.request.canvas=this.canvas;this.request.on("reformat",function(a){h.log("Node %s requests reformat",a.id);a.id in h.ja.za&&(h.log("   Reformatting... zoom=%s",h.oa),Od(h.ja,a.id),h.update(),If(h),h.va.emit("resource-loaded"))});this.request.on("convert-dom-request",function(a,b){h.va.emit("convert-dom-request",b,a)});this.Ca=this.ia=null;this.ta=4;this.ea.Hb()?(this.hd=4*this.ta,this.ta=
9):this.hd=2*this.ta;this.$.on("scroll",function(a){h.Fa=-a*h.scale;h.ma()});this.aa.on("scroll",function(a){h.Ga=-a*h.scale;h.ma()});Jf(this);Kf(this,b);(a=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)?(this.log("Using requestAnimationFrame"),this.Wc=a):this.log("Emulating requestAnimationFrame");this.Jc=!1;this.Ib=null;this.ea.on("update",function(a,b){var c=!1;switch(a){case "defaultBrushColour":h.gb=b;h.pa&&void 0!==h.pa.Td&&h.pa.Mc(b);break;
case "defaultFillStyle":h.ua.fillStyle=b;h.Xa=b;break;case "defaultStrokeStyle":h.bb=b;h.ua.strokeStyle=b;break;case "defaultLineWidth":h.ua.lineWidth=b;break;case "defaultFont":h.ua.fontName=b;break;case "defaultBold":h.ua.bold=b;break;case "defaultItalic":h.ua.italic=b;break;case "defaultFontSize":h.ua.fontSize=b;break;case "defaultTextFillStyle":h.ua.textFillStyle=b;break;case "defaultTextStokeStyle":h.ua.textStrokeStyle=b;break;case "defaultTextLineWidth":h.ua.textLineWidth=b;break;case "defaultBrushWidth":h.eb=
b;h.pa&&h.pa.Td&&(h.pa.zb.lineWidth=b);break;case "pageView":h.Ea=b;c=!0;break;case "snap":case "background":Jf(h);c=!0;break;case "symmetry":c=!0;break;case "readOnly":!0===b&&(I(h),h.Wa(),V(h),c=!0),h.ja.rc(b)}c&&h.ma()});p(document).on("webkitfullscreenchange",function(){0<=navigator.userAgent.search("Safari")&&0>navigator.userAgent.search("Chrome")&&(h.log("SAFARI WORKAROUND: Disabling requestAnimationFrame."),h.Wc=Gf.prototype.Wc)});this.Ra=!1;I(this)}
Gf.prototype={log:A("VIEW"),Wc:function(a){a()},Oc:function(a,b){this.ja.Oc(a,b);b||a!==this.Ha||(this.Wa(),V(this));this.ma()},ob:function(a,b){var c;if(this.Da.ab){var d=0,e=0,f=this.ea.get("nudge");switch(a){case "right":d=f;break;case "left":d=-f;break;case "down":e=f;break;case "up":e=-f;break;case "enter":this.pa.pb?(this.Da.Oa=!1,c="click"):(this.Da.Oa=!this.Da.Oa,c=this.Da.Oa?"mousedown":"mouseup")}if(d||e)this.Da.x+=d,this.Da.x=Math.max(this.Da.x,0),this.Da.x=Math.min(this.canvas.width,this.Da.x),
this.Da.y+=e,this.Da.y=Math.max(this.Da.y,0),this.Da.y=Math.min(this.canvas.height,this.Da.y),this.ma(),c="mousemove";c?(b.preventDefault(),b.stopPropagation(),this.ma(),e=p(this.canvas).offset(),d=this.Da.x+e.left,e=this.Da.y+e.top,this.log("Simulate a %s at (%s,%s)",c,d,e),f=document.createEvent("MouseEvents"),f.initMouseEvent(c,!0,!0,window,0,d,e,d,e,!1,!1,!1,!1,this.Da.Oa?1:0,null),this.canvas.dispatchEvent(f),c=!0):c=!1}else c=!1;if(!c){this.pa.ob&&this.pa.ob(a,b);switch(a){case "next-page":this.ib(this.ja.jb+
1);break;case "previous-page":this.ib(this.ja.jb-1);break;case "zoom-to-page":this.ea.get("allowZoom")&&Lf(this,"page");break;case "zoom-to-width":this.ea.get("allowZoom")&&Lf(this,"width")}b.preventDefault();b.stopPropagation()}},rf:function(){return this.Da.ab},Sa:function(a){var b=this.ea.get("snap"),c;0<b?(c=Math.round(a.x/b)*b,a=Math.round(a.y/b)*b):(c=a.x,a=a.y);return new E(c,a)},dd:function(){var a=Mf(this);a.length&&this.ya([new Xe(a,af)])},cd:function(){var a=Mf(this);a.length&&this.ya([new Xe(a,
$e)])},tc:function(){var a=Mf(this);a.length&&this.ya([new Xe(a,Ye)])},Lc:function(){var a=Mf(this);a.length&&this.ya([new Xe(a,Ze)])},setProperty:function(a,b){var c=Mf(this,!0);this.ua[a]=b;if(c.length){var d=[new Xd(c,a,b)];if("fillStyle"===a)for(var e=0;e<c.length;e++){var f=T(this.ja,c[e]);this.log("nodeType=%s closed=%s",f.type(),f.sa("closed"));"PathNode"===f.type()&&!1===f.sa("closed")&&d.push(new Xd([c[e]],"strokeStyle",b))}this.ya(d)}0<this.selection.length&&"lineWidth"===a&&"BrushNode"===
this.selection[0].type()?this.eb=b:"textFillStyle"===a&&(this.ua.textFillStyle=b)},group:function(){var a=Mf(this);a.length&&this.ya([new Te(a)])},Sc:function(){var a=Mf(this);a.length&&this.ya([new Ue(a)])},Wa:function(){0<this.selection.length&&(this.qb+=1,this.selection.length=0,this.log("Clear selection. selectGeneration=%s",this.qb));this.Ca&&(this.log("Clear selection."),this.Ca=null)},selectNodes:function(a){this.Wa();for(var b=0;b<a.length;b++)a[b].sa("locked")||"PageNode"===a[b].type()||
we(this,a[b]);V(this)},ya:function(a,b){if(this.ea.get("readOnly"))this.log("readOnly mode: Ignoring change.");else{var c=this.ja.ya(a,b);this.log("Commit added %s nodes",c.tb.length);var d;this.ja.format(this.na,this.request);if(c.tb.length){var e=[];for(d=0;d<c.tb.length;d++)e.push(T(this.ja,c.tb[d]));this.selectNodes(e)}else if(this.selection.length||this.Ca){e=0;this.qb+=1;for(d=0;d<this.selection.length;d++)d!==e&&(this.selection[e]=this.selection[d]),this.selection[e].id in this.ja.za&&(this.selection[e].qb=
this.qb,e++);this.selection.length!==e&&(this.selection.length=e);!this.Ca||this.Ca.id in this.ja.za||(this.log("EditNode %s no longer exists",this.Ca.id),this.Ca=null);0!==this.selection.length||this.Ca||this.Wa();V(this)}If(this);this.ma();this.va.emit("document-changed");c.tb.length&&this.va.emit("nodes-added",c.tb);c.Vb.length&&this.va.emit("nodes-changed",c.Vb);c.Ub.length&&this.va.emit("nodes-removed",c.Ub)}},update:function(a,b){if(this.ja.format(this.na,this.request)||a)Jd(this),this.ma(b)},
ma:function(a){if(!Nf(this)&&(this.Ib=a,!this.Jc)){this.Jc=!0;var b=this;this.Wc.call(window,function(){b.Jc=!1;var a=Of(b),d=a.x,e=a.y,f=a.width,g=a.height;b.na.setTransform(1,0,0,1,0,0);b.na.clearRect(0,0,b.canvas.width,b.canvas.height);b.Ea&&(b.na.fillStyle=b.ea.get("outsidePageColour"),b.na.fillRect(0,0,b.canvas.width,b.canvas.height));b.na.translate(b.Ga,b.Fa);b.na.scale(b.scale,b.scale);a=new H(b.Ga,b.Fa);a=a.multiply(new fd(b.scale,b.scale));b.na.Wb=a;b.Ea?(d=b.na,e=jf(b.ja),d.beginPath(),
d.fillStyle="#FFFFFF",b.ea.get("pageShadow")&&(d.shadowOffsetX=3/b.scale,d.shadowOffsetY=3/b.scale,d.shadowBlur=5/b.scale,d.shadowColor="rgba(0,0,0,1.0)"),d.rect(0,0,e.width,e.height),d.fill(),d.shadowColor="rgba(0,0,0,0.0)",d.shadowBlur=0,d.shadowOffsetX=0,d.shadowOffsetY=0,Pf(b,d,0,0,e.width,e.height),b.ia&&b.ia(d,0,0,e.width,e.height)):b.ia?(b.na.save(),b.ia(b.na,d,e,f,g),b.na.restore()):Pf(b,b.na,d,e,Math.max(f,f-d),Math.max(g,g-d));d=ue(b);e=b.ea.ra.symmetry;if(1<e){f=2*Math.PI/e;g=b.Sa(new E(b.canvas.width/
2,b.canvas.height/2));e&1&&(a=new gd(f,g.x,g.y));for(b.na.save();f<2*Math.PI-1E-8;)0===(e&1)&&(a=new id(f,g.x,g.y)),b.na.transform(a.m11,a.m21,a.m12,a.m22,a.Aa,a.Ba),b.ja.ma(b.na),f+=2*Math.PI/e;b.na.setTransform(1,0,0,1,0,0);b.na.fillStyle="rgba(255,255,255,0.3)";b.na.fillRect(0,0,b.canvas.width,b.canvas.height);b.na.restore()}b.ja.ma(b.na);b.va.Ib&&(b.na.save(),b.va.Ib(b.na),b.na.restore());if(0<b.selection.length){b.na.save();a=b.na;a.lineWidth=1/b.scale;a.strokeStyle="#888888";a.beginPath();for(e=
0;e<b.selection.length;e++)g=b.selection[e],f=S(g),g=new nd(g.Eb),g.transform(f),pd(g,a,[3/b.scale,3/b.scale]);a.stroke();f=b.scale;for(e=0;e<b.la.length;e++){var g=b.la[e],h=b.ec.apply(g.x,g.y);g instanceof Dd?b.Kc&&(a.beginPath(),a.strokeStyle="#008000",a.lineWidth=3/f,a.moveTo(h.x,h.y),a.arc(h.x,h.y,6/f,0,1.5*Math.PI,!1),a.stroke()):(a.beginPath(),a.strokeStyle="#000",a.lineWidth=1/f,a.rect(h.x-b.ta/f,h.y-b.ta/f,b.ta/f*2,b.ta/f*2),a.stroke())}b.na.restore()}d&&b.na.restore();b.Ca&&b.Ca.wd(b.na,
1/b.scale);b.ub&&b.ea.get("showHints")&&(b.na.save(),b.na.font=10/b.scale+"px Arial",b.na.fillStyle="#000000",b.na.textBaseline="top",b.na.fillText(b.ub,0,0),b.na.restore());d=b.na;b.Da.ab&&(a=b.Da.x,e=b.Da.y,d.save(),d.setTransform(1,0,0,1,0,0),d.beginPath(),b.Da.sd?(d.moveTo(a-3,e-10),d.lineTo(a+3,e-10),d.moveTo(a-3,e+10),d.lineTo(a+3,e+10),d.moveTo(a,e-10),d.lineTo(a,e+10)):(d.moveTo(a,e-3),d.lineTo(a,e-15),d.moveTo(a,e+3),d.lineTo(a,e+15),d.moveTo(a-3,e),d.lineTo(a-15,e),d.moveTo(a+3,e),d.lineTo(a+
15,e)),b.Da.Oa&&b.na.arc(a,e,8,0,2*Math.PI,!1),d.lineWidth=2,d.strokeStyle="#000000",d.stroke(),d.restore());b.pa.Xd&&b.pa.Xd(b.na);b.Ib&&b.Ib(b.na);b.va.uc("draw",b.na);0<b.selection.length&&b.Ja&&(b.na.setTransform(1,0,0,1,0,0),b.na.drawImage(b.Ja,b.canvas.width-b.Ja.width-Bd(b.$),0))})}},Ta:function(){if(this.ea.get("readOnly"))this.log("readOnly mode: Ignoring undo.");else if(this.ja.Yb()){var a=this.ja.Ta();this.ja.format(this.na,this.request);Qf(this);Jd(this);If(this);J(this);this.ma();this.va.emit("document-changed");
a.tb.length&&this.va.emit("nodes-added",a.tb);a.Vb.length&&this.va.emit("nodes-changed",a.Vb);a.Ub.length&&this.va.emit("nodes-removed",a.Ub)}},Ob:function(){if(this.ea.get("readOnly"))this.log("readOnly mode: Ignoring redo.");else if(this.ja.Xb()){var a=this.ja.Ob();this.ja.format(this.na,this.request);Qf(this);Jd(this);If(this);J(this);this.ma();this.va.emit("document-changed");a.tb.length&&this.va.emit("nodes-added",a.tb);a.Vb.length&&this.va.emit("nodes-changed",a.Vb);a.Ub.length&&this.va.emit("nodes-removed",
a.Ub)}},vd:function(){this.Zb();vf(this)},Zb:function(a){var b=Hd(this);if(0!==b.length){var c;c=this.ja;var d,e,f,g,h;d=[];e=0;h=ef(c,b);f=0;for(g=h.length;f<g;f++)b=h[f],e=mf(c,b,d,e);c="zwibblerclip."+JSON.stringify(d);!0!==a&&(qf()?window.localStorage.setItem("clipboard",c):rf.clipboard=""+c);this.log("Reset paste offset to 0");this.Za=0;return c}},duplicate:function(){var a=Mf(this);0<a.length&&this.ya([new We(a,10)])},Bc:function(a){var b=[];a||(a=qf()?window.localStorage.getItem("clipboard"):
rf.clipboard);a=lf(this.ja,a,b);var c=this.ea.get("pasteOffset");0!==c&&(this.Za+=c,this.log("Using paste offset %s",this.Za),c=new H(this.Za,this.Za),a.push(new R(b,c,c.inverse())));this.ya(a);this.update()},lc:function(){return qc(this.canvas)},wb:function(a,b){this.pa.wb?(this.log("Simulating click of colour %s",a),this.pa.wb({Qa:a,Tc:b})):this.log("A colour is not needed for this tool.")},ib:function(a){this.ja.ib(a)&&(this.Wa(),V(this),this.ma(),this.va.emit("set-page",a))},Uc:function(){Lf(this,
1.1*this.scale)},Vc:function(){Lf(this,this.scale/1.1)}};function Nf(a){a.Ra&&a.log("Updates are locked. Ignoring draw/format request");return a.Ra}function Rf(a,b){!a.Ra&&b?(a.log("Locking updates."),a.Ra=!0):a.Ra&&!b&&(a.log("Resuming updates"),a.Ra=!1,If(a),J(a),a.ma())}function Of(a){return new P((0-a.Ga)/a.scale,(0-a.Fa)/a.scale,a.canvas.width/a.scale,a.canvas.height/a.scale)}
function Sf(a,b,c,d){if(!d)if(0===b.length)d=new E(0,0);else{d=b[0].hb().clone();for(var e=1;e<b.length;e++)cd(d,b[e].hb());d=ad(d)}c=new id(c,d.x,d.y);a.ya([new R(Tf(a,b),c,c.inverse())])}function Uf(a,b){var c,d;c=a.ja.fb;d=a.Sa(new E(100,100));d=new H(d.x,d.y);a.ya([new G("ImageNode",{url:b,layer:a.Ha}),new R([c],d,d.inverse())]);return I(a)}
function Vf(a,b){b=p.$({},{commands:Me(),fillStyle:a.Xa,strokeStyle:a.bb,seed:Math.round(65535*Math.random()),lineWidth:a.ua.lineWidth,sloppiness:a.ua.sloppiness,layer:a.Ha,wrap:a.ea.get("multilineText"),fontSize:a.ea.get("defaultFontSize")},b);F(a,new Md(a,"PathNode",b,100,100,"circle"))}
function Wf(a,b){b=b||{};var c,d,e,f,g;e=new ve;f=new E(-50,-50);g=new E(50,-50);d=new E(50,50);c=new E(-50,50);e.moveTo(f.x,f.y);e.lineTo(g.x,g.y);e.lineTo(d.x,d.y);e.lineTo(c.x,c.y);e.lineTo(f.x,f.y);e.close();b=p.$({},{commands:e.Gb(),fillStyle:a.Xa,strokeStyle:a.bb,seed:Math.round(65535*Math.random()),lineWidth:a.ua.lineWidth,sloppiness:a.ua.sloppiness,layer:a.Ha,wrap:a.ea.get("multilineText"),fontSize:a.ea.get("defaultFontSize")},b);a.log("Create an item on layer %s",a.Ha);F(a,new Md(a,"PathNode",
b,100,100,"rectangle"))}function wf(a,b,c,d){if(a.qc)return b*=d/a.scale,c*=d/a.scale,a.log("Nudge selection by %s, %s",b,c),d=Mf(a),d.length&&(b=new H(b,c),a.ya([new R(d,b,b.inverse())])),0<d.length;a.log("Can't nudge; selection motion is locked.")}function Xf(a,b,c,d){a.log("Set document size %s,%s",b,c);null===b&&(b=void 0);null===c&&(c=void 0);d?d.push(new bf({width:b,height:c})):(a.ja.setProperty("width",b),a.ja.setProperty("height",c),J(a),If(a),a.va.emit("document-changed"))}
function J(a){if(!Nf(a))if(a.ea.get("scrollbars")){var b=zf(a),c=Of(a),d=!1,e=!1;if(c.y<=b.y&&c.bottom()>=b.bottom())a.$.Ka();else{a.$.show();var d=a.$,f=Math.min(c.y,b.y),g=Math.max(c.bottom(),b.bottom()),h=c.height,l=-a.Fa/a.scale;d.ia=f;d.ba=g-f;d.la=h;d.position=l;d.format();d.ma();d=!0}c.x<=b.x&&c.right()>=b.right()?a.aa.Ka():(a.aa.show(),e=a.aa,f=Math.min(c.x,b.x),b=Math.max(c.right(),b.right()),c=c.width,g=-a.Ga/a.scale,e.ia=f,e.ba=b-f,e.la=c,e.position=g,e.format(),e.ma(),e=!0);e&&d?(yd(a.$,
20,a.canvas.height-20),yd(a.aa,a.canvas.width-20,20)):d?yd(a.$,20,a.canvas.height):e&&yd(a.aa,a.canvas.width,20)}else a.$.Ka(),a.aa.Ka()}function zf(a){a.Ea?(a=jf(a.ja),a=new P(0,0,a.width,a.height),a.Mb(20,20)):a=kf(a.ja);return a}function Yf(a,b,c){a.ea.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):F(a,new Ne(a,"arrow",void 0,b,c))}function xf(a,b){a.ea.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):F(a,new Ne(a,"curve",void 0,b))}
function Zf(a,b,c){a.ea.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(b.lineWidth=b.lineWidth||a.eb,b.strokeStyle=b.strokeStyle||a.gb,F(a,new te(a,0,b,c)))}function $f(a,b){a.ea.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(b.lineWidth=b.lineWidth||a.eb,b.strokeStyle=b.strokeStyle||a.gb,F(a,new te(a,0,b,"shapebrush")))}
function ag(a,b){a.ea.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(b.lineWidth=b.lineWidth||a.eb,b.strokeStyle=b.strokeStyle||a.gb,F(a,new te(a,0,b,"brush")))}function yf(a,b,c){a.ea.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):F(a,new Ne(a,"line",void 0,b,c))}function Af(a){a.ea.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):F(a,new Sd(a))}function F(a,b){a.pa&&a.pa.Fb&&a.pa.Fb();a.pa=b;b.Bb&&b.Bb();b.Kb&&a.va.emit("tool-changed",b.Kb())}
function I(a){F(a,new jb(a))}function Oe(a,b){b?(a.ub=a.kg.get(b),a.va.emit("hint",a.ub)):(a.ub=null,a.va.emit("hint",""))}function ue(a){if(a.Ea){var b=jf(a.ja);a.na.save();a.na.beginPath();a.na.rect(0,0,b.width,b.height);a.na.clip()}return a.Ea}function If(a){if(!Nf(a)){var b=zf(a),c=new P(0,0,a.canvas.width,a.canvas.height);b.ac(a.he)&&c.ac(a.ge)?a.log("No need to rezoom."):Lf(a,a.oa)?(a.log("Successfully rezoomed."),a.he=b,a.ge=c):a.log("Failed to zoom")}}
function Pf(a,b,c,d,e,f){a.background?(b.fillStyle=a.na.createPattern(a.background,"repeat"),b.fillRect(c,d,e,f)):a.ia?a.ia(b,c,d,e,f):"G_vmlCanvasManager"in window&&(b.fillStyle="rgba(0, 0, 0, 0.0)",b.fillRect(c,d,e,f))}
function Jf(a){var b=a.ea.get("snap"),c=null,d,e;d=a.ea.get("background");var f=cc(d,!0);if("grid"===d){var c=a.ea.get("gridBlocks"),b=a.ea.get("gridSpacing"),g=c*b,c=jc(document.body);c.width=g;c.height=g;d=c.getContext("2d");d.beginPath();for(e=0;e<g;e+=b)e%g&&(d.moveTo(e+.5,0),d.lineTo(e+.5,g));for(e=0;e<g;e+=b)e%g&&(d.moveTo(0,e+.5),d.lineTo(g,e+.5));d.strokeStyle=a.ea.get("gridColour");d.lineWidth=.5;d.stroke();d.beginPath();for(e=0;e<=g;e+=g)d.moveTo(e,0),d.lineTo(e,g);for(e=0;e<=g;e+=g)d.moveTo(0,
e+.5),d.lineTo(g,e+.5);d.lineWidth=2;d.stroke()}else f?(a.log("Using background colour %s",f.toString()),a.ia=function(a,b,c,d,e){a.fillStyle=f.toString();a.fillRect(b,c,d,e)}):0<b&&"clear"!==d&&(c=jc(document.body),c.width=b,c.height=b,d=c.getContext("2d"),d.beginPath(),d.moveTo(0,0),d.arc(0,0,3,0,2*Math.PI,!1),d.moveTo(b,0),d.arc(b,0,3,0,2*Math.PI,!1),d.moveTo(b,b),d.arc(b,b,3,0,2*Math.PI,!1),d.moveTo(0,b),d.arc(0,b,3,0,2*Math.PI,!1),d.fillStyle="#c0c0c0",d.fill());c&&document.body.removeChild(c);
a.background=c}function Mf(a,b){var c=Hd(a);b||(c=ef(a.ja,c));return Tf(a,c)}function Tf(a,b){for(var c=[],d=0;d<b.length;d++)a.log("Selected id=%s",b[d].id),c.push(b[d].id);return c}function Hd(a){var b=a.selection.concat();a.Ca&&b.push(a.Ca);for(var c=0;c<b.length;c++)a.log("Selected node=%s",b[c].id);return b}
function Qf(a){for(var b=0,c=0;c<a.selection.length;c++)c!==b&&(a.selection[b]=a.selection[c]),a.selection[b].id in a.ja.za&&(b+=1);a.selection.length!==b&&(a.selection.length=b);!a.Ca||a.Ca.id in a.ja.za||(a.Ca=null)}
function Jd(a){function b(a,b,c,d,e){!1!==f.vb&&f.la.push(new $d(a,c,new E(b.x+d*b.width,b.y+e*b.height),new E(b.x+(1-d)*b.width,b.y+(1-e)*b.height)))}var c;a.vb=!0;a.fc=!0;a.qc=!0;var d=!1;a.la.length=0;if(0!==a.selection.length){a.ba=a.selection[0].hb().clone();a.selection[0].sa("lockSize")&&(a.vb=!1);a.selection[0].sa("lockRotation")&&(a.fc=!1);a.log("lockPosition: %s",a.selection[0].sa("lockPosition"));a.selection[0].sa("lockPosition")&&(a.qc=!1);a.selection[0].sa("lockAspectRatio")&&(d=!0);for(c=
1;c<a.selection.length;c++)cd(a.ba,a.selection[c].hb()),a.selection[c].sa("lockSize")&&(a.vb=!1),a.selection[c].sa("lockRotation")&&(a.fc=!1),a.selection[c].sa("lockAspectRatio")&&(d=!0),a.selection[c].sa("lockPosition")&&(a.qc=!1);1===a.selection.length?a.Qc=a.selection[0].Od():a.Qc=new ud(a.ba);var e,f=a,g,h=0<a.ea.get("snap");a.log("snap=%s",a.ea.get("snap"));1<a.selection.length?(e=new Q,g=null,c=a.ba):(g=a.selection[0],c=g.Eb,e=S(g));a.ea.get("allowResize")&&(d||(b(g,c,e,.5,0),b(g,c,e,1,.5),
b(g,c,e,.5,1),b(g,c,e,0,.5)),b(g,c,e,0,0),b(g,c,e,1,0),b(g,c,e,1,1),b(g,c,e,0,1));if(a.fc)if(g&&g.sa("rotationHandles"))for(a=g.sa("rotationHandles"),c=0;c<a.length;c+=4)f.la.push(new Dd(g,e,new E(a[c],a[c+1]),new E(a[c+2],a[c+3]),h));else f.la.push(new Dd(g,e,new E(c.x+.5*c.width,c.y-10/a.scale),new E(c.x+.5*c.width,c.y+.5*c.height),h))}}
function V(a){Jd(a);if(a.Cb){var b=a.Cb,c=a.selection;b.action=null;b.$.length=0;b.aa={};b.za=c.concat();for(var d=!1,e=0;e<c.length;e++){var f=c[e];ie(f)&&(d=!0);var g=he(f),h;for(h in g)if(g.hasOwnProperty(h)){var l=b,k=h,n=f,q=void 0,q=l.ea;k in l.aa?(q=l.aa[k],q.value!==n.sa(k)&&(q.value=null)):"locked"===k||"points"===k||!0===n.sa("closed")&&("arrowSize"===k||"arrowStyle"===k||"doubleArrow"===k)||!1===n.sa("closed")&&("fontName"===k||"fontSize"===k||"textFillStyle"===k||"text"===k||"fillStyle"===
k)||"ImageNode"===n.type()&&("fillStyle"===k||"strokeStyle"===k||"lineWidth"===k||"shadow"===k)||"BrushNode"===n.type()&&"fillStyle"===k||"TextNode"===n.type()&&"fillStyle"===k||"lockSize"===k||"lockRotate"===k||"rotateAround"===k||"layer"===k||0===k.indexOf("cell-")||"fontName"===k&&!q.get("showFontNameProperty")||"fontSize"===k&&!q.get("showFontSizeProperty")||"smoothness"===k&&!q.get("showSmoothnessProperty")||"sloppiness"===k&&!q.get("showSloppinessProperty")||(q={Bd:bg(l,n,k),value:n.sa(k)},
q.Bd.display&&0===q.Bd.display.indexOf("Display-")||(l.$.push(q),l.aa[k]=q))}}cg(b);if(b.ea.get("showKeyboardHelp"))for(f=d,d=Ra(p("<div>"),"keydiv"),d.da("font-size","8pt"),d.da("color","#909090"),d.da("font-weight","normal"),p(b.ha).append(d),g=b.la.bc(),d.append("<h1>"+g("keyboard")+"</h1>"),e=[{key:b.ea.get("keyCurveTool"),description:g("draw-curves")},{key:b.ea.get("keyLineTool"),description:g("draw-lines")}],0<c.length&&e.push({key:b.ea.get("keyDelete"),description:g("delete-selection")},{key:b.ea.get("keyDuplicate"),
description:g("duplicate-selection")},{key:b.ea.get("keyMoveUp"),description:g("move-selection-closer")},{key:b.ea.get("keyMoveDown"),description:g("move-selection-away")}),1<c.length&&e.push({key:b.ea.get("keyGroup"),description:g("group-selection")}),f&&e.push({key:b.ea.get("keyUngroup"),description:g("break-apart-group")}),e.push({key:b.ea.get("keyZoomIn"),description:g("zoom-in")}),e.push({key:b.ea.get("keyZoomOut"),description:g("zoom-out")}),e.push({key:g("arrow-keys"),description:g("move-while-zoomed")}),
b=0;b<e.length;b++)c=Ra(p("<a>").text(e[b].key),"key"),c.da("background","#d0d0d0"),c.da("border-left","1px solid #808080"),c.da("border-right","1px solid #e0e0e0"),c.da("border-top","1px solid #808080"),c.da("border-bottom","1px solid #e0e0e0"),c.da("padding-left","0.5em"),c.da("padding-right","0.5em"),c.da("margin-right","1em"),c.da("color","#4fa0d3"),c.da("font-weight","bold"),c=p("<p>").append(c),c[0].appendChild(document.createTextNode(e[b].description)),d.append(c)}a.va.emit("selected-nodes")}
function we(a,b){a.Ca=null;if(b.qb!==a.qb&&ke(b)===a.Ha){a.selection.push(b);b.qb=a.qb;if(ie(b)){for(var c=b.parent,d=0;d<c.children.length;d++)we(a,c.children[d]);we(a,c)}b.children&&0<b.children.length&&we(a,b.children[0])}}function vf(a){var b=Mf(a);b.length&&a.ya([new Se(b)])}
function Vd(a,b,c){a.log("setSelectionOpacity(%s, fill=%s)",b,c);var d=Mf(a,!0),e=[];c=c?"fillStyle":"strokeStyle";for(var f=0;f<d.length;f++){var g=d[f],h=T(a.ja,g).sa(c);h&&(h=sc(h,b),e.push(new Xd([g],c,h)),a.log("   set %s of %s to %s",c,g,h))}e.length&&a.ya(e);a.log("   Affected %s of %s nodes",e.length,d.length)}
function Zd(a){a.Da.ab=!0;a.Da.sd=!1;if(0<a.selection.length){a.log("showKeyboardCursorAndStartMoving()");a.Da.Oa=!0;var b=ad(a.ba);a.Da.x=b.x;a.Da.y=b.y;I(a);F(a,new Cd(a,new ae(a.selection[0],S(a.selection[0])),!1,b.x-4,b.y-4))}a.ma()}
function Hf(a){var b=uf(a),c=new Date;p(a.canvas).bind("touchstart",function(b){if(a.pa.Ua){var d=!0;300<(new Date).getTime()-c.getTime()?d=!1!==a.pa.Ua(b.$a):a.pa.dc&&(d=tf(a,b.$a.touches[0]),d=!1!==a.pa.dc(d.x,d.y,b.$a));d&&(b.stopPropagation(),b.preventDefault());c=new Date}});p(a.canvas).bind("touchmove",function(b){a.pa.Ua&&!1!==a.pa.Ua(b.$a)&&(b.stopPropagation(),b.preventDefault())});p(a.canvas).bind("touchend",function(b){a.pa.Ua&&!1!==a.pa.Ua(b.$a)&&(b.stopPropagation(),b.preventDefault())});
p(a.canvas).bind("gesturestart",function(b){a.log("GestureStart");a.pa.nc&&!1!==a.pa.nc(b.$a)&&(b.stopPropagation(),b.preventDefault())});p(a.canvas).bind("gesturechange",function(b){a.log("GestureChange");a.pa.nc&&!1!==a.pa.nc(b.$a)&&(b.stopPropagation(),b.preventDefault())});p(a.canvas).bind("gestureend",function(b){a.log("GestureEnd");a.pa.nc&&!1!==a.pa.nc(b.$a)&&(b.stopPropagation(),b.preventDefault())});var d=new E(0,0),e=0;p(a.canvas).bind("pointerdown",function(c){a.log("PointerDown");d=new E(c.pageX,
c.pageY);e=(new Date).getTime();if(a.pa.Ia){var f=p(a.canvas).offset();!1!==a.pa.Ia((c.pageX-f.left-b-a.Ga)/a.scale,(c.pageY-f.top-b-a.Fa)/a.scale,c.$a)&&(c.stopPropagation(),c.preventDefault())}});p(a.canvas).bind("pointermove",function(c){if(a.pa.La){var d=p(a.canvas).offset();!1!==a.pa.La((c.pageX-d.left-b-a.Ga)/a.scale,(c.pageY-d.top-b-a.Fa)/a.scale,c.$a)&&(c.stopPropagation(),c.preventDefault())}});p(a.canvas).bind("pointerup",function(c){a.log("PointerUp");var f,l;a.pa.Ma&&(f=p(a.canvas).offset(),
l=(c.pageX-f.left-b-a.Ga)/a.scale,f=(c.pageY-f.top-b-a.Fa)/a.scale,!1!==a.pa.Ma(l,f,c.$a)&&(c.stopPropagation(),c.preventDefault()));a.log("TimeDist=%s PixelDist=%s",(new Date).getTime()-e,d.kb(new E(c.pageX,c.pageY)));a.pa.pb&&200>(new Date).getTime()-e&&2>d.kb(new E(c.pageX,c.pageY))&&(a.log("Simulate mouseclick from pointerup"),f=p(a.canvas).offset(),l=(c.pageX-f.left-b-a.Ga)/a.scale,f=(c.pageY-f.top-b-a.Fa)/a.scale,!1!==a.pa.pb(l,f,c.$a)&&(c.stopPropagation(),c.preventDefault()))});Ma(p(a.canvas),
function(c){if(a.pa.La){var d=p(a.canvas).offset();a.pa.La((c.pageX-d.left-b-a.Ga)/a.scale,(c.pageY-d.top-b-a.Fa)/a.scale,c)}c.preventDefault()});Oa(p(a.canvas),function(c){var d=p(a.canvas).offset();a.pa.Ia&&a.pa.Ia((c.pageX-d.left-b-a.Ga)/a.scale,(c.pageY-d.top-b-a.Fa)/a.scale,c);c.preventDefault()});Na(p(a.canvas),function(c){var d=p(a.canvas).offset();a.pa.Ma&&a.pa.Ma((c.pageX-d.left-b-a.Ga)/a.scale,(c.pageY-d.top-b-a.Fa)/a.scale,c);c.stopPropagation();c.preventDefault()});p(a.canvas).click(function(c){var d=
p(a.canvas).offset();a.pa.pb&&a.pa.pb((c.pageX-d.left-b-a.Ga)/a.scale,(c.pageY-d.top-b-a.Fa)/a.scale,c);c.stopPropagation();c.preventDefault()});La(p(a.canvas),function(c){var d=p(a.canvas).offset();if(a.pa.dc||a.pa.pb){var e=(c.pageX-d.left-b-a.Ga)/a.scale,d=(c.pageY-d.top-b-a.Fa)/a.scale;pc()&&a.pa.pb&&(a.log("Insert false mouse click for IE"),a.pa.pb(e,d));a.pa.dc&&a.pa.dc(e,d,c)}c.stopPropagation();c.preventDefault()});p(a.canvas).bind("mouseenter",function(a){a.stopPropagation();a.preventDefault()});
p(a.canvas).bind("mouseleave",function(a){a.stopPropagation();a.preventDefault()});p(a.canvas).bind("mouseover",function(a){a.stopPropagation();a.preventDefault()});p(a.canvas).bind("mouseout",function(a){a.stopPropagation();a.preventDefault()});!window.parent&&a.ea.get("setFocus")&&p(a.canvas).focus();a.jd.bind("colour",function(b){a.pa.wb&&a.pa.wb(b)});a.jd.bind("opacity",function(b,c){a.pa.Nb&&a.pa.Nb(b,c)});var f="mousewheel";"onwheel"in document.createElement("div")&&(f="wheel");a.log("Binding to '%s' for mouse wheel",
f);p(a.canvas).bind(f,function(c){var d=c.$a.wheelDelta||-40*c.$a.deltaY,e=d/120*32,f=p(a.canvas).offset(),n=(c.pageX-f.left-b-a.Ga)/a.scale,f=(c.pageY-f.top-b-a.Fa)/a.scale;a.pa.Ad&&!1!==a.pa.Ad(n,f,e,c.$a)||"block"!==a.$.canvas.style.display||(n=zf(a),a.Fa=-120>=d?Math.max(a.Fa+e,-(n.bottom()*a.scale-a.canvas.height)):Math.min(a.Fa+e,-n.y*a.scale),J(a),a.ma(),c.stopPropagation(),c.preventDefault())})}function tf(a,b){return C(a,b.pageX,b.pageY)}
function Yd(a,b,c){var d=uf(a),e=p(a.canvas).offset();return new E(b*a.scale+a.Ga+e.left+d,c*a.scale+a.Fa+e.top+d)}function C(a,b,c){var d=uf(a),e=p(a.canvas).offset();return a.Sa(new E((b-e.left-d-a.Ga)/a.scale,(c-e.top-d-a.Fa)/a.scale))}
function Lf(a,b){var c;a.log("Zooming to: %s",b);var d=a.canvas.width-20;c="width"in a.ja.fa;var e=!0;a.oa=b;c||(a.log("WARNING: Cannot zoom to page/width because the document size has not been set."),e=!1);if(x(b))a.scale=b;else if("none"===b||a.ja.empty()||!c)a.scale=1,a.Ga=0,a.Fa=0;else if("page"===b){c=zf(a);var f=d=0;a.scale=Math.min(a.canvas.width/c.width,a.canvas.height/c.height);a.scale*c.width<a.canvas.width&&(d+=(a.canvas.width-a.scale*c.width)/2/a.scale);a.scale*c.height<a.canvas.height&&
(f+=(a.canvas.height-a.scale*c.height)/2/a.scale);"centre"===a.ea.get("pagePlacement")&&(a.Ga=-(c.x-d)*a.scale);a.Fa=-(c.y-f)*a.scale;a.log("RECT=%s scale=%s tx=%s",c,a.scale,a.Ga);a.oa=b}else"width"===b&&(c=zf(a),a.scale=d/c.width,a.Ga=-c.x*a.scale,a.Fa=-c.y*a.scale,a.log("RECT=%s scale=%s tx=%s ty=%s",c,a.scale,a.Ga,a.Fa),a.oa=b);J(a);a.ma();return e}function dg(a,b,c){a.ua[b]=c;"fillStyle"===b?a.Xa=c:"strokeStyle"===b&&(a.bb=c)}
function Kf(a,b){a.log("setDocument()");I(a);a.ja=b;a.scale=1;a.Ga=0;a.Fa=0;a.selection=[];a.Ca=null;a.qb=1;a.ba=new P(0,0,0,0);a.Qc=new ud(a.ba);a.ec=new Q;a.Kc=!0;a.ub=null;a.Ha="default";a.Xa="#ffffff";a.gb=a.ea.ra.defaultBrushColour;a.bb=a.ea.ra.defaultStrokeStyle;a.ua={};a.ua.lineWidth=a.ea.ra.defaultLineWidth;a.ua.sloppiness=.5;a.ua.fontName=a.ea.ra.defaultFont;a.ua.fontSize=a.ea.ra.defaultFontsize;a.ua.bold=a.ea.ra.defaultBold;a.ua.italic=a.ea.ra.defaultItalic;a.ua.smoothness=.3;a.ua.textFillStyle=
a.ea.ra.defaultTextFillStyle;a.ua.textStrokeStyle=a.ea.ra.defaultTextStrokeStyle;a.ua.textLineWidth=a.ea.ra.defaultTextLineWidth;a.eb=a.ea.get("defaultBrushWidth");var c=zf(a);a.Ga=-c.x;a.Fa=-c.y;J(a);a.ja.ub=a.ea.get("spotHighlightColour");a.ja.vb=a.ea.get("spotHighlightZIndex");a.ja.format(a.na,a.request);a.he=new P(0,0,0,0);a.ge=new P(0,0,0,0);"none"!==a.oa?Lf(a,a.oa):(Lf(a,a.ea.get("defaultZoom")),a.ma())}function uf(a){return parseInt(p(a.canvas).da("border-left-width"),10)||0};function eg(a,b){this.methods=b;this.view=a}
eg.prototype={log:A("CustomToolBehaviour"),Bb:function(){this.log("Entering CustomToolBehaviour");this.methods.enter&&this.methods.enter()},Fb:function(){this.log("Leaving CustomToolBehaviour");this.methods.leave&&this.methods.leave()},pb:function(a,b,c){return this.methods.onMouseClick?this.methods.onMouseClick(a,b,c):!1},Ia:function(a,b,c){return this.methods.onMouseDown?this.methods.onMouseDown(a,b,c):!1},La:function(a,b,c){return this.methods.onMouseMove?this.methods.onMouseMove(a,b,c):!1},Ma:function(a,
b,c){return this.methods.onMouseUp?this.methods.onMouseUp(a,b,c):!1},dc:function(a,b,c){return this.methods.onDoubleClick?this.methods.onDoubleClick(a,b,c):!1},wb:function(a){return this.methods.onColour?this.methods.onColour(a.Qa):!1},ob:function(a){this.log("keyboard: %s",a);"cancel"===a&&(this.log("ESC pressed. Abort brush and go back to toolbar."),I(this.view),this.view.mb.emit("goto-toolbar"))},Ua:function(a){if(this.methods.onTouch)return this.methods.onTouch(a);var b;b=a.touches[0];b=C(this.view,
b.pageX,b.pageY);return"touchstart"===a.type?this.Ia(b.x,b.y,a):"touchend"===a.type?this.Ma(b.x,b.y,a):"touchmove"===a.type?this.La(b.x,b.y,a):!1},Ad:function(a,b,c,d){return this.methods.onMouseWheel?this.methods.onMouseWheel(a,b,c,d):!1},Kb:function(){return this.methods.getToolName?this.methods.getToolName():null}};function fg(a,b){this.$=a;this.name=b;this.ha=p("<div>").da("border-top","1px solid #888").da("padding","5px").da("cursor","default");this.$.append(this.ha);this.update(0)}fg.prototype={update:function(a){this.ha.text(this.name+"... "+Math.round(100*a)+"%")},error:function(a){var b=this,c=Qa();c.click(function(){b.done()});Sa(this.ha,this.name+"... "+a+" ");this.ha.append(c)},done:function(){this.ha.remove()}};function gg(a){for(var b=[],c=0;c<a;c++)b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234567890"[Math.floor(63*Math.random())]);return b.join("")}"object"===typeof module&&(exports.lg=gg);function hg(a){function b(b){c&&clearTimeout(c);c=setTimeout(function(){c=null;a()},arguments.length?b:1E3)}var c=null;b.$=function(){c&&(clearTimeout(c),c=null)};return b};function ig(a){a=a.replace(/\+/g," ");return window.decodeURIComponent?window.decodeURIComponent(a):unescape(a)}function jg(){var a;a=a||window.location.hash;0===a.indexOf("#/")&&(a="#"+a.substr(2));var b=a,c,d,e,f;a={};e=b.indexOf("#");0<=e&&(b=b.substr(e+1));e=b.indexOf("#");0<=e&&(b=b.substr(0,e));b=b.split("&");e=0;for(f=b.length;e<f;e++)c=b[e],d=c.split("="),c=ig(d[0]),d=1<d.length?ig(d[1]):"",c.length&&(a[c]=d);return a};var kg,lg,mg;mg=document.getElementsByTagName("script");lg=mg[mg.length-1];kg=void 0!==lg.getAttribute.length?lg.src:lg.getAttribute("src",-1);
function ng(a){var b,c;this.ra={angleArcs:0,allowSelectBox:"auto",allowResize:!0,allowTextInShape:!0,allowZoom:!0,autoPickTool:!0,background:"clear",backgroundImage:null,colourPicker:"wheel",colourPalette:"#000000 #ffffff #000088 #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" "),debug:!1,defaultArrowStyle:"simple",defaultArrowSize:15,defaultItalic:!1,defaultBold:!1,defaultBrushColour:"#000000",defaultBrushWidth:10,defaultFillStyle:"#e0e0e0",
defaultFont:"Arial",defaultFontSize:20,defaultLineWidth:2,defaultPaperSize:"none",defaultRoundRectRadius:10,defaultSmoothness:"smooth",defaultStrokeStyle:"#000000",defaultText:"Lorum ipsum dolor",defaultTextFillStyle:"#000000",defaultTextStrokeStyle:"#000000",defaultTextLineWidth:0,defaultZoom:1,fonts:["Arial","Times New Roman"],gridBlocks:10,gridSpacing:20,gridColour:"#cccccc",imageFolder:"$SCRIPT",iPadNoScrollText:!1,keyBringToFront:"Home",keyCancel:"ESC",keyCopy:"Ctrl+C,\u2318+C",keyCurveTool:"C",
keyCut:"Ctrl+X,\u2318+X,Shift+Delete",keyDelete:"Delete,Backspace",keyDown:"Down,Ctrl+Down",keyDuplicate:"Ctrl+D",keyEnter:"Enter",keyGroup:"Ctrl+G",keyLeft:"Left,Ctrl+Left",keyLineTool:"L",keyMoveDown:"PageDown",keyMoveUp:"PageUp",keyNext:"Down,Right",keyNextPage:"Shift+PageDown",keyPaste:"Ctrl+V,\u2318+V,Shift+Insert",keyPrevious:"Left,Up",keyPreviousPage:"Shift+Pageup",keyRedo:"Ctrl+Shift+Z",keyRight:"Right,Ctrl+Right",keySelectNone:"ESC",keySelectAll:"Ctrl+A",keySendToBack:"End",keyUndo:"Ctrl+Z",
keyUngroup:"Ctrl+Shift+G",keyUp:"Up,Ctrl+Up",keyZoomIn:"+,Shift+=",keyZoomNormal:"=",keyZoomOut:"-",keyZoomToPage:"F4",keyZoomToWidth:"Shift+F4",language:"en",multilineText:!1,nudge:10,outsidePageColour:"#808080",pagePlacement:"centre",pageSelectorDiv:"",pageShadow:!0,pageView:!1,pasteOffset:10,persistent:!1,preciseNudge:1,readOnly:!1,scrollbars:!0,setFocus:!0,showArrowTool:!0,showBackgroundSelector:!1,showBrushTool:!0,showCircleTool:!0,showColourPanel:!0,showCopyPaste:!0,showCurveTool:!0,showDebug:!1,
showFontNameProperty:!0,showFontSizeProperty:!0,showHints:!0,showImageSelector:!1,showImageTool:!1,showKeyboardHelp:!0,showLineTool:!0,showMathTool:!1,showMoveToFrontBack:!1,showPageSelector:!1,showPageSelectorControls:!0,showPickTool:!0,showPropertyPanel:!1,showRoundRectTool:!1,showShapeBrushTool:!1,showSloppinessProperty:!0,showSmoothnessProperty:!0,showSquareTool:!0,showTextTool:!0,showToolbar:!0,showUndoRedo:!0,singleStrokeBrush:!1,sloppy:!1,snap:0,spotHighlightColour:"rgba(0,0,0,0.2)",spotHighlightZIndex:0,
symmetry:0,textMode:"interactive",toolbarButtonSize:50,useTouch:"auto",enableArrowKeysNudge:!1,showMenu:!1};for(c in a)a.hasOwnProperty(c)&&(c in this.ra||alert("Zwibbler: Unknown option '"+c+"'"),this.ra[c]=a[c]);a=jg();for(c in a)a.hasOwnProperty(c)&&og(this,c,a[c]);""===pg()?(this.$=this.ra.imageFolder.replace("$SCRIPT/",""),this.$=this.$.replace("$SCRIPT","")):this.$=this.ra.imageFolder.replace("$SCRIPT",pg());""!==this.$&&"/"!==this.$[this.$.length-1]&&(this.$+="/");"auto"===this.ra.useTouch&&
(c="ontouchstart"in window||"onmsgesturechange"in window,this.log("Detected touch support: %s",c));for(b in this.ra)this.ra.hasOwnProperty(b)&&this.log("%s=%s",b,this.ra[b])}
ng.prototype={log:A("CONFIG"),Lf:function(){return this.ra.showBrushTool},fe:function(){return this.ra.showPropertyPanel},Mf:function(){return this.ra.showColourPanel},Nf:function(){return this.ra.showToolbar},get:function(a){return this.ra[a]},Hb:function(){return"auto"===this.ra.useTouch?"ontouchstart"in window||"onmsgesturechange"in window:this.ra.useTouch}};
function qg(a,b){for(var c in a.ra)if(a.ra.hasOwnProperty(c)&&0===c.indexOf("key")){for(var d="",e=0;e<c.length;e++)var f=c.charAt(e),d=f===f.toUpperCase()?d+("-"+f.toLowerCase()):d+f;b.map(a.ra[c],d.substr(4))}}function rg(a){a=a.get("pageSelectorDiv");return void 0!==a.className?a:""!==a&&p(a).length?p(a)[0]:null}function X(a,b){return 0===b.indexOf("http:")||0===b.indexOf("https:")||0===b.indexOf("/")?b:a.$+b}
function pg(){var a,b;b=kg;a=b.lastIndexOf("/");0<=a?b=b.substr(0,a+1):b="";return b}
function og(a,b,c){if(!(b in a.ra))return a.log("Error: %s is not a configuration option.",b),!1;if("defaultZoom"===b){if("page"!==c&&"width"!==c&&!x(c)&&(c=parseFloat(c),isNaN(c)))return a.log("Error: Config option %s must be a number or 'page' or 'width'",b),!1}else if("string"===typeof c)if("number"===typeof a.ra[b]){if(c=parseFloat(c),isNaN(c))return a.log("Error: Config option %s expects a number",b),!1}else"boolean"===typeof a.ra[b]&&(c="1"===c||"true"===c||""===c);a.log("Set config %s=%s",
b,c);a.ra[b]=c;a.uc("update",b,c);return!0}ng.prototype=p.$({},M.prototype,ng.prototype);function sg(a){tg(this,a)}function tg(a,b){a.ha=b||p("<div>");a.ha.da("position","absolute");a.ha.da("margin","0px");a.ha.da("padding","0px");p("body").append(a.ha)}m=sg.prototype;m.width=function(a){function b(a){a=parseInt(c.ha.da(a),10);return isNaN(a)?0:a}var c=this;if(void 0===a)return this.ha.outerWidth();a-=b("border-left-width");a-=b("border-right-width");a-=b("padding-right");a-=b("padding-left");a-=b("margin-left");a-=b("margin-right");a=Math.max(0,a);this.ha.da("width",""+a+"px")};
m.height=function(a){function b(a){a=parseInt(c.ha.da(a),10);return isNaN(a)?0:a}var c=this;if(void 0===a)return this.ha.outerHeight();a-=b("border-top-width");a-=b("border-bottom-width");a-=b("padding-top");a-=b("padding-bottom");a-=b("margin-top");a-=b("margin-bottom");this.ia=a=Math.max(0,a);this.ha.da("height",""+this.ia+"px")};m.moveTo=function(a,b){null!==a&&this.ha.da("left",""+a+"px");null!==b&&this.ha.da("top",""+b+"px")};m.show=function(){this.ha.show()};m.Ka=function(){this.ha.Ka()};function ug(a){sg.apply(this,arguments);var b=this;this.ha.da("background","black");this.ha.da("font-family",'"Lucida Console","Dejavu Sans Mono",Monospace,"Courier New"');this.ha.da("font-size","10px");this.ha.da("line-height","12px");this.ha.da("overflow","scroll");this.ha.da("cursor","default");this.oa=0;this.la={};this.ab=!1;ra(function(a,d){return vg(b,a,d)});this.ba=null;this.aa=[];vg(this,"DEBUG","Debug window starting")}
ug.prototype={$:"#ffffff #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" "),show:function(){sg.prototype.show.call(this);this.ab=!0;wg(this);this.ha[0].scrollTop=this.ha[0].scrollHeight},Ka:function(){this.ab=!1;sg.prototype.Ka.call(this)}};
function wg(a){var b,c,d,e,f,g;g=a.aa;e=0;for(f=g.length;e<f;e++){c=g[e];d=c.key;c=c.uf;b=a;var h=d;h in b.la||(b.la[h]=b.$[b.oa],b.oa=(b.oa+1)%b.$.length);b=b.la[h];b=p("<div>").da("color",b);b.da("border-bottom","1px solid #222");b.text(""+d+": "+c);a.ha.append(b)}a.ha[0].scrollTop=a.ha[0].scrollHeight;a.ba=null;a.aa.length=0}function vg(a,b,c){var d,e,f;f=c.split("\n");d=0;for(e=f.length;d<e;d++)c=f[d],a.aa.push({key:b,uf:c});a.ab&&null===a.ba&&(a.ba=setTimeout(function(){return wg(a)},100))}
Mc(sg.prototype,ug.prototype);function xg(a){var b=p("<div>");tg(this,b);a.append(this.ha);this.oa={};this.aa=128;this.$=0;this.ha.da("overflow-x","auto");this.ha.da("overflow-y","auto");this.ta=0;this.la=1;this.ba=[];this.Ea=null}
xg.prototype={on:function(a,b){this.oa[a]=b},log:A("ListView"),format:function(){var a,b,c,d,e;b=null;e=this.ba;c=0;for(d=e.length;c<d;c++){a=e[c];if(!a.Sd){if(null===b){b=this.ha;var f=a.Pa,f=Ea(f);0<b.length?b[0].insertBefore(f[0],b[0].firstChild):b[0].appendChild(f[0])}else Ta(b.Pa,a.Pa);a.Sd=!0}b=a}}};function yg(a){a.ha.empty();a.ba.length=0;a.la+=1}
function zg(a,b,c,d){var e,f;f=a.la;e={Pa:null,index:a.ta,Sd:!1};a.ta+=1;Ib(b,function(b){var h,l;f===a.la&&(l=b.width,h=b.height,a.aa&&l>a.aa&&(b.width=a.aa,b.height=h/l*a.aa),a.$&&h>a.$&&(b.width=a.$/(h/l),b.height=a.$),b=p(b),b.da("margin","2px"),b.da("border-width","3"),b.da("border-color","white"),b.da("border-style","solid"),b.da("image-rendering","optimizeQuality"),Ka(b,function(){a.log("Mouseenter");return b.da("border-color","#888888")}),Ja(b,function(){return b.da("border-color","white")}),
b.click(function(){if("click"in a.oa)return a.oa.click(c)}),d&&b.Va("title",d),e.Pa=b,a.ba.push(e),a.ba.sort(function(a,b){return a.index-b.index}),a.Ea||(a.Ea=setTimeout(function(){a.Ea=null;a.format()},500)))})}xg.prototype=p.$({},sg.prototype,xg.prototype);function Ag(a,b){this.ea=a;this.la=b;tg(this,p("<div>"));Ra(this.ha,"PropertyPanel");this.$=[];this.aa={};this.view=null;this.za=[];(this.oa=Kc()&&"wheel"===a.get("colourPicker"))||this.log("ColourWheel not supported in this canvas.");this.action=null;this.ha.da("background","#ffffff");this.ha.da("border","none");this.ha.da("font-family","tahoma,arial,helvetica,sans");this.ha.da("color","#4fa0d3");this.ha.da("font-weight","bold");this.ha.da("font-size","10pt");this.ha.da("overflow-y","scroll");var c=
this;this.ha.click(function(){c.log("PropertyPanel clicked.");c.emit("click")});this.ba=null}Ag.prototype={log:A("PROP"),on:function(a,b){if("click"===a)this.ba=b;else throw"This object only handles the click event";},emit:function(){this.ba&&this.ba()},apply:function(a,b){this.view.setProperty(a,b)}};function Bg(a,b,c,d){null!==a.action&&a.action.name===d.name||a.view.setProperty(d.name,b);c.value=b}
function Cg(a,b){if(!b.Qd)if(a.oa){var c=document.createElement("div"),d=new Hc(c,120);Jc(d,b.input.value);d.Ja=function(c){Bg(a,c,b.input,b.input.yb)};b.fg=d;b.Qd=!0;b.parentNode.appendChild(c)}else{c=new vc(p(b.parentNode),20,!1,!0);c.ha.da("position","static");yc(c,a.ea.get("colourPalette"));b.fg=c;b.Qd=!0;b.parentNode.appendChild(c.ha[0]);var e;c.on("colour",function(c){Bg(a,c.Qa,b.input,b.input.yb);c=cc(c.Qa).values[3];e.value=Math.round(100*c)});e=Vc();e.min=0;e.max=100;var f=cc(b.input.value);
e.ee(Math.round(100*f.values[3]));e.onchange=function(){f=cc(b.input.value);f.values[3]=e.value/100;Bg(a,f.toString(),b.input,b.input.yb)};b.parentNode.appendChild(document.createElement("br"));b.parentNode.appendChild(e)}}
function cg(a){function b(){Cg(a,this)}function c(){var b=this;"timer"in b&&clearTimeout(b.timer);b.timer=setTimeout(function(){a.apply(b.yb.name,b.value)},250)}function d(){a.view.log("Someone clicked a button for %s",this.yb.name)}function e(b){13===b.keyCode&&a.apply(this.yb.name,this.value)}function f(){a.apply(this.yb.name,this.yb.values[parseInt(this.value,10)].value)}p(a.ha).empty();var g,h;for(g=0;g<a.$.length;g++){var l=a.$[g],k=l.Bd;if("none"!==k.type){var n=document.createElement("div");
h=document.createElement("span");h.appendChild(document.createTextNode(k.display));n.appendChild(h);n.appendChild(document.createElement("br"));if("select"===k.type){var q=document.createElement("select");for(h=0;h<k.values.length;h++){var r=k.values[h],t=document.createElement("option");t.appendChild(document.createTextNode(r.name));t.setAttribute("value",h);r.value===l.value&&t.setAttribute("selected","");q.appendChild(t)}q.yb=k;q.onchange=f;n.appendChild(q)}else if("colour"===k.type)h=document.createElement("input"),
h.setAttribute("type","text"),h.value=l.value,h.yb=k,Pa(p(h),e),n.appendChild(h),l=document.createElement("img"),l.src=X(a.ea,"wd-wheel.png"),l.style.verticalAlign="middle",l.input=h,n.appendChild(l),p(l).click(b);else if("text"===k.type)h=document.createElement("input"),h.setAttribute("type","text"),h.value=l.value,h.yb=k,Pa(p(h),e),n.appendChild(h);else if("textarea"===k.type)h=document.createElement("textarea"),h.setAttribute("rows","3"),h.setAttribute("cols","20"),h.value=l.value,h.yb=k,Pa(p(h),
c),n.appendChild(h);else if("button"===k.type)h=document.createElement("input"),h.setAttribute("type","button"),h.value="Edit",h.yb=k,p(h).click(d),n.appendChild(h);else throw"Error: No such property";a.ha.append(n)}}}
function bg(a,b,c){var d=a.la.bc();if("strokeStyle"===c)return{name:c,type:"colour",display:d("outline-colour")};if("fillStyle"===c)return{name:c,type:"colour",display:d("fill-colour")};if("lineWidth"===c)return a=[{name:d("thickness-pencil"),value:1},{name:d("thickness-pen"),value:2},{name:d("thickness-marker"),value:4},{name:d("thickness-brush"),value:10}],!0!==b.sa("closed")&&"TextNode"!==b.type()||a.unshift({name:d("none"),value:0}),{name:c,display:d("outline-thickness"),type:"select",values:a};
if("sloppiness"===c)return{name:"sloppiness",display:d("sloppiness"),type:"select",values:[{name:d("sloppiness-draftsman"),value:0},{name:d("sloppiness-artist"),value:.25},{name:d("sloppiness-cartoonist"),value:.5},{name:d("sloppiness-child"),value:1},{name:d("sloppiness-drunk"),value:2}]};if("smoothness"===c)return{name:"smoothness",display:d("smoothness"),type:"select",values:[{name:d("smoothness-sharpest"),value:0},{name:d("smoothness-sharper"),value:.1},{name:d("smoothness-sharp"),value:.2},{name:d("smoothness-smooth"),
value:.3},{name:d("smoothness-smoothest"),value:.5}]};if("shadow"===c)return{name:"shadow",display:d("shadow"),type:"select",values:[{name:d("yes"),value:!0},{name:d("no"),value:!1}]};if("dashes"===c)return{name:"dashes",display:d("line-style"),type:"select",values:[{name:d("line-style-solid"),value:""},{name:d("line-style-short-dashes"),value:"5,5"},{name:d("line-style-long-dashes"),value:"10,5"}]};if("matrix"===c||"inverse"===c||"closed"===c||"commands"===c||"seed"===c)return{name:c,type:"none"};
if("text"===c)return{name:"text",display:d("text"),type:"textarea"};if("textFillStyle"===c)return{name:"textFillStyle",display:d("text-colour"),type:"colour"};if("fontSize"===c)return{name:"fontSize",display:d("font-size"),type:"select",values:[{name:"10",value:10},{name:"12",value:12},{name:"15",value:15},{name:"20",value:20},{name:"30",value:30},{name:"40",value:40},{name:"50",value:50},{name:"60",value:60},{name:"100",value:100}]};if("fontName"===c){b=[];c=a.ea.ra.fonts;for(a=0;a<c.length;a++)b.push({name:c[a],
value:c[a]});return{name:"fontName",display:d("font"),type:"select",values:b}}return"arrowSize"===c?{name:"arrowSize",display:d("arrowhead-size"),type:"select",values:[{name:d("arrowhead-size-none"),value:0},{name:d("arrowhead-size-tiny"),value:10},{name:d("arrowhead-size-small"),value:15},{name:d("arrowhead-size-medium"),value:20},{name:d("arrowhead-size-large"),value:30}]}:"arrowStyle"===c?{name:"arrowStyle",display:d("arrowhead-style"),type:"select",values:[{name:d("arrowhead-style-simple"),value:"simple"},
{name:d("arrowhead-style-solid"),value:"solid"}]}:"doubleArrow"===c?{name:"doubleArrow",display:d("double-arrows"),type:"select",values:[{name:d("no"),value:!1},{name:d("yes"),value:!0}]}:"url"===c?{name:"url",display:d("image-url"),type:"text"}:"rows"===c?{name:c,display:"Rows",type:"text"}:"columns"===c?{name:c,display:"Columns",type:"text"}:{name:c,display:"Display-"+c,type:"text"}}Ag.prototype=p.$({},sg.prototype,Ag.prototype);function Dg(){this.wa=new Q;this.ia=[];this.lineCap="butt";this.lineJoin="miter";this.strokeStyle="#000000";this.lineWidth=1;this.fillStyle="#000000";this.textBaseline="top";this.font="10pt arial"}
Dg.prototype={save:function(){this.ia.push({fillStyle:this.fillStyle,font:this.font,lineJoin:this.lineJoin,lineCap:this.lineCap,lineWidth:this.lineWidth,wa:this.wa.clone(),strokeStyle:this.strokeStyle,textBaseline:this.textBaseline})},restore:function(){var a=this.ia.pop();this.fillStyle=a.fillStyle;this.font=a.font;this.lineJoin=a.lineJoin;this.lineCap=a.lineCap;this.lineWidth=a.lineWidth;this.wa=a.wa;this.strokeStyle=a.strokeStyle;this.textBaseline=a.textBaseline},strokeRect:function(a,b,c,d){this.beginPath();
this.rect(a,b,c,d);this.stroke()},rect:function(a,b,c,d){this.beginPath();this.moveTo(a,b);this.lineTo(a+c,b);this.lineTo(a+c,b+d);this.lineTo(a,b+d);this.lineTo(a,b);this.closePath()},fillRect:function(a,b,c,d){this.rect(a,b,c,d);this.fill()},jc:function(a){var b=null,c=null,d="normal",e="normal",f="normal",g="normal";a=a.split(/\s+/);a:for(;;){var h=a.shift();if(!h)break;switch(h){case "normal":break;case "italic":case "oblique":d=h;break;case "small-caps":f=h;break;case "bold":case "bolder":case "lighter":case "100":case "200":case "300":case "400":case "500":case "600":case "700":case "800":case "900":e=
h;break;default:if(!c){h=h.split("/");c=h[0];1<h.length&&(g=h[1]);break}b=h;a.length&&(b+=" "+a.join(" "));break a}}return{fontStyle:d,fontVariant:f,fontWeight:e,fontSize:c,lineHeight:g,fontFamily:b}}};function Eg(a,b,c,d){this.x=a;this.y=b;this.width=c;this.height=d;this.aa=[];this.ba=Fg(this,"Pages",{Kids:[],Count:0});this.oa=Fg(this,"Catalog",{Pages:this.ba._id+" 0 R"});this.fonts={};this.ia={};this.la={};this.$=1;Gg(this)}
Eg.prototype={log:A("PdfWriter"),Rc:function(){for(var a=Hg(this),b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=a.charCodeAt(c);return new Blob([b],{type:"application/pdf"})},Db:function(a){for(var b=[],c=0;c<arguments.length;c++){var d=""+arguments[c];0<d.indexOf("e")&&(d=arguments[c].toFixed(20));b.push(d)}return b.join(" ")}};
function Ig(a,b,c,d,e){e?b.push("<<\n"):(c.push(b.join("").length),b.push(d._id+" 0 obj\n"),"Type"in d?b.push("<< /Type /"+d.Type+"\n"):b.push("<<\n"));"_stream"in d&&(d.Length=d._stream.toString().length);for(var f in d)if(d.hasOwnProperty(f)&&"Type"!==f&&"_"!==f.charAt(0)){e&&b.push("    ");b.push("   /"+f+" ");var g=d[f];"object"===typeof g&&"[object Array]"===Object.prototype.toString.apply(g)?b.push("[ "+g.join(" ")+" ]"):"object"===typeof g?Ig(a,b,c,g,!0):b.push(g);b.push("\n")}e&&b.push("    ");
b.push(">>\n");"_stream"in d&&(b.push("stream\n"),b.push(d._stream+"\n"),b.push("endstream\n"));e||b.push("endobj\n")}
function Hg(a){var b=[],c=[],d;b.push("%PDF-1.4\n%\u0080\u0081\u0082\u0083\n");for(d=0;d<a.aa.length;d++)Ig(a,b,c,a.aa[d],!1);var e=b.join("").length;b.push("xref\n0 "+(a.aa.length+1)+"\n");b.push("0000000000 65535 f\n");for(d=0;d<a.aa.length;d++){for(var f=c[d],f=""+f;10>f.length;)f="0"+f;b.push(f+" 00000 n \n")}b.push("trailer\n");b.push("<< /Size "+(a.aa.length+1)+"\n");b.push("   /Root "+a.oa._id+" 0 R\n");b.push(">>\n");b.push("startxref\n");b.push(e+"\n");b.push("%%EOF\n");return b.join("")}
function Jg(a,b,c){"Resources"in a.page||(a.page.Resources={});b in a.page.Resources||(a.page.Resources[b]={});a.page.Resources[b][c._name]=c._id+" 0 R"}function Kg(a,b,c){var d=""+b+"-"+c;if(!(d in a.la)){var e="gs"+a.$;a.$+=1;var f=Fg(a,"ExtGState",{_name:e});c?f.ca=a.Db(b):f.CA=a.Db(b);a.la[d]=e;Jg(a,"ExtGState",f)}return a.la[d]}function Fg(a,b,c){var d=a.aa.length+1;b&&(c.Type=b);c._id=d;a.aa.push(c);return c}
function Gg(a,b,c,d,e){b=b||a.x;c=c||a.y;d=d||a.width;e=e||a.height;a.log("StartPage MediaBox=[%s %s %s %s]",b,c,d,e);a.page=Fg(a,"Page",{MediaBox:[b,c,b+d,c+e],Parent:a.ba._id+" 0 R"});a.ba.Kids.push(a.page._id+" 0 R");a.ba.Count+=1;a.la={}}function Lg(a,b){Dg.call(this);this.ta=b;this.la=this.Oe;this.ba=a.clone();this.ba.transform(new fd(.75,.75,0,0));this.oc="black";this.aa=new Eg(72*a.x/96,72*a.y/96,72*a.width/96,72*a.height/96);this.$=[];this.path=[];this.y=this.x=0;this.oa=[];Mg(this)}
Lg.prototype={log:A("PDFContext"),save:function(){Dg.prototype.save.call(this);this.$.push("q");this.oa.push({wa:this.wa.clone(),oc:this.oc,Ic:this.Ic,Hc:this.Hc,Gc:this.Gc,Fc:this.Fc,Ec:this.Ec,Dc:this.Dc,Cc:this.Cc})},restore:function(){Dg.prototype.restore.call(this);this.$.push("Q");var a=this.oa.pop();this.wa=a.wa;this.oc=a.oc;this.Ic=a.Ic;this.Hc=a.Hc;this.Gc=a.Gc;this.Fc=a.Fc;this.Ec=a.Ec;this.Dc=a.Dc;this.Cc=a.Cc},beginPath:function(){this.path.length=0},toString:function(){Ng(this);return Hg(this.aa)},
Rc:function(){Ng(this);return this.aa.Rc()},setTransform:function(a,b,c,d,e,f){var g=ad(this.ba);this.wa=(new Q(a,c,b,d,e,f)).multiply(new id(0,g.x,g.y)).multiply(new fd(.75,.75,0,0))},transform:function(a,b,c,d,e,f){a=new Q(a,c,b,d,e,f);this.wa=this.wa.multiply(a)},translate:function(a,b){this.transform(1,0,0,1,a,b)},scale:function(a,b){this.transform(a,0,0,b,0,0)},closePath:function(){this.path.push("h")},fill:function(){Og(this);for(var a=0;a<this.path.length;a++)this.$.push(this.path[a]);this.$.push("f")},
stroke:function(){Pg(this);for(var a=0;a<this.path.length;a++)this.$.push(this.path[a]);this.$.push("S")},moveTo:function(a,b){var c=this.wa.apply(a,b);this.path.push(this.aa.Db(c.x,c.y)+" m");this.x=a;this.y=b},lineTo:function(a,b){var c=this.wa.apply(a,b);this.path.push(this.aa.Db(c.x,c.y)+" l");this.x=a;this.y=b},quadraticCurveTo:function(a,b,c,d){this.bezierCurveTo(2/3*a+1/3*this.x,2/3*b+1/3*this.y,2/3*a+1/3*c,2/3*b+1/3*d,c,d)},bezierCurveTo:function(a,b,c,d,e,f){a=this.wa.apply(a,b);c=this.wa.apply(c,
d);d=this.wa.apply(e,f);this.path.push(this.aa.Db(a.x,a.y,c.x,c.y,d.x,d.y)+" c");this.x=e;this.y=f},arc:function(){},fillText:function(a,b,c){this.la(a,b,c,0)},strokeText:function(a,b,c){this.la(a,b,c,1)},Oe:function(a,b,c,d){var e,f,g=this.jc(this.font),h=this.ta.get(g.fontFamily);if(h){0===d?Og(this):Pg(this);this.beginPath();g=parseFloat(g.fontSize);this.save();this.translate(b,c);h.transform(this,g);for(g=c=b=0;g<h.yc.length;g++)h.yc[g].reset();for(g=0;g<a.length;g++){var l,k=h;l=a.charCodeAt(g);
var n=0;for(e=0;e<k.la.length&&!(n=k.la[e].map(l));e++);l=n;k=h;n=l;u("hmtx"in k.$);e=k.aa;f=e.seek(k.$.hmtx.offset+4);var q=k.$.hmtx.offset,r={};n<k.ia?(q+=4*n,f=k.aa.seek(q),r.rd=e.getUint16()):(f=e.seek(q+4*(k.ia-1)),r.rd=e.getUint16(),e.seek(q+4*k.ia+2*(n-k.ia)));r.tf=e.getInt16();k.aa.seek(f);k=r;e=h;f=l;for(var q=void 0,t=n=r=0;t<e.yc.length;t++)q=e.yc[t].get(f),r+=q.x,n+=q.y;e=r;f=n;h.log("Metrics for %s code %s index %s: %s %s kern: %s,%s",a.charAt(g),a.charCodeAt(g),l,k.rd,k.tf,e,f);n=b+
e;e=c+f;l=$b(h,l);if(null!==l&&"simple"===l.type)for(var t=r=q=f=0,v=void 0;q<l.qa.length;q++){var w=l.qa[q];0===f?(this.moveTo(w.x+n,w.y+e),f=1):1===f?w.mc?this.lineTo(w.x+n,w.y+e):f=2:(v=l.qa[q-1],w.mc?(this.quadraticCurveTo(v.x+n,v.y+e,w.x+n,w.y+e),f=1):this.quadraticCurveTo(v.x+n,v.y+e,(v.x+w.x)/2+n,(v.y+w.y)/2+e));q===l.Rb[r]&&(2===f&&(v=w,w=l.qa[t],w.mc?this.quadraticCurveTo(v.x+n,v.y+e,w.x+n,w.y+e):this.quadraticCurveTo(v.x+n,v.y+e,(v.x+w.x)/2+n,(v.y+w.y)/2+e)),t=q+1,r+=1,f=0)}b+=k.rd}this.restore();
0===d?this.fill():this.stroke()}else{h=this.jc(this.font);if(this.Ec!==h.fontSize||this.Dc!==h.fontFamily)g=this.aa,k=h.fontFamily,k in g.fonts||(l="F"+g.$,g.$+=1,n="/"+k.replace(/ /g,""),l=Fg(g,"Font",{_name:l,BaseFont:n,Encoding:"/StandardEncoding",Subtype:"/Type1"}),g.fonts[k]=l),Jg(g,"Font",g.fonts[k]),this.$.push("/"+g.fonts[k]._name+" "+this.aa.Db(parseFloat(h.fontSize))+" Tf"),this.Ec=h.fontSize,this.Dc=h.fontFamily;this.Cc!==d&&(this.$.push(d+" Tr"),this.Cc=0);0===d?Og(this):Pg(this);this.$.push("BT");
d=this.wa.multiply(new Q(1,0,0,-1,b,c));this.$.push(this.aa.Db(d.m11,d.m21,d.m12,d.m22,d.Aa,d.Ba)+" Tm");this.$.push("("+a.replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")+") Tj");this.$.push("ET")}},jc:function(a){var b=null,c=null,d="normal",e="normal",f="normal",g="normal";a=a.split(/\s+/);a:for(;;){var h=a.shift();if(!h)break;switch(h){case "normal":break;case "italic":case "oblique":d=h;break;case "small-caps":f=h;break;case "bold":case "bolder":case "lighter":case "100":case "200":case "300":case "400":case "500":case "600":case "700":case "800":case "900":e=
h;break;default:if(!c){h=h.split("/");c=h[0];1<h.length&&(g=h[1]);break}b=h;a.length&&(b+=" "+a.join(" "));break a}}b&&(b=b.replace(/"/g,""));return{fontStyle:d,fontVariant:f,fontWeight:e,fontSize:c,lineHeight:g,fontFamily:b}},drawImage:function(a,b,c,d,e,f,g,h,l){var k=parseInt(a.width,10),n=parseInt(a.height,10);if(3===arguments.length)return this.drawImage(a,0,0,k,n,arguments[1],arguments[2],k,n);if(5===arguments.length)return this.drawImage(a,0,0,k,n,arguments[1],arguments[2],arguments[3],arguments[4]);
this.log("DrawImage(%s, %s, %s, %s, %s, %s, %s %s)",b,c,d,e,f,g,h,l);g=g+l;k=document.createElement("canvas");n=k.getContext("2d");k.width=d;k.height=e;n.drawImage(a,-b,-c);var n=this.aa,q=[a.src,b,c,d,e].join(),r;if(!(q in n.ia)){var t="I"+n.$;n.$+=1;var v=k.getContext("2d").getImageData(0,0,k.width,k.height);r="";var w=!1,z=Xa();for(r=0;r<v.data.length;r+=4)z.Ya(v.data[r]),z.Ya(v.data[r+1]),z.Ya(v.data[r+2]),w=w||255>v.data[r+3];z.flush();r=z.Zc().toString();t=Fg(n,"XObject",{Subtype:"/Image",Width:k.width,
Height:k.height,ColorSpace:"/DeviceRGB",BitsPerComponent:8,Length:r.length,Interpolate:"true",Filter:"[/ASCII85Decode /LZWDecode]",DecodeParms:"[ null << /EarlyChange 0 >> ]",_name:t,_stream:r});if(w){z=Xa();for(r=0;r<v.data.length;r+=4)z.Ya(v.data[r+3]);z.flush();r=z.Zc().toString();k=Fg(n,"XObject",{Subtype:"/Image",Width:k.width,Height:k.height,ColorSpace:"/DeviceGray",BitsPerComponent:8,Length:r.length,Filter:"[/ASCII85Decode /LZWDecode]",DecodeParms:"[ null << /EarlyChange 0 >> ]",_stream:r});
t.SMask=k._id+" 0 R"}n.ia[q]=t}Jg(n,"XObject",n.ia[q]);k="/"+n.ia[q]._name;this.$.push("q");n=this.wa.multiply(new Q(h,0,0,-l,f,g));this.$.push(this.aa.Db(n.m11,n.m21,n.m12,n.m22,n.Aa,n.Ba)+" cm");this.$.push(k+" Do");this.$.push("Q")}};
function Pg(a){function b(a){return"miter"===a?0:"round"===a?1:2}function c(a){return"butt"===a?0:"round"===a?1:2}if(a.Ic!==a.strokeStyle){var d=ec(cc(a.strokeStyle),0);a.$.push(a.aa.Db(d.values[0],d.values[1],d.values[2])+" RG");d=Kg(a.aa,d.values[3],!1);a.$.push("/"+d+" gs");a.Ic=a.strokeStyle}a.Hc!==a.lineWidth&&(a.Hc=a.lineWidth,a.$.push(a.aa.Db(a.lineWidth)+" w"));a.Gc!==a.lineJoin&&(a.Gc=a.lineJoin,a.$.push(b(a.lineJoin)+" j"));a.Fc!==a.lineCap&&(a.Fc=a.lineCap,a.$.push(c(a.lineCap)+" J"))}
function Og(a){if(a.oc!==a.fillStyle){var b=ec(cc(a.fillStyle),0);a.$.push(a.aa.Db(b.values[0],b.values[1],b.values[2])+" rg");b=Kg(a.aa,b.values[3],!0);a.$.push("/"+b+" gs");a.oc=a.fillStyle}}function Ng(a){if(a.$.length){var b=a.aa,c;c=Fg(a.aa,null,{_stream:a.$.join("\n")});b.page.Contents=c._id+" 0 R"}a.$.length=0}function Mg(a){a.log("Start page: %s",a.ba);a.setTransform(1,0,0,1,0,0)}Lg.prototype=p.$({},Dg.prototype,Lg.prototype);function Qg(a,b,c){this.name=a;this.$=b;this.children=[];this.text=c}Qg.prototype={toString:function(){var a=[];Rg(this,a,"  ");return a.join("")}};function Sg(a,b){a.children.push(b)}
function Rg(a,b,c){var d;b.push(c);b.push("<");b.push(a.name);for(d in a.$)a.$.hasOwnProperty(d)&&(b.push(" "),b.push(d),void 0!==a.$[d]&&null!==a.$[d]&&(b.push('="'),b.push(a.$[d]),b.push('"')));if(a.children.length||void 0!==a.text){b.push(">\n");for(d=0;d<a.children.length;d++)Rg(a.children[d],b,c+"  ");void 0!==a.text&&b.push(c+"  "+a.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"));b.push("</"+a.name+">")}else b.push("/>");b.push("\n")}
;function Tg(a){Dg.call(this);this.wa=new Q;this.ga=[];this.path=[];this.log("SVG context rect: %s",a);this.root=new Qg("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",version:1.2,baseProfile:"tiny",width:a.width,height:a.height,viewBox:a.x+" "+a.y+" "+a.width+" "+a.height})}
Tg.prototype={log:A("SvgContext"),kd:1,ld:2,FONT:4,node:function(a,b,c,d){function e(a,b){var d=cc(b),e=d.values[3];1>e&&(d.values[3]=1,c[a+"-opacity"]=""+e);c[a]=d.toString()}ed(this.wa)||(c.transform="matrix("+this.wa.m11+" "+this.wa.m21+" "+this.wa.m12+" "+this.wa.m22+" "+this.wa.Aa+" "+this.wa.Ba+")");b&this.kd?e("fill",this.fillStyle):c.fill="none";b&this.ld&&(e("stroke",this.strokeStyle),c["stroke-width"]=this.lineWidth,"miter"!==this.lineJoin&&(c["stroke-linejoin"]=this.lineJoin),"butt"!==
this.lineCap&&(c["stroke-linecap"]=this.lineCap));b&this.FONT&&(b=this.jc(this.font),c["font-weight"]=b.fontWeight,c["font-size"]=parseFloat(b.fontSize),c["font-style"]=b.fontStyle,c["font-family"]=b.fontFamily);Sg(this.root,new Qg(a,c,d))},toString:function(){return'<?xml version="1.0" encoding="UTF-8"?>\n'+this.root.toString()},Rc:function(){for(var a=this.toString(),b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=a.charCodeAt(c);return new Blob([b],{type:"image/svg+xml"})},beginPath:function(){this.path.length=
0},transform:function(a,b,c,d,e,f){a=new Q(a,c,b,d,e,f);this.wa=this.wa.multiply(a)},setTransform:function(a,b,c,d,e,f){this.wa=new Q(a,c,b,d,e,f)},translate:function(a,b){this.wa.Aa+=a;this.wa.Ba+=b},scale:function(a,b){this.wa=this.wa.multiply(new fd(a,b))},closePath:function(){this.path.push("Z")},fill:function(){this.node("path",this.kd,{d:this.path.join(" ")})},stroke:function(){this.node("path",this.ld,{d:this.path.join(" ")})},moveTo:function(a,b){this.path.push("M"+a+","+b)},lineTo:function(a,
b){this.path.push("L"+a+","+b)},quadraticCurveTo:function(a,b,c,d){this.path.push("Q"+a+","+b);this.path.push(c+","+d)},bezierCurveTo:function(a,b,c,d,e,f){this.path.push("C"+a+","+b);this.path.push(c+","+d);this.path.push(e+","+f)},arc:function(a,b,c,d,e,f){var g=a+c*Math.cos(d);d=b+c*Math.sin(d);a+=c*Math.cos(e);b+=c*Math.sin(e);this.path.push("M");this.path.push(g);this.path.push(d);this.path.push("A");this.path.push(c);this.path.push(c);this.path.push(0);this.path.push(f?0:1);this.path.push(0);
this.path.push(a);this.path.push(b)},fillText:function(a,b,c){this.jc(this.font);this.node("text",this.kd|this.FONT,{x:b,y:c},a)},strokeText:function(a,b,c){this.jc(this.font);this.node("text",this.ld|this.FONT,{x:b,y:c},a)},drawImage:function(a,b,c,d,e,f,g,h,l){var k=document.createElement("canvas"),n=k.getContext("2d");k.width=d;k.height=e;n.drawImage(a,-b,-c);a=k.toDataURL();Sg(this.root,new Qg("image",{transform:"matrix("+this.wa.m11+" "+this.wa.m21+" "+this.wa.m12+" "+this.wa.m22+" "+this.wa.Aa+
" "+this.wa.Ba+")",x:f,y:g,width:h,height:l,"xlink:href":a}))}};Tg.prototype=p.$({},Dg.prototype,Tg.prototype);var Ug=A("DOC");
cf.prototype.save=function(a,b){var c,d;if("list"===a)d=Vg(this),c="application/json";else if("zwibbler3"===a)c=Vg(this),d="zwibbler3."+window.JSON.stringify(c),c="application/octet-stream";else if("svg"===a)c=kf(this),d=new Tg(c),this.ma(d),c="image/svg+xml";else if("pdf"===a){c=kf(this);d=new Lg(c,window.Zwibbler.fonts);var e=this.jb;for(c=0;c<this.Jb();c++){if(0<c){var f=d;Ng(f);Gg(f.aa,f.ba.x,f.ba.y,f.ba.width,f.ba.height);Mg(f);f.beginPath()}this.ib(c);this.ma(d)}this.ib(e);c="application/pdf"}else throw"Unknown save format: "+
a;var g;if(ka(d))if("string"===b)g=d;else if("data-uri"===b)g="data:"+c+";base64,"+ha(d);else{if("blob"===b)for(e=new Uint8Array(d.length),c=0;c<d.length;c++)e[c]=d.charCodeAt(c)}else if(d.Rc&&d.toString)"string"===b?g=d.toString():"data-uri"===b?g="data:"+c+";base64,"+ha(d.toString()):"blob"===b&&(g=d.Rc());else if("object"===b)g=d;else throw"Error in ZwibblerDocument.save()";return g};
function Wg(a){if("{"===a.charAt(0))return Xg(a);if(0===a.indexOf("zwibbler3.")){var b=window.JSON.parse(a.substr(10));return Yg(b)}if(0===a.indexOf("zwibblerclip."))return b=new cf(!1),a=lf(b,a,[]),b.ya(a),pf(b),b;throw"Format detection failed.";}
function Xg(a){var b=A("IMPORT"),c=new cf,d=c.fb,e,f,g,h,l,k=[];l=function(a){var b=new Q;b.m11=a.m11;b.m12=a.m12;b.m21=a.m21;b.m22=a.m22;b.Aa=a.dx;b.Ba=a.dy;return b};g=function(a){var b=0;"arrowSize"in a&&(b=a.arrowSize,a=a.path);var c=l(a.matrix),b={strokeStyle:a.strokeStyle,fillStyle:a.fillStyle,lineWidth:a.lineWidth,smoothness:a.smoothness,sloppiness:a.sloppiness,shadow:a.shadow,arrowSize:b,seed:Math.round(65535*Math.random())};if("textNode"in a){var e=a.textNode;b.fontSize=e.fontSize;b.fontName=
e.fontName;b.text=e.text;b.textFillStyle="textFillStyle"in e?e.textFillStyle:e.fillStyle}"path"in a&&(a=a.path);var e=a.closed,f=new ve,g=a.segments;a=c.apply(a.startX,a.startY);f.moveTo(a.x,a.y);for(a=0;a<g.length;a++){var h=g[a],n;switch(h.type){case 1:n=c.apply(h.x,h.y);f.lineTo(n.x,n.y);break;case 2:n=c.apply(h.x,h.y);f.ud(n.x,n.y);break;case 3:n=c.apply(h.x1,h.y1);h=c.apply(h.x,h.y);Le(f,n.x,n.y,h.x,h.y);break;default:throw"Unknown path segment type: "+h.type;}}e&&f.close();b.commands=f.Gb();
k.push(new G("PathNode",b));d+=1};e=function(a,b){for(var c=[],e=a.children,g=e.length-1;0<=g;g--){var h=d;try{f(e[g],b+1)}catch(l){continue}c.push(h)}0<b&&(d+=1,k.push(new Te(c)))};h=function(a){var b=l(a.matrix),b=b.multiply(new H(0,1.3*a.fontSize));a={fillStyle:a.fillStyle,lineWidth:0,text:a.text,fontName:a.fontName,fontSize:a.fontSize,matrix:b,inverse:b.inverse()};k.push(new G("TextNode",a));d+=1};f=function(a,b){switch(a.type){case "Node":e(a,b);break;case "PathNode":case "ArrowNode":g(a);break;
case "TextNode":h(a);break;default:throw"Unknown node type: "+a.type;}};var n;try{n=window.JSON.parse(a)}catch(q){a=a.replace(/\\\\/g,"\\").replace(/\\"/g,'"');try{n=window.JSON.parse(a)}catch(r){throw b("Couldn't parse file."),"Couldn't parse file.";}}b("Successfully parsed!");f(n,0);c.ya(k);return c}
function Vg(a){function b(a,d){var e={id:d.id,type:d.type()};c.push(e);a&&(e.parent=a.id);var f=he(d),n;for(n in f)f.hasOwnProperty(n)&&("matrix"===n?e[n]=f[n].Gb():"inverse"!==n&&(e[n]=f[n]));if(je(d))for(e=0;e<d.children.length;e++)b(d,d.children[e])}var c=[],d={type:"document"},e=!1,f;for(f in a.fa)a.fa.hasOwnProperty(f)&&(d[f]=a.fa[f],e=!0);e&&c.push(d);b(null,a.root);return c}
function Yg(a){function b(a,c){var d;if(void 0!==a){d={};for(var e in a)a.hasOwnProperty(e)&&"children"!==e&&"parent"!==e&&"id"!==e&&"type"!==e&&("matrix"===e?(d[e]=new Q(a[e]),d.inverse=d.matrix.inverse()):d[e]=a[e]);e=h;0!==a.id&&f.push(new G(a.type,d,c,-1));g[a.id]=h;h+=1;if(void 0!==a.children)for(d=0;d<a.children.length;d++)b(a.children[d],e)}}var c,d,e;a=window.JSON.parse(window.JSON.stringify(a));var f=[],g={},h=0,l={},k=!1;for(c=0;c<a.length;c++)if(e=a[c],"document"===e.type)delete e.type,
f.push(new bf(e));else{"PageNode"===e.type&&(k=!0);if("parent"in e){if(!(e.parent in l))throw"Error: child "+e.id+" references parent "+e.parent+" before it was defined.";d=l[e.parent];void 0!==d.children?d.children.push(e):d.children=[e]}"GroupNode"!==e.type&&"PageNode"!==e.type||void 0!==e.children||(e.children=[]);l[e.id]=e}k||(h+=1);b(l[0],h);Ug(JSON.stringify(g));for(c=0;c<f.length;c++)Ug(f[c].toString());a=new cf(k);a.ya(f);pf(a);return a};function Zg(a,b,c){var d=this;this.va=a;this.ha=b;this.ha.empty();"absolute"!==this.ha.da("position")&&"fixed"!==this.ha.da("position")&&this.ha.da("position","relative");this.ha.da("overlow","none");this.ha.da("text-align","left");this.Ja=new ug(p("<div>").da("width","300px"));this.log("Starting Zwibbler Version %s",14);this.ha.append(this.Ja.ha);this.ea=new ng(c);this.Ea=new db("en:arrowhead-size:Arrowhead size\nes:arrowhead-size:Flecha tama\u00f1o\n\nen:arrowhead-size-large:Large\nes:arrowhead-size-large:Grande\n\nen:arrowhead-size-medium:Medium\nes:arrowhead-size-medium:Medio\n\nen:arrowhead-size-none:None\nes:arrowhead-size-none:Nada\n\nen:arrowhead-size-small:Small\nes:arrowhead-size-small:Peque\u00f1o\n\nen:arrowhead-size-tiny:Tiny\nes:arrowhead-size-tiny:Diminuto\n\nen:arrowhead-style:Arrowhead style\nes:arrowhead-style:Flecha estilo\n\nen:arrowhead-style-simple:Simple\nes:arrowhead-style-simple:Llanura\n\nen:arrowhead-style-solid:Solid\nes:arrowhead-style-solid:Denso\n\nen:arrow-keys:Arrow Keys\nes:arrow-keys:Teclas de flecha\n\nen:arrow-tool:Arrow tool\nes:arrow-tool:Flecha\nfr:arrow-tool:Fl\u00e8che\nnl:arrow-tool:Pijl\n\nen:break-apart-group:Break apart group\nes:break-apart-group:Dividir el grupo\n\nen:bring-to-front:Bring to front\nes:bring-to-front:Traer al frente\n\nen:brush-tool:Brush tool\nes:brush-tool:Brocha\nfr:brush-tool:Brosse\nnl:brush-tool:Penseel\n\nen:circle-tool:Circle tool\nes:circle-tool:C\u00edrculo\nfr:circle-tool:Cercle\nnl:circle-tool:Cirkel\n\nen:click-to-place-another-point-or-double-click-to-end-the-line:Click to place another point, or double-click to end the line.\nes:click-to-place-another-point-or-double-click-to-end-the-line:Haga clic para colocar otro punto, o doble clic para finalizar la l\u00ednea\nfr:click-to-place-another-point-or-double-click-to-end-the-line:Cliquez pour placer un autre point, ou double-cliquez pour terminer la ligne.\nnl:click-to-place-another-point-or-double-click-to-end-the-line:Klik op een ander punt te plaatsen, of dubbelklik om de lijn te be\u00ebindigen.\n\nen:click-to-place-first-point-of-line:Click to place first point of line\nes:click-to-place-first-point-of-line:Haga clic para colocar el primer punto de la l\u00ednea\nfr:click-to-place-the-first-point-of-line:Cliquez pour placer le premier point de la ligne\nnl:click-to-place-the-first-point-of-line:Klik om het eerste punt van de lijn te plaatsen.\n\nen:click-to-set-the-end-of-the-line:Click to set the end of the line\nes:click-to-set-the-end-of-the-line:Haga clic para colocar el extremo de la l\u00ednea\nfr:click-to-set-the-end-of-the-line:Cliquez pour d\u00e9finir la fin de la ligne\nnl:click-to-set-the-end-of-the-line:Klik hier voor het einde van de lijn in te stellen.\n\nen:copy:Copy\nes:copy:Copiar\nfr:copy:Copie\nnl:copy:Kopi\u00ebren\n\nen:curve-tool:Curve tool\nes:curve-tool:Curva\nfr:curve-tool:Courbes\nnl:curve-tool:Kromme\n\nen:delete-selection:Delete selection\nes:delete-selection:Eliminar la selecci\u00f3n\n\nen:del-key:Del\nes:del-key:Del\n\nen:double-arrows:Double arrows\nes:double-arrows:flechas dobles\n\nen:draw-curves:Draw curves\nes:draw-curves:Dibuje las curvas\n\nen:draw-lines:Draw lines\nes:draw-lines:Dibujar l\u00edneas\n\nen:duplicate-selection:Duplicate selection\nes:duplicate-selection:Duplica la selecci\u00f3n\n\nen:fill-colour:Fill colour\nes:fill-colour:Color de relleno\n\nen:font:Font\nes:font:Font\n\nen:font-size:Font size\nes:font-size:Tama\u00f1o de letra\n\nen:group-selection:Group selection\nes:group-selection:Grupo la selecci\u00f3n\n\nen:image-tool:Image tool\nes:image-tool:Imagen\nfr:image-tool:Image\nnl:image-tool:Afbeelding\n\nen:image-url:Image URL\nes:image-url:URL de la imagen\n\nen:keyboard:Keyboard\nes:keyboard:Teclado\n\nen:line-style:Line style\nes:line-style:Estilo de l\u00ednea\n\nen:line-style-long-dashes:Long dashes\nes:line-style-long-dashes:Gui\u00f3n largo\n\nen:line-style-short-dashes:Short dashes\nes:line-style-short-dashes:Gui\u00f3n corto\n\nen:line-style-solid:Solid\nes:line-style-solid:Denso\n\nen:line-tool:Line tool\nes:line-tool:Raya\nfr:line-tool:Lignes\nnl:line-tool:Lijn\n\nen:move-selection-away:Move selection away\nes:move-selection-away:Mover la selecci\u00f3n de distancia\n\nen:move-selection-closer:Move selection closer\nes:move-selection-closer:Mover la selecci\u00f3n de distancia\n\nen:move-while-zoomed:Move while zoomed\nes:move-while-zoomed:Desplazarse por la pantalla\n\nen:none:None\nes:none:Nada\n\nen:no:No\nes:no:No\n\nen:outline-colour:Outline colour\nes:outline-colour:Color del contorno\n\nen:outline-thickness:Outline thickness\nes:outline-thickness:Grosor del contorno\n\nen:page-down-key:Page Down\nes:page-down-key:Page Down\n\nen:page-up-key:Page Up\nes:page-up-key:Page Up\n\nen:paste:Paste\nes:paste:Pegar\nfr:paste:Coller\nnl:paste:Plak\n\nen:pick-tool:Pick tool\nes:pick-tool:Seleccionar\nfr:pick-tool:S\u00e9lectionner\nnl:pick-tool:Uitkiezen\n\nen:rectangle-tool:Rectangle tool\nes:rectangle-tool:rect\u00e1ngulo\nfr:rectangle-tool:Rectangle\nnl:rectangle-tool:Rechthoek\n\nen:redo:Redo\nes:redo:Rehacer\nfr:redo:Refaire\nnl:redo:Opnieuw maken\n\nen:rounded-rectangle-tool:Rounded rectangle tool\nes:rounded-rectangle-tool:Rect\u00e1ngulo redondeado\n\nen:save:Save\nes:save:Guardar\n\nen:send-to-back:Send to back\nes:send-to-back:Enviar a la parte posterior\n\nen:shadow:Shadow\nes:shadow:Sombra\n\nen:shape-brush-tool:Shape brush tool\nes:shape-brush-tool:Brush que dibuja formas\n\nen:sloppiness-artist:Artist\nes:sloppiness-artist:Artista\n\nen:sloppiness-cartoonist:Cartoonist\nes:sloppiness-cartoonist:Caricaturista\n\nen:sloppiness-child:Child\nes:sloppiness-child:Ni\u00f1o\n\nen:sloppiness-draftsman:Draftsman\nes:sloppiness-draftsman:Dibujante\n\nen:sloppiness-drunk:Drunk\nes:sloppiness-drunk:Borracho\n\nen:sloppiness:Sloppiness\nes:sloppiness:La dejadez\n\nen:smoothness-sharper:Sharper\nes:smoothness-sharper:Muy afilado\n\nen:smoothness-sharpest:Sharpest\nes:smoothness-sharpest:M\u00e1s afilado\n\nen:smoothness-sharp:Sharp\nes:smoothness-sharp:Afilado\n\nen:smoothness-smoothest:Smoothest\nes:smoothness-smoothest:Muy liso\n\nen:smoothness:Smoothness\nes:smoothness:Lisura\n\nen:smoothness-smooth:Smooth\nes:smoothness-smooth:Liso\n\nen:text-colour:Text colour\nes:text-colour:Color del texto\n\nen:text:Text\nes:text:Texto\n\nen:text-tool:Text tool\nes:text-tool:Texto\nfr:text-tool:Texte\nnl:text-tool:Tekst\n\nen:thickness-brush:Brush\nes:thickness-brush:Brocha\n\nen:thickness-marker:Marker\nes:thickness-marker:Rotulador\n\nen:thickness-pencil:Pencil\nes:thickness-pencil:L\u00e1piz\n\nen:thickness-pen:Pen\nes:thickness-pen:Pluma\n\nen:undo:Undo\nes:undo:Deshacer\nfr:undo:D\u00e9faire\nnl:undo:Ongedaan maken\n\nen:yes:Yes\nes:yes:S\u00ed\n\nen:zoom-in:Zoom in\nes:zoom-in:Zoom\n\nen:zoom-out:Zoom out\nes:zoom-out:Disminuir el zoom\n");
gb(this.Ea,this.ea.get("language"));this.oa=null;this.ta=p("<div>");this.ta.da("position","absolute");this.ta.da("overflow","hidden");this.ha.append(this.ta);this.canvas=p(jc(this.ta[0]));this.canvas.da("outline","0");this.canvas.da("position","absolute");this.canvas.da("left","0");this.canvas.da("top","0");this.canvas.Va("tabindex","0");this.na=this.canvas[0].getContext("2d");this.ea.Hb()?this.la=new vc(this.ha,40,!0,!1):this.la=new vc(this.ha,20,!1,!1);this.mb=new M;this.view=new Gf(this.canvas,
new cf,this.la,this.mb,this.ea,this.Ea,this.va);$g(this);ah(this);bh(this);this.ia=new Ag(this.ea,this.Ea);this.ha.append(this.ia.ha);this.ea.fe()&&(this.view.Cb=this.ia);this.ia.view=this.view;this.ia.on("click",function(){d.focus("none")});Ha(function(){return ch(d)});this.Jc=jg();this.ub="debug"in this.Jc||this.ea.ra.showDebug;this.aa=new xg(this.ha);this.aa.ha.da("border-right","1px solid black");this.ba=new xg(this.ha);this.ba.ha.da("border-top","1px solid black");this.ba.on("click",function(a){return Uf(d.view,
a)});this.aa.on("click",function(a){return dh(d,a)});null!==this.ea.ra.backgroundImage&&(dh(this,this.ea.ra.backgroundImage),pf(this.view.ja));eh(this);this.ea.on("update",function(a,b){var c=!1;d.log("onConfigChange %s=%s",a,b);switch(a){case "debug":d.ub=b;c=!0;break;case "showPageSelector":c=!0;Gc(d.$,b);break;case "backgroundImage":dh(d,b);break;case "showToolbar":case "showColourPanel":c=!0;break;case "language":gb(d.Ea,b)}c&&ch(d,!0)});this.ec=this.fc=-1;this.$=new Cc(p("<div>"),!1,!this.ea.get("showPageSelectorControls"));
this.$.ha.da("position","absolute");this.$.ha.da("top","0");this.$.ha.da("bottom","0");this.$.ha.da("width","160px");this.$.ha.da("left","50px");this.$.ha.da("background",this.ea.get("outsidePageColour"));Gc(this.$,this.ea.get("showPageSelector"));this.ha.append(this.$.ha);this.Cb=p("<div>").da("position","absolute").da("top","0").da("right","0").da("box-shadow","3px 3px 3px #444").da("background","#ccc").da("color","black").da("border-bottom-left-radius","4px").da("font-family","arial,sans");this.ha.append(this.Cb);
ch(this);(a=rg(this.ea))?this.Za=new Cc(p(a),!0,!0):this.Za=null;this.ea.get("setFocus")&&this.focus("toolbar");this.ea.get("pageView")&&Lf(this.view,"page");this.eb=[];Fc(this.$,this.va);this.Za&&(Fc(this.Za,this.va),Gc(this.Za,!0));this.va.emit("document-changed");this.va.emit("set-page",this.view.ja.jb);if("localStorage"in window){var e=window.localStorage;this.ea.get("persistent")&&(a=e.getItem("zwibbler-document"))&&fh(this,Wg(a));this.Kc=hg(function(){d.ea.get("persistent")&&(d.log("Saving document"),
e.setItem("zwibbler-document",d.va.save()))});d.va.on("document-changed",function(){d.Kc()})}}
Zg.prototype={log:A("APP"),focus:function(a){this.log("Set focus to %s",a);if("toolbar"!==a&&"canvas"!==a&&"none"!==a)throw"Focus must be toolbar or canvas or none, not "+a;this.Ra=a;"toolbar"===this.Ra?(this.toolbar.focus(),a=this.view,a.Da.ab&&(a.Da.ab=!1,a.ma()),this.ea.get("setFocus")&&this.ha.focus()):"canvas"===this.Ra&&(this.toolbar.blur(),this.ea.get("setFocus")&&this.ha.focus())},kc:function(a,b){var c;c=this.view.ja.fb;a.push(new Te(b));return c},Sc:function(a,b){a.push(new Ue(b))}};
function gh(a,b,c){return hh(a,b,"PathNode",{commands:c,fillStyle:a.view.Xa,strokeStyle:a.view.bb,seed:Math.round(65535*Math.random()),lineWidth:a.view.ua.lineWidth,sloppiness:a.view.ua.sloppiness,angleArcs:a.ea.get("angleArcs")})}
function ih(a,b,c){var d,e;d=p("<canvas>");d.Va("width",""+c.width);d.Va("height",""+c.height);e=d[0].getContext("2d");"image/jpeg"===b&&(e.fillStyle="#ffffff",e.fillRect(0,0,c.width,c.height));e.translate(-c.x,-c.y);Pf(a.view,e,c.x,c.y,c.width,c.height);a.view.ja.ma(e);a.va.Ib&&a.va.Ib(e);return d[0].toDataURL(b)}
function ch(a,b){var c,d,e,f,g,h,l,k,n,q,r,t,v,w,z;k=p(window).width();c=p(window).height();if(b||k!==a.jd||c!==a.hd)a.jd=k,a.hd=c,w=a.ha.width()-0,k=a.ha.height()-0,0>=w||!b&&w===a.fc&&k===a.ec||(a.fc=w,a.ec=k,a.ea.ra.showBackgroundSelector?(c=100,a.aa.show(),g=a.aa,g.aa=c-24,g.$=0):(c=0,a.aa.Ka()),a.ea.ra.showImageSelector?(f=100,g=a.ba,g.aa=0,g.$=f-24,a.ba.show()):(f=0,a.ba.Ka()),a.ea.ra.showPageSelector?(a.$.ha.show(),z=a.$.ha.outerWidth()):(a.$.ha.Ka(),z=0),a.ea.Mf()?(a.la.show(),xc(a.la,w),
g=a.la.height()):(a.la.Ka(),g=0),a.log("Colour panel height is %s",g),a.ea.Nf()?(a.toolbar.show(!0),d=k-g,e=a.toolbar,0>=d||(h=(e.Pb+2)*Math.ceil(e.la/d)+1,e.ha.style.width=""+h+"px",e.ha.style.height=""+d+"px",e.log("Toolbar width/height = %s,%s totalHeight=%s",h,d,e.la)),v=a.toolbar.width()):(a.toolbar.show(!1),v=0),d=uf(a.view),a.toolbar.moveTo(c+z,0),h=k-g,l=q=t=0,a.ub&&(l=a.Ja.width()),(r=a.ea.fe()&&700<=w)&&(q=300),t+=q+l,n=w-2*d-c-t,e=k-2*d-g-f,a.aa.width(c),a.aa.height(k-2*d-g),a.aa.moveTo(0,
0),a.$.ha.da("top","0"),a.$.ha.da("left","0"),a.ba.width(n),a.ba.height(f),a.ba.moveTo(c,k-2*d-g-f),f=w-2*d-v-t-c-z,a.ta.da("left",""+(z+c+v)+"px"),a.ta.da("top","0"),a.ta.da("width",""+f+"px"),a.ta.da("height",""+e+"px"),a.canvas.Va("width",""+f),a.canvas.Va("height",""+e),a.la.moveTo(0,h),xc(a.la,w),a.la.ma(),a.Cb.da("top","0").da("right",""+(q+l)+"px"),a.ub?(a.Ja.show(),a.Ja.moveTo(w-l,0),a.Ja.height(k-2*d-g)):a.Ja.Ka(),r?(a.ia.show(),a.ia.moveTo(w-l-q,0),a.ia.width(q),a.ia.height(k-2*d-g)):a.Qc||
a.ia.Ka(),c=a.view,w=p(c.canvas),f=w.offset(),z=p(c.canvas.parentNode).offset(),k=w.width(),w=w.height(),g=f.left-z.left,f=f.top-z.top,z=uf(c),c.$.moveTo(g+k-20+z,f+z),yd(c.$,20,w-20),c.aa.moveTo(g+z,f+w-20+z),yd(c.aa,k-20,20),If(c),c.ma())}function dh(a,b){var c,d;c=[];null!==a.oa&&a.oa in a.view.ja.za&&c.push(new Se([a.oa]));d=a.view.ja.fb;c.push(new G("ImageNode",{url:b,locked:!0,layer:a.view.Ha}));c.push(new Xe([d],Ze));a.oa=d;a.view.ya(c);a.view.Wa();V(a.view)}
function jh(a){a.oa=null;a.view.ja.lb(!1,function(b){"ImageNode"===b.type()&&!0===b.sa("locked")&&(a.log("Found background image at nodeid %s",b.id),a.oa=b.id)})}function hh(a,b,c,d){var e;e=a.view.ja.fb;"layer"in d||(d.layer=a.view.Ha);b.push(new G(c,d));return e}function kh(a,b){a.focus("canvas");var c=a.view;c.Da.ab=!0;c.Da.Oa=!1;c.Da.sd=b;c.log("Showing keyboard cursor, caret=%s",b);c.ma()}function lh(a){a.focus("canvas");Zd(a.view)}
function bh(a){a.Ra="none";a.vb=new Rc;qg(a.ea,a.vb);a.vb.on("*",function(b,c){"toolbar"===a.Ra?a.toolbar.ob(b,c):"canvas"===a.Ra?a.view.ob(b,c):a.log("Ignore key action -- don't have focus.")});a.ha.Va("tabindex","0");Uc(a.vb,a.ha[0]);a.canvas.click(function(){pc()?a.Ra="canvas":a.focus("canvas")});p(a.toolbar.ha).click(function(){a.focus("toolbar")});a.la.on("colour",function(){a.focus("canvas")});a.mb.on("goto-toolbar",function(){a.focus("toolbar")});a.mb.on("goto-canvas",function(){a.focus("canvas")})}
function ah(a){function b(a){return 0===a.type.indexOf("key")}var c,d,e,f,g,h,l=a.Ea.bc();a.toolbar=new Nc(a.ea.Hb(),a.ea.get("toolbarButtonSize"));if(a.ea.get("showToolbar")){a.ea.get("showPickTool")&&Qc(a.toolbar,"pick",l("pick-tool"),X(a.ea,"wd-pick.png"),function(c){I(a.view);b(c)&&kh(a)});a.ea.get("showSquareTool")&&a.toolbar.sb(X(a.ea,"wd-box.png"),l("rectangle-tool"),function(c){Wf(a.view);b(c)&&lh(a)});a.ea.get("showRoundRectTool")&&a.toolbar.sb(X(a.ea,"wd-roundrect.png"),l("rounded-rectangle-tool"),
function(c){Wf(a.view,{roundRadius:a.ea.get("defaultRoundRectRadius")});b(c)&&lh(a)});a.ea.get("showCircleTool")&&a.toolbar.sb(X(a.ea,"wd-circle.png"),l("circle-tool"),function(c){Vf(a.view);b(c)&&lh(a)});a.ea.get("showShapeBrushTool")&&Qc(a.toolbar,"shapebrush",l("shape-brush-tool"),X(a.ea,"wd-shapebrush.png"),function(c){$f(a.view,{});b(c)&&kh(a)});a.ea.Lf()&&Qc(a.toolbar,"brush",l("brush-tool"),X(a.ea,"wd-brush.png"),function(c){ag(a.view,{});b(c)&&kh(a)});a.ea.get("showLineTool")&&Qc(a.toolbar,
"line",l("line-tool"),X(a.ea,"wd-line.png"),function(c){yf(a.view,{angleArcs:a.ea.get("angleArcs")},!1);b(c)&&kh(a)});a.ea.get("showCurveTool")&&Qc(a.toolbar,"curve",l("curve-tool"),X(a.ea,"wd-curve.png"),function(c){xf(a.view,{});b(c)&&kh(a)});a.ea.get("showArrowTool")&&Qc(a.toolbar,"arrow",l("arrow-tool"),X(a.ea,"wd-arrow.png"),function(c){Yf(a.view,{},!1);b(c)&&kh(a)});a.ea.get("showTextTool")&&Qc(a.toolbar,"text",l("text-tool"),X(a.ea,"wd-text.png"),function(c){var d=a.view,e,f;"interactive"===
d.ea.get("textMode")?Af(d):(e=d.ja.fb,f=d.Sa(new E(100,100)),f=new H(f.x,f.y),d.ya([new G("TextNode",{text:d.ea.ra.defaultText,fontSize:d.ua.fontSize,fontName:d.ua.fontName,bold:d.ua.bold,italic:d.ua.italic,textFillStyle:d.ua.textFillStyle,strokeStyle:d.ua.textStrokeStyle,lineWidth:d.ua.textLineWidth,layer:d.Ha}),new R([e],f,f.inverse())]));b(c)&&kh(a,!0)});c=function(b){a.toolbar.sb(d,b.name,function(c){a.log("Custom button %s clicked.",b.name);b.onclick.call(c.target,a.va)})};g=0;for(h=mh.length;g<
h;g++)e=mh[g],f=e.name,d=e.image,a.log("add custom button %s",f),c(e);Pc(a.toolbar,"pick");a.ea.ra.showImageTool&&a.toolbar.sb(X(a.ea,"wd-image.png"),l("image-tool"),function(){Uf(a.view,"logo.png")});a.ea.ra.showMoveToFrontBack&&(a.toolbar.sb(X(a.ea,"wd-moveup.png"),l("bring-to-front"),function(){a.view.tc()}),a.toolbar.sb(X(a.ea,"wd-movedown.png"),l("send-to-back"),function(){a.view.Lc()}));a.ea.get("showUndoRedo")&&(a.toolbar.sb(X(a.ea,"wd-undo.png"),l("undo"),function(){a.view.Ta()}),a.toolbar.sb(X(a.ea,
"wd-redo.png"),l("redo"),function(){a.view.Ob()}));a.ea.get("showCopyPaste")&&(a.toolbar.sb(X(a.ea,"wd-copy.png"),l("copy"),function(){a.view.Zb()}),a.toolbar.sb(X(a.ea,"wd-paste.png"),l("paste"),function(){a.view.Bc()}))}a.toolbar.on("click",function(){a.focus("toolbar")});a.toolbar.ha.style.position="absolute";a.toolbar.ha.style.left="0";a.toolbar.ha.style.right="0";a.ha.append(a.toolbar.ha);a.va.on("tool-changed",function(b){Pc(a.toolbar,b)})}
function fh(a,b){a.oa=null;Kf(a.view,b);$g(a);jh(a);a.va&&(a.va.emit("document-changed"),a.va.emit("set-page",b.jb));for(var c=0;c<a.eb.length;c++){var d=a.eb[c];a.log("Removing old DomElement of type %s",d.tagName);p(d).remove()}a.eb=[]}
function $g(a){a.ea.ra.sloppy||dg(a.view,"sloppiness",0);var b;b=(""+a.ea.ra.defaultSmoothness).toLowerCase();dg(a.view,"smoothness","sharpest"===b?0:"sharper"===b?.1:"sharp"===b?.2:"smoothest"===b?.5:.3);dg(a.view,"fillStyle",a.ea.ra.defaultFillStyle);dg(a.view,"strokeStyle",a.ea.ra.defaultStrokeStyle);dg(a.view,"fontName",a.ea.ra.defaultFont);dg(a.view,"fontSize",a.ea.ra.defaultFontSize);dg(a.view,"lineWidth",a.ea.ra.defaultLineWidth);dg(a.view,"textFillStyle",a.ea.ra.defaultTextFillStyle)}
function eh(a){var b,c,d,e,f;a.canvas[0].getContext("2d");e=a.ea.ra.fonts;f=[];c=0;for(d=e.length;c<d;c++)b=e[c],a.log("Preloading: %s",b),b=p("<div>").da("font-family",b).text("abcd"),b.da("color","transparent"),f.push(a.ha.append(b))};function Y(a,b){this.aa={};this.ia=!1;this.$=[];this.ba=0;this.app=new Zg(this,a,b);nh(this);this.Ib=null}
Y.prototype={log:A("CONTEXT"),Pe:function(){this.ia=!1;this.$=[]},ie:function(a){var b=this.app.Ea;eb(b,a,b.data)},Qe:function(){return this.xc(this.Jb())},Hd:function(){this.$=[];this.ba=0;this.ia=!0;this.log("beginTransaction()")},tc:function(){this.app.view.tc()},Xb:function(){return this.app.view.ja.Xb()},Yb:function(){return this.app.view.ja.Yb()},Wa:function(){this.app.view.Wa();V(this.app.view);this.app.view.ma()},Te:function(){pf(this.app.view.ja)},Ue:function(a,b){this.Mc(a,!b)},We:function(){this.app.view.ya(this.$,
!0);this.ia=!1;this.$=[];this.ba=0},td:function(){this.app.view.ya(this.$);this.ia=!1;this.$=[];this.ba=0},Zb:function(a){return this.app.view.Zb(a)},kc:function(a){if(0<a.length)return Z(this,this.app.kc(this.$,a))},je:function(a,b){this.log("createNode(%s)",a);var c={},d;for(d in b)if(b.hasOwnProperty(d)){var e=b[d];"matrix"===d?(e=new Q(e),c.matrix=e,c.inverse=e.inverse()):c[d]=e}return Z(this,hh(this.app,this.$,a,c))},ke:function(a){return Z(this,gh(this.app,this.$,a))},me:function(a,b){function c(a,
b){b.click(function(b){a.onclick.call(this,d,b)})}a=gc(a);ja(b)||this.error("createToolbar: second paramter must be array");var d=this,e;e="javascript:void(0)";for(var f=0;f<b.length;f++){var g=b[f],h=p("<a>").Va("href",e);h.da("background-repeat","no-repeat");h.da("background-position","center");h.da("display","inline-block");Ra(h,"zwibbler-button");g.onclick&&c(g,h);g.title&&h.Va("title",g.title);g.background?h.da("background",g.background):g.image&&h.da("background-image","url("+g.image+")");a.append(h)}},
Xe:function(a,b){"string"===typeof b&&(b=p("#"+b));if("PageSelector"===a){this.log("Creating page selector");var c=new Cc(b,!1,!1);Gc(c,!0);Fc(c,this);Ec(c)}else return this.Ab("Cannot create UI Elemment %s",a),!1;return!0},le:function(a){var b=this.app,c=this.$,d,e,f,g,h,l;if(6>a.length)b.log("newShape: Cannot create shape with fewer than three points."),a=void 0;else{d=new ve;f=h=0;for(l=a.length-1;h<=l;f=h+=2)g=b.view.Sa(new E(a[f],a[f+1])),0===f?(d.moveTo(g.x,g.y),e=g):d.lineTo(g.x,g.y);d.lineTo(e.x,
e.y);d.close();a=gh(b,c,d.Gb())}return Z(this,a)},vd:function(){var a=this.app.view.Zb(!1);this.Ld();return a},ne:function(a){this.Jd(a)},Jd:function(a){this.log("deleteNodes()");if(a.length){var b=this.$;ja(a)||(a=[a]);b.push(new Se(a));Z(this,void 0)}},Kd:function(){if(1===this.Jb())this.log("Cannot remove all the pages.");else{var a=this.app.view.ja;this.$.push(new Se([a.$[a.jb].id]));Z(this)}},Ld:function(){vf(this.app.view)},$b:function(){if(1===arguments.length&&!1===arguments[0]){var a=this.app.view.ja;
a.eb=a.la.next}return this.app.view.ja.$b()},oe:function(a,b,c){"jpeg"===a&&(a="jpg");var d,e;if("pdf"===a||"svg"===a||"png"===a||"jpg"===a){("pdf"===a||"svg"===a)&&"Blob"in window?e=this.app.view.ja.save(a,"blob"):"png"===a||"jpg"===a?(d=this.save(a,c),"Blob"in window&&(e=tc(d))):d=this.app.view.ja.save(a,"data-uri");if(e){if(window.navigator.msSaveOrOpenBlob){this.log("Using msSaveOrOpenBlob()");window.navigator.msSaveOrOpenBlob(e,b);return}d=window.URL.createObjectURL(e)}var f=document.createElement("a");
f.innerHTML="download";f.setAttribute("href",d);f.setAttribute("download",b);f.style.display="none";document.body.appendChild(f);f.click();setTimeout(function(){document.body.removeChild(f)},100)}else this.log("unsupported format for download: %s",a)},ma:function(a,b){b=b||{};var c=b.page||0,d=this.app.view.ja.jb,e=kf(this.app.view.ja);this.app.view.ja.ib(c);Pf(this.app.view,a,0,0,e.width,e.height);this.app.view.ja.ma(a);this.app.view.ja.ib(d)},duplicate:function(){this.app.view.duplicate()},emit:function(a,
b){var c,d=this;this.aa||(this.aa={});c=Array.prototype.slice.call(arguments,1);setTimeout(function(){var b,f,g,h;if(a in d.aa)for(h=d.aa[a],f=0,g=h.length;f<g;f++)b=h[f],b.apply(null,c)},0);return this},uc:function(a,b){var c;this.aa||(this.aa={});c=Array.prototype.slice.call(arguments,1);var d,e,f,g;if(a in this.aa)for(g=this.aa[a],e=0,f=g.length;e<f;e++)d=g[e],d.apply(null,c)},focus:function(){this.app.ha.focus()},Ye:function(a){a=this.Nd(a);return a.length?a[0]:null},Nd:function(a){var b=this.app.view.ja,
c=[],d;for(d in b.za)if(b.za.hasOwnProperty(d)){var e=b.za[d];e.sa("tag")===a&&c.push(e)}a=[];for(b=0;b<c.length;b++)a.push(c[b].id);return a},Ze:function(a,b,c){var d=null;if(3===arguments.length){if(!x(b)||!x(c)){this.Ab("flip: 2nd and 3rd args must be numbers.");return}d=new E(b,c)}var e=this.app.view,f=a/180*Math.PI;0===e.selection.length&&null===e.Ca||e.log("flipSelection: selection is empty");Sf(e,Hd(e),f,d)},pe:function(a,b,c,d){var e=oh(this,a),f=null;if(4===arguments.length){if(!x(c)||!x(d)){this.Ab("flip: 3rd and 4th args must be numbers.");
return}f=new E(c,d)}Sf(this.app.view,e,b/180*Math.PI,f)},$e:function(a,b,c){function d(a){a.on("click contextmenu",function(b){n.call(g,a.da("background-color"),1===b.which);b.preventDefault()})}function e(){var c=p("<div>").da("width",b+"px").da("height",b+"px").da("display","inline-block");a.append(c);return c}function f(a,b){var c=document.createElement("canvas");c.width=a;c.height=a;b(c.getContext("2d"),0,0,a);return e().append(c)}var g=this;a=gc(a);c=c||{};var h,l,k,n=c.onColour||c.onColor||
g.Mc;h=f(b,Ac);h.on("click contextmenu",function(a){n.call(g,"transparent",1===a.which);a.preventDefault()});h=f(b,Bc);h.on("click contextmenu",function(a){if(c.onOpacity)c.onOpacity(.5,1===a.which);else g.ce(.5,1===a.which);a.preventDefault()});for(l=0;1>=l;l+=1/13)k=(new O(2,[0,0,l,1])).toString(),d(e().da("background-color",k));for(l=.3;1>=l;l+=.7/14)for(h=0;360>h;h+=22.5)k=(new O(2,[h,.7,l,1])).toString(),d(e().da("background-color",k));for(h=0;360>h;h+=22.5)k=(new O(2,[h,1,1,1])).toString(),
d(e().da("background-color",k))},pd:function(){var a=this.app.view;a.log("getActiveLayer() -> %s",a.Ha);return a.Ha},af:function(){var a=[];gf(this.app.view.ja,function(b){a.push(b.id)});return a},qe:function(){var a=this.app;return null!==a.oa&&a.oa in a.view.ja.za?T(a.view.ja,a.oa).sa("url"):null},re:function(a){var b=this.app.view;ja(a)||(a=[a]);for(var c=null,d=0;d<a.length;d++){var e=T(b.ja,a[d]);e&&(null===c?c=e.hb().clone():cd(c,e.hb()))}null===c&&(c=new P(0,0,0,0));return ph(c)},cc:function(){return this.app.view.ja.jb},
se:function(){var a=this.app.view,b=null;a.pa.Kb&&(b=a.pa.Kb());return b},cf:function(a,b){var c=C(this.app.view,a,b);return{x:c.x,y:c.y}},vc:function(){var a=kf(this.app.view.ja);return{x:a.x,y:a.y,width:a.width,height:a.height}},ff:function(a){return this.app.Ea.get(a)},error:function(a){alert(a)},df:function(){return ph(this.app.view.ja.hb())},ef:function(a,b){return this.Dd(a,b)},hf:function(){var a=[],b={},c;this.app.view.ja.lb(!1,function(d){!(c=ke(d))||c in b||(b[c]=1,a.push(c))});c=this.pd();
c in b||a.push(c);return a},gf:function(a){var b=[];this.app.view.ja.lb(!1,function(c){ke(c)===a&&b.push(c.id)});return b},Dd:function(a,b){var c=this.app,d,e;(d=T(c.view.ja,a))&&(e=d.sa(b));c.log("GetItemProperty %s: %s=%s",a,b,e);return e},jf:function(a){var b=T(this.app.view.ja,a);null===b&&this.Ab("Error: node %s does not exist",a);a=b.hb();return{x:a.x,y:a.y,width:a.width,height:a.height}},te:function(a){return(a=T(this.app.view.ja,a))?a.type():""},kf:function(a,b){var c=this.app.view.ja.cb(a,
b,this.app.view.Ha);return c?c.id:null},Jb:function(){return this.app.view.ja.Jb()},$c:function(a){a=T(this.app.view.ja,a);if("PathNode"!==a.type())return null;a=rd(a.$c().clone());for(var b=[],c=0;c<a.length;c++){var d=a[c];b.push(d.x);b.push(d.y)}return b},lf:function(a){a=T(this.app.view.ja,a);if("PathNode"!==a.type())return null;a=a.$c();for(var b=[],c=[],d=0;d<a.ga.length;){switch(a.ga[d]){case Ab:c=[{x:a.ga[d+1],y:a.ga[d+2]}];b.push(c);break;case Bb:c.push({x:a.ga[d+1],y:a.ga[d+2]})}d+=Eb[a.ga[d]]}return b},
Ne:function(){this.app.view.Cb=this.app.ia;this.app.Qc=!0;return this.app.ia.ha[0]},bf:function(){return this.app.view.scale},mf:function(a,b,c,d){var e;e=Yd(this.app.view,a,b);if(void 0===c)return{x:e.x,y:e.y};a=Yd(this.app.view,a+c,b+d);return ph(new P(e.x,e.y,a.x-e.x,a.y-e.y))},ue:function(a){return Mf(this.app.view,a)},pf:function(){return ph(Of(this.app.view))},Ab:function(a,b){for(var c=arguments[0].split("%s"),d=[],e=0;e<c.length;e++)d.push(c[e]),e<c.length-1&&d.push(JSON.stringify(arguments[e+
1]));this.log(d.join(""));throw{message:d,toString:function(){return d}};},xc:function(a){var b=this.app.view.ja.fb;this.$.push(new G("PageNode",{},this.app.view.ja.root.id,a));Z(this,b);return a},zd:function(a){return this.app.view.ja.zd(a)},ve:function(a,b){1===arguments.length&&(b=arguments[0],a="zwibbler3");var c;"list"===a?(fh(this.app,Yg(b)),c=void 0):c=fh(this.app,Wg(b));return c},we:function(a){var b=this;x(a)||this.error("lockUpdates: Expected a number");this.la&&clearTimeout(this.la);this.la=
setTimeout(function(){Rf(b.app.view,!1)},a);Rf(b.app.view,!0)},cd:function(){this.app.view.cd()},dd:function(){this.app.view.dd()},xe:function(){var a=this.app;fh(a,new cf);null!==a.ea.ra.backgroundImage&&(dh(a,a.ea.ra.backgroundImage),pf(a.view.ja));nh(this)},ye:function(){this.hc(Math.min(this.cc()+1,this.Jb()-1))},on:function(a,b){"draw"===a?this.Ib=b:a in this.aa?this.aa[a].push(b):this.aa[a]=[b];return this},wf:function(a){"function"===typeof a||this.Ab("Error: onComplete needs a function argument.");
var b=this.app.view;b.request.$?(b.log("Formatting in progress; will call function soon"),Jb(b.request,a)):(b.log("Format already done; call function in 1 tick"),setTimeout(a,0))},Bc:function(a){this.app.view.Bc(a)},yf:function(){this.hc(Math.max(this.cc()-1,0))},ze:function(a,b){var c=[],d;if(x(a))c.push(a);else if(ja(a))for(d=0;d<a.length;d++)x(a[d])?c.push(a[d]):this.error("print(): pageSpec must be array of numbers");else if(!a)for(d=0;d<this.Jb();d++)c.push(d);b=b?qh(b):qh(this.vc());var e=this.cc(),
f=document.createElement("canvas");f.width=b.width;f.height=b.height;var g=f.getContext("2d");g.translate(-b.x,-b.y);var h=window.open("about:blank","_blank");h.document.write("<!DOCTYPE html><html><body>");for(d=0;d<c.length;d++)this.hc(c[d]),Pf(this.app.view,g,b.x,b.y,b.width,b.height),this.app.view.ja.ma(g),0<d?h.document.write("<div style='page-break-before:always'>"):h.document.write("<div>"),h.document.write("<img style='width:100%' src='"),h.document.write(f.toDataURL()),h.document.write("'></div>"),
g.clearRect(b.x,b.y,b.width,b.height);h.document.write("</body></html>");h.document.close();h.focus();h.print();h.close();this.hc(e)},Ob:function(){this.app.view.Ob()},Ae:function(a){this.app.view.ma(a)},Be:function(){var a=this;setTimeout(function(){ch(a.app,!0)},1)},save:function(a,b){a=a||"zwibbler3";var c={jpeg:"image/jpeg",jpg:"image/jpeg",png:"image/png"};b=qh(b||this.vc());switch(a){case "list":return this.app.view.ja.save("list","object");case "png":case "jpeg":case "jpg":return ih(this.app,
c[a],b);case "zwibbler3":return this.app.view.ja.save("zwibbler3","string");case "svg":case "pdf":return this.app.view.ja.save(a,"string");case "image/png":case "image/jpeg":for(var d=ih(this.app,a,b),d=d.substr(d.indexOf(",")+1),c=["base64"],e=0;e<c.length;e++)d=ga[c[e]](d);return d;default:return"Unsupported format: "+a}},Cf:function(a){p(this.app.view.canvas).da("cursor",a)},selectNodes:function(a){a=oh(this,a);this.app.view.selectNodes(a);V(this.app.view);this.app.view.ma()},Lc:function(){this.app.view.Lc()},
Ed:function(a){var b=this.app.view;b.log("setActiveLayer(%s)",a);b.Ha=a;b.Wa();V(b);b.ma()},Af:function(a,b){var c=this.app,d,e,f,g;yg(c.aa);b&&(d=c.aa,d.aa=b,d.$=b);g=[];e=0;for(f=a.length;e<f;e++)d=a[e],"string"===typeof d?g.push(zg(c.aa,d,d)):g.push(zg(c.aa,d.small,d.large,d.tooltip))},Bf:function(a,b){return og(this.app.ea,a,b)},Mc:function(a,b){this.app.view.wb(a,b)},hc:function(a){this.app.view.ib(a)},De:function(a){var b=this.app.view;a?(b.log("Setting a custom background function."),b.ia=
a):b.log("Clearing custom background function.")},qd:function(a,b){!x(a)&&null!==a||!x(b)&&null!==b?alert("setDocumentSize: width/height must be numbers"):Xf(this.app.view,a,b)},ae:function(a,b){!x(a)&&null!==a||!x(b)&&null!==b?alert("setDocumentSize: width/height must be numbers"):Z(this,Xf(this.app.view,a,b,this.$))},Df:function(a,b){var c=T(this.app.view.ja,a);c||this.Ab("setDomElement: Node %s does not exist",a);"DomNode"!==c.type()&&this.Ab("setDomElement: Node %s is not a DomNode. It is %s",
a,c.type());c.be(b);this.app.eb.push(b)},Gf:function(a,b){ka(a)&&ka(b)?(this.pd()===a&&this.Ed(b),this.app.view.ja.lb(!1,function(c){ke(c)===a&&c.setProperty("layer",b)})):this.Ab("setLayerName() needs string arguments.")},de:function(a){var b=null,c=null,d,e=!0,f=!1;if(2===arguments.length)x(arguments[0])&&x(arguments[1])?(d=arguments[0],b=arguments[1]):ka(arguments[0])&&"boolean"===typeof arguments[1]?(c=arguments[0],f=arguments[1]):e=!1;else if(1===arguments.length&&ka(arguments[0]))for(var g=
arguments[0].split(" "),h=0;h<g.length;h++)"landscape"===g[h]?f=!0:"portrait"===g[h]?f=!1:c=g[h];if(!1===e)return this.log("Bad arguments to setPaperSize()."),!1;if(null===c)return this.qd(d,b),!0;switch(c){case "letter":d=816;b=1056;break;case "legal":d=816;b=1344;break;case "11x17":d=1056;b=1632;break;case "tabloid":d=1056;b=1632;break;case "a0":d=841/25.4*96;b=1189/25.4*96;break;case "a1":d=594/25.4*96;b=841/25.4*96;break;case "a2":d=420/25.4*96;b=594/25.4*96;break;case "a3":d=297/25.4*96;b=420/
25.4*96;break;case "a4":d=210/25.4*96;b=297/25.4*96;break;case "none":b=d=null;break;default:return this.log("Invalid paper size: %s",c),!1}f&&(c=d,d=b,b=c);this.qd(d,b);return!0},Ef:function(a,b){var c=this.app,d,e,f,g;yg(c.ba);g=[];b&&(d=c.ba,d.aa=b,d.$=b);e=0;for(f=a.length;e<f;e++)d=a[e],"string"===typeof d?g.push(zg(c.ba,d,d)):g.push(zg(c.ba,d.small,d.large,d.tooltip))},Ff:function(a,b,c){this.Fd(a,b,c)},Ee:function(a,b){if(2!==arguments.length)throw"Error: setNodeProperties takes 2 arguments.";
var c;c=this.app;var d=this.$,e=a,f;c.log("External app setNodeProperty %s: %s",e,b);ja(e)||(e=[e]);for(f in b)b.hasOwnProperty(f)&&d.push(new Xd(e,f,b[f]));c=0<d.length?c.view.ya(d):void 0;return Z(this,c)},Fd:function(a,b,c){var d=this.$;this.app.log("External app setItemProperty %s: %s=%s",a,b,c);var e;ja(a)?e=a:e=[a];d.push(new Xd(e,b,c));return Z(this,void 0)},Hf:function(a,b){ja(a)||(a=[a]);for(var c=0;c<a.length;c++){var d=T(this.app.view.ja,a[c]);d&&d.Nc(!b)}this.app.view.ma()},ce:function(a,
b){var c=this.app.view;c.pa.Nb?(c.log("Simulating opacity change %s",a),c.pa.Nb(a,b)):c.log("An opacity is not needed for this tool.")},Fe:function(a){var b=this.app.view;b.Ea=a;a=zf(b);b.Ga=-a.x;b.Fa=-a.y;J(b);b.ma()},Jf:function(a){"object"===typeof a&&x(a.x)&&x(a.y)&&x(a.width)&&x(a.height)||this.Ab("setViewRect: arg must be an object with numeric x, y, width, height properties");0!==a.width&&0!==a.height||this.Ab("setViewRect: width and height must be non-zero.");var b=this.app.view;a=qh(a);b.log("setViewRect(%s)",
a);var c=Math.min(b.canvas.width/a.width,b.canvas.height/a.height),d=a.y*c;b.Ga=-(a.x*c);b.Fa=-d;b.scale=c;b.oa="none";J(b);b.ma()},Kf:function(a){x(a)||"page"===a||"width"===a?Lf(this.app.view,a):this.log("setZoom: invalid parameter.")},Oc:function(a,b){this.app.view.Oc(a,b)},Gd:function(a,b,c){this.log("Translate node %s by %s,%s actions=%s",a,b,c,this.$.length);var d=this.$;ja(a)||(a=[a]);b=new H(b,c);d.push(new R(a,b,b.inverse()));return Z(this,!0)},zf:function(a){var b=Math.round(a/(Math.PI/
2));a=b*Math.PI/2;var b=0===b%2,c=rh(this),d=this.vc(),e=d.width/2,f=d.height/2;this.Hd();for(var g=0;g<c.length;g++)this.$d(c[g],a,e,f),b||this.Gd(c[g],f-e,e-f);b||this.ae(d.height,d.width);this.td()},$d:function(a,b,c,d){this.log("Rotate node %s by %s around (%s,%s) actions=%s",a,b/Math.PI*180,c,d,this.$.length);var e=T(this.app.view.ja,a);null===e&&this.Ab("rotateNode: Node %s doesn't exist",a);4>arguments.length&&(e=ad(e.hb()),c=e.x,d=e.y);e=new gd(b,c,d);this.$.push(new R([a],e,e.inverse()));
return Z(this,!0)},Ce:function(a,b,c,d,e){this.log("Scale node %s by %s,%s actions=%s",a,b,c,this.$.length);b=new fd(b,c,d||0,e||0);this.$.push(new R([a],b,b.inverse()));return Z(this,!0)},Ta:function(){this.app.view.Ta()},Sc:function(a){return Z(this,this.app.Sc(this.$,a))},Ge:function(a,b){function c(){}function d(){}var e=new fg(this.app.Cb,b||"Working"),f=new XMLHttpRequest,g=new FormData(a);f.upload.addEventListener("progress",function(a){e.update(a.loaded/a.total)},!1);f.addEventListener("load",
function(){200===f.status?(e.done(),d(f.response,f)):(e.error("Error"),c(f,f))},!1);f.addEventListener("error",function(){e.error("Error");c(f,f)},!1);f.addEventListener("abort",function(){e.error("Aborted");c(f)},!1);f.open(a.method,a.action);f.send(g);var h={success:function(a){d=a;return h},error:function(a){c=a;return h}};return h},Qf:function(a,b){Yf(this.app.view,a,b)},Rf:function(a,b){2===arguments.length?ag(this.app.view,{lineWidth:b,strokeStyle:a}):ag(this.app.view,arguments[0]||{})},Sf:function(a){Vf(this.app.view,
a)},Tf:function(a){xf(this.app.view,a)},Uf:function(a){"object"===typeof a||this.error("useCustomTool(): requires an object as argument.");F(this.app.view,new eg(this.app.view,a))},He:function(a){var b=this.app.view,c=T(b.ja,a);c?c.ad()?(I(b),b.Wa(),V(b),b.Ca=c,b.ma()):b.log("useEditHandleTool: nodetype %s has no edit mode",c.type()):b.log("useEditHandleTool: node %s doesn't exist.",a)},Ie:function(){Vf(this.app.view)},Vf:function(a,b,c){"object"===typeof a?c=b:a={strokeStyle:a,lineWidth:b};Zf(this.app.view,
a,c||"freehand")},dg:function(a){var b=this.app.view;F(b,new kb(b,a))},Wf:function(a,b){yf(this.app.view,a,b)},Xf:function(){var a=this.app.view;F(a,new lb(a))},Yf:function(){I(this.app.view)},Je:function(a,b){var c=this.app.view,d=b,e;e=new ve;for(var f=0;f<=a;f++){var g=50*Math.sin(d),h=50*-Math.cos(d);0===f?e.moveTo(g,h):e.lineTo(g,h);d+=2*Math.PI/a}e.close();d={commands:e.Gb(),fillStyle:c.Xa,strokeStyle:c.bb,seed:Math.round(65535*Math.random()),lineWidth:c.ua.lineWidth,sloppiness:c.ua.sloppiness,
layer:c.Ha,wrap:c.ea.get("multilineText"),fontSize:c.ea.get("defaultFontSize")};c.log("Create an item on layer %s",c.Ha);F(c,new Md(c,"PathNode",d,100,100,"circle"))},Zf:function(a){Zf(this.app.view,a||{},"quadratic")},Ke:function(a){Wf(this.app.view,a)},$f:function(a){Wf(this.app.view,p.$({},{roundRadius:this.app.ea.get("defaultRoundRectRadius")},a||{}))},ag:function(a,b){$f(this.app.view,{strokeStyle:a,lineWidth:b})},Le:function(a,b,c,d,e){var f=this.app.view;F(f,new Md(f,a,b,c,d,e))},cg:function(a){var b=
this.app.view;b.ea.get("readOnly")?b.log("readOnly mode: Ignoring tool click."):F(b,new Ne(b,"stampline",a))},bg:function(a){Wf(this.app.view,a)},eg:function(){Af(this.app.view)},Uc:function(){this.app.view.Uc()},Vc:function(){this.app.view.Vc()}};function oh(a,b){var c=[];x(b)&&(b=[b]);for(var d=0;d<b.length;d++){var e=T(a.app.view.ja,b[d]);e&&c.push(e)}return c}function nh(a){var b=a.app.ea.get("defaultPaperSize");a.log("onNewDocument()");"none"!==b&&a.de(b)}
function qh(a){return new P(a.x||0,a.y||0,a.width||0,a.height||0)}function ph(a){return{x:a.x,y:a.y,width:a.width,height:a.height}}function rh(a){var b=[];a.app.view.ja.lb(!1,function(a){b.push(a.id)});return b}function Z(a,b){if(!a.ia)return a.log("Not in a transaction. committing immediately. id=%s",b),a.td(),b;if("number"===typeof b)return a.ba+=1,a.log("id=%s numCreated=%s realid=%s",b,a.ba,b+a.ba-1),b+a.ba-1};"jQuery"in window&&(window.jQuery.fn.zwibbler=function(a){a=a||{};var b=null;this.each(function(c,d){d.zwibbler&&p(d).empty();b=new Y(p(d),a);d.zwibbler=b});return b},window.jQuery.fn.zwibblerContext=function(){return this[0].zwibbler});var mh=[],ye={};
window.Zwibbler={create:function(a,b){"string"===typeof a&&0<a.length&&"."!==a.charAt(0)&&"#"!==a.charAt(0)&&(a="#"+a);var c=gc(a);return null===c?(alert("Zwibbler.create: Cannot find an element with id "+a),null):new Y(p(c),b)},addButton:function(a){for(var b=["name","image","onclick"],c=0;c<b.length;c++)if(!(b[c]in a))return alert("Zwibbler.addButton: missing "+b[c]),!1;mh.push(a);return!0},addCustomNode:function(a,b){ye[a]=b},Dialog:function(a,b){var c=gc(a);null===c[0].parentNode&&p(document.body).append(c);
"static"===c.da("position")&&c.da("position","absolute");c.da("display","none");b=b||{};var d=qc(c[0]),e=new aa("transparent");c.da("z-index",""+d);e.$=d;e.insertBefore=c;var f=b.showNear,g=b.showHow,h={hide:function(){e.Ka();c.Ka();if(h.onhide)h.onhide()},show:function(a,b){var d,q;2===arguments.length&&x(a)&&x(b)?(d=a,q=b):(a=a||f,b=b||g);c.show();var r=c.outerWidth(),t=c.outerHeight();if(void 0!==d){var v=uc();d={left:d,top:q};d.left=Math.min(d.left,v.x+v.width-r-2);d.top=Math.min(d.top,v.y+v.height-
t-3);c.offset(d)}else a&&b?(t=gc(a),v=b,r=t.offset(),v=v.toLowerCase().split(" "),2!==v.length&&(v=["tl","tl"]),0<=v[0].indexOf("b")&&(r.top+=t.outerHeight()),0<=v[0].indexOf("r")&&(r.left+=t.outerWidth()),0<=v[1].indexOf("b")&&(r.top-=c.outerHeight()),0<=v[1].indexOf("r")&&(r.left-=c.outerWidth()),c.da("position","absolute"),t=uc(),v=c.width(),d=c.height(),r.left=Math.min(r.left,t.x+t.width-v),r.top=Math.min(r.top,t.y+t.height-d),c.offset(r)):(c.da("left","50%"),c.da("top","50%"),c.da("margin-left",
""+-r/2+"px"),c.da("margin-top",""+-t/2+"px"));e.show(h.hide);if(h.onshow)h.onshow()},onshow:b.onshow,onhide:b.onhide};return h},ColourWheel:function(a,b){a=p(a)[0];var c=new Hc(a,b),d=new M;c.Ja=function(a){d.emit("change",a)};return{on:function(a,b){d.on(a,b)},colour:function(){if(arguments.length)Jc(c,arguments[0]);else return c.aa.toString()}}},SlidingPanel:function(a,b){b=b||{};var c=b.autohide,d;d="string"===typeof a?p("#"+a):p(a);var e=new Kb(d);if(b.onshow)e.on("show",b.onshow);if(b.onhide)e.on("hide",
b.onhide);return{show:function(a){e.show(a,c)},hide:function(){e.Ka()}}},createPreview:function(a,b){return window.Zwibbler.render(a,b)},render:function(a,b){function c(){var a=q.hb(),b=1,c=0,r=0;f&&(a.y=f);l&&(a.height=l-a.y);g&&(a.x=g);h&&(a.width=h-a.x);d&&e?b=Math.min(d/a.width,e/a.height):d?(b=d/a.width,e=a.height*b):e?(b=e/a.height,d=a.width*b):(d=a.width,e=a.height);a.width*b<d&&(c=d/2-a.width*b/2);a.height*b<e&&(r=e/2-a.height*b/2);c-=a.x*b;r-=a.y*b;k.width=Math.ceil(d);k.height=Math.ceil(e);
n.translate(c,r);n.scale(b,b);q.ma(n)}b=b||{};var d=b.width||0,e=b.height||0,f=b.top||0,g=b.left||0,h=b.right||0,l=b.bottom||0,k=jc(null),n=k.getContext("2d"),q=Wg(a),r=new Pb;q.format(n,r);r.on("reformat",function(a){Od(q,a.id)});if(r.$)r.on("done",function(){q.format(n,r);c()});else c();return k},parseColour:function(a){a=cc(a);return{r:a.values[0],g:a.values[1],b:a.values[2],a:a.values[3]}},makeColour:function(a){return(new O(0,[a.r,a.g,a.b,a.a])).toString()},getAbsoluteUrl:function(a){var b=document.createElement("a");
b.href=a;return b.href},base64Encode:function(a){return ha(a)},fonts:new ac,addFont:function(a,b){window.Zwibbler.fonts.add(a,b)}};ze.prototype.setElement=ze.prototype.be;Y.prototype.log=Y.prototype.log;Y.prototype.abortTransaction=Y.prototype.Pe;Y.prototype.addToLanguage=Y.prototype.ie;Y.prototype.addPage=Y.prototype.Qe;Y.prototype.beginTransaction=Y.prototype.Hd;Y.prototype.bringToFront=Y.prototype.tc;Y.prototype.canRedo=Y.prototype.Xb;Y.prototype.canUndo=Y.prototype.Yb;Y.prototype.clearSelection=Y.prototype.Wa;Y.prototype.clearUndo=Y.prototype.Te;Y.prototype.clickColour=Y.prototype.Ue;
Y.prototype.commitIrreversibleTransaction=Y.prototype.We;Y.prototype.commitTransaction=Y.prototype.td;Y.prototype.copy=Y.prototype.Zb;Y.prototype.createGroup=Y.prototype.kc;Y.prototype.createNode=Y.prototype.je;Y.prototype.createPath=Y.prototype.ke;Y.prototype.createToolbar=Y.prototype.me;Y.prototype.createUiElement=Y.prototype.Xe;Y.prototype.createShape=Y.prototype.le;Y.prototype.cut=Y.prototype.vd;Y.prototype.deleteNode=Y.prototype.ne;Y.prototype.deleteNodes=Y.prototype.Jd;
Y.prototype.deletePage=Y.prototype.Kd;Y.prototype.deleteSelection=Y.prototype.Ld;Y.prototype.dirty=Y.prototype.$b;Y.prototype.download=Y.prototype.oe;Y.prototype.draw=Y.prototype.ma;Y.prototype.duplicate=Y.prototype.duplicate;Y.prototype.focus=Y.prototype.focus;Y.prototype.findNode=Y.prototype.Ye;Y.prototype.findNodes=Y.prototype.Nd;Y.prototype.flip=Y.prototype.Ze;Y.prototype.flipNodes=Y.prototype.pe;Y.prototype.generatePalette=Y.prototype.$e;Y.prototype.getActiveLayer=Y.prototype.pd;
Y.prototype.getAllNodes=Y.prototype.af;Y.prototype.getBackgroundImage=Y.prototype.qe;Y.prototype.getBoundingRectangle=Y.prototype.re;Y.prototype.getCurrentPage=Y.prototype.cc;Y.prototype.getCurrentTool=Y.prototype.se;Y.prototype.getDocumentCoordinates=Y.prototype.cf;Y.prototype.getDocumentSize=Y.prototype.vc;Y.prototype.getLanguageString=Y.prototype.ff;Y.prototype.getDrawingRectangle=Y.prototype.df;Y.prototype.getItemProperty=Y.prototype.ef;Y.prototype.getLayers=Y.prototype.hf;
Y.prototype.getLayerNodes=Y.prototype.gf;Y.prototype.getNodeProperty=Y.prototype.Dd;Y.prototype.getNodeRectangle=Y.prototype.jf;Y.prototype.getNodeType=Y.prototype.te;Y.prototype.getNodeUnderPoint=Y.prototype.kf;Y.prototype.getPageCount=Y.prototype.Jb;Y.prototype.getPathData=Y.prototype.$c;Y.prototype.getPathAsPoints=Y.prototype.lf;Y.prototype._getPropertyPanelElement=Y.prototype.Ne;Y.prototype.getCanvasScale=Y.prototype.bf;Y.prototype.getScreenCoordinates=Y.prototype.mf;
Y.prototype.getSelectedNodes=Y.prototype.ue;Y.prototype.getViewRectangle=Y.prototype.pf;Y.prototype.insertPage=Y.prototype.xc;Y.prototype.isLayerVisible=Y.prototype.zd;Y.prototype.load=Y.prototype.ve;Y.prototype.lockUpdates=Y.prototype.we;Y.prototype.moveDown=Y.prototype.cd;Y.prototype.moveUp=Y.prototype.dd;Y.prototype.newDocument=Y.prototype.xe;Y.prototype.nextPage=Y.prototype.ye;Y.prototype.on=Y.prototype.on;Y.prototype.onComplete=Y.prototype.wf;Y.prototype.paste=Y.prototype.Bc;
Y.prototype.previousPage=Y.prototype.yf;Y.prototype.print=Y.prototype.ze;Y.prototype.redo=Y.prototype.Ob;Y.prototype.redraw=Y.prototype.Ae;Y.prototype.resize=Y.prototype.Be;Y.prototype.save=Y.prototype.save;Y.prototype.setCursor=Y.prototype.Cf;Y.prototype.selectNodes=Y.prototype.selectNodes;Y.prototype.sendToBack=Y.prototype.Lc;Y.prototype.setActiveLayer=Y.prototype.Ed;Y.prototype.setBackgroundBrowserImages=Y.prototype.Af;Y.prototype.setConfig=Y.prototype.Bf;Y.prototype.setColour=Y.prototype.Mc;
Y.prototype.setCurrentPage=Y.prototype.hc;Y.prototype.setCustomBackgroundFn=Y.prototype.De;Y.prototype.setDocumentSize=Y.prototype.qd;Y.prototype.setDocumentSizeInTransaction=Y.prototype.ae;Y.prototype.setDomElement=Y.prototype.Df;Y.prototype.setLayerName=Y.prototype.Gf;Y.prototype.setPaperSize=Y.prototype.de;Y.prototype.setIconBrowserImages=Y.prototype.Ef;Y.prototype.setItemProperty=Y.prototype.Ff;Y.prototype.setNodeProperties=Y.prototype.Ee;Y.prototype.setNodeProperty=Y.prototype.Fd;
Y.prototype.setNodeVisibility=Y.prototype.Hf;Y.prototype.setOpacity=Y.prototype.ce;Y.prototype.setPageView=Y.prototype.Fe;Y.prototype.setViewRectangle=Y.prototype.Jf;Y.prototype.setZoom=Y.prototype.Kf;Y.prototype.showLayer=Y.prototype.Oc;Y.prototype.translateNode=Y.prototype.Gd;Y.prototype.rotateDocument=Y.prototype.zf;Y.prototype.rotateNode=Y.prototype.$d;Y.prototype.scaleNode=Y.prototype.Ce;Y.prototype.undo=Y.prototype.Ta;Y.prototype.ungroup=Y.prototype.Sc;Y.prototype.upload=Y.prototype.Ge;
Y.prototype.useArrowTool=Y.prototype.Qf;Y.prototype.useBrushTool=Y.prototype.Rf;Y.prototype.useCircleTool=Y.prototype.Sf;Y.prototype.useCurveTool=Y.prototype.Tf;Y.prototype.useCustomTool=Y.prototype.Uf;Y.prototype.useEditHandleTool=Y.prototype.He;Y.prototype.useEllipseTool=Y.prototype.Ie;Y.prototype.useFreehandTool=Y.prototype.Vf;Y.prototype.useStampTool=Y.prototype.dg;Y.prototype.useLineTool=Y.prototype.Wf;Y.prototype.usePanTool=Y.prototype.Xf;Y.prototype.usePickTool=Y.prototype.Yf;
Y.prototype.usePolygonTool=Y.prototype.Je;Y.prototype.useQuadraticBezierTool=Y.prototype.Zf;Y.prototype.useRectangleTool=Y.prototype.Ke;Y.prototype.useRoundRectTool=Y.prototype.$f;Y.prototype.useShapeBrushTool=Y.prototype.ag;Y.prototype.useShapeTool=Y.prototype.Le;Y.prototype.useStampLineTool=Y.prototype.cg;Y.prototype.useSquareTool=Y.prototype.bg;Y.prototype.useTextTool=Y.prototype.eg;Y.prototype.zoomIn=Y.prototype.Uc;Y.prototype.zoomOut=Y.prototype.Vc;Zg.prototype.createGroup=Zg.prototype.kc;

})();
